<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>モニタリング共有ビュー</title>
<style>
:root {
  --fg:#1f2a44; --bg:#eef3fb; --card:#ffffff; --accent:#2b6cb0; --muted:#5a6a85;
  --border:#d6e2f5; --highlight:#ffe082; --alert:#d32f2f; --warning:#f59e0b;
}
* { box-sizing:border-box; }
body { margin:0; font-family:"Noto Sans JP",system-ui,sans-serif; background:var(--bg); color:var(--fg); }
.share-app { max-width:840px; margin:0 auto; padding:28px 18px 48px; }
.share-header { background:var(--card); border-radius:20px; padding:22px; box-shadow:0 12px 30px rgba(24,72,140,0.12); }
.report-card { margin-top:20px; background:var(--card); border-radius:18px; padding:24px; box-shadow:0 12px 28px rgba(24,72,140,0.1); display:flex; flex-direction:column; gap:18px; }
.report-card-header { display:flex; flex-wrap:wrap; justify-content:space-between; gap:18px; align-items:flex-start; }
.report-card-info { flex:1 1 280px; }
.report-title { margin:0; font-size:1.45rem; color:var(--fg); }
.report-subtitle { margin:8px 0 4px; font-size:0.95rem; color:var(--muted); }
.report-meta { margin:0; font-size:0.85rem; color:#48608c; }
.report-status { font-size:0.85rem; color:#2f4b7a; background:#eef4ff; border-radius:10px; padding:8px 12px; display:inline-block; }
.qr-block { flex:0 0 220px; display:flex; flex-direction:column; align-items:center; gap:10px; background:#f6f9ff; border:1px dashed rgba(43,108,176,0.35); border-radius:16px; padding:16px; }
.qr-image { width:200px; height:200px; object-fit:contain; display:none; }
.qr-placeholder { width:200px; height:200px; display:flex; align-items:center; justify-content:center; text-align:center; font-size:0.9rem; color:#4a5a75; background:rgba(43,108,176,0.08); border-radius:12px; padding:12px; }
.qr-caption { margin:0; font-size:0.78rem; color:#4a5a75; text-align:center; }
.report-body { font-size:0.98rem; line-height:1.8; color:#1f2a44; background:#f8fbff; border-radius:14px; padding:18px 20px; min-height:160px; }
.report-body p { margin:0 0 1em; white-space:pre-wrap; }
.report-body p:last-child { margin-bottom:0; }
.report-placeholder { font-style:italic; color:var(--muted); }
.report-empty-line { min-height:1em; }
.share-heading { display:flex; flex-direction:column; gap:10px; }
.share-title { margin:0; font-size:1.6rem; color:var(--accent); }
.share-badges { display:flex; flex-wrap:wrap; gap:8px; }
.badge { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:999px; font-size:0.78rem; background:#e3f2fd; color:#134b93; font-weight:600; }
.badge.subtle { background:#edf2f9; color:#4a5a75; }
.badge.audience { background:#dbeafe; color:#1d4ed8; }
.share-member { font-size:1.05rem; font-weight:600; }
.share-profile { margin-top:14px; display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:10px; }
.profile-item { background:#f3f7ff; border:1px solid rgba(43,108,176,0.18); border-radius:12px; padding:10px 12px; display:flex; flex-direction:column; gap:4px; }
.profile-label { font-size:0.72rem; color:#4c5d7c; letter-spacing:0.06em; text-transform:uppercase; }
.profile-value { font-size:0.95rem; color:#1f2a44; font-weight:600; word-break:break-word; }
.share-meta { margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; font-size:0.82rem; color:var(--muted); }
.share-meta .meta-item { display:inline-flex; align-items:center; gap:4px; }
.share-actions { margin-top:16px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
.print-controls { display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end; }
.print-controls label { display:flex; flex-direction:column; gap:6px; font-size:0.82rem; color:#35507a; }
.print-select { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#f8fbff; color:#1f2a44; font-size:0.9rem; min-width:200px; }
.print-button { padding:10px 18px; border-radius:999px; border:none; background:var(--accent); color:#fff; font-size:0.92rem; cursor:pointer; box-shadow:0 8px 18px rgba(43,108,176,0.24); }
.print-button:disabled { background:#a8c2e8; cursor:not-allowed; box-shadow:none; }
.print-button:not(:disabled):hover { opacity:0.92; }
.share-intro { margin-top:18px; background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.25); border-radius:16px; padding:16px 18px; line-height:1.6; font-size:0.93rem; color:#2c4674; }
.share-alert { margin-top:18px; padding:14px; border-radius:14px; font-size:0.9rem; display:none; }
.share-alert.error { display:block; background:#fde8e8; border:1px solid #f5b5b5; color:#b91c1c; }
.share-alert.warning { display:block; background:#fff8e1; border:1px solid #f6d481; color:#9a6404; }
.share-auth { margin-top:18px; background:var(--card); border-radius:16px; padding:18px; border:1px solid var(--border); box-shadow:0 8px 22px rgba(24,72,140,0.08); }
.share-auth label { display:flex; flex-direction:column; gap:6px; font-size:0.9rem; color:#284066; }
.share-auth input[type="password"] { padding:10px 12px; border-radius:10px; border:1px solid var(--border); font-size:1rem; }
.share-auth button { margin-top:12px; align-self:flex-start; padding:8px 14px; border-radius:999px; background:var(--accent); color:#fff; border:none; font-size:0.92rem; cursor:pointer; box-shadow:0 4px 12px rgba(43,108,176,0.25); }
.share-auth button:hover { opacity:0.92; }
.share-muted { font-size:0.8rem; color:var(--muted); margin-top:8px; }
.share-filters { margin-top:24px; background:var(--card); border-radius:18px; padding:20px; border:1px solid var(--border); box-shadow:0 10px 24px rgba(24,72,140,0.08); display:flex; flex-direction:column; gap:12px; }
.filter-row { display:flex; flex-wrap:wrap; gap:16px; }
.filter { display:flex; flex-direction:column; gap:6px; font-size:0.82rem; color:#35507a; min-width:160px; }
.filter input[type="text"], .filter input[type="date"], .filter select { padding:8px 10px; border-radius:10px; border:1px solid var(--border); font-size:0.88rem; background:#f8fbff; color:#1f2a44; }
.quick-range { display:flex; flex-direction:column; gap:8px; }
.range-chips { display:flex; gap:8px; flex-wrap:wrap; }
.range-chip { padding:6px 12px; border-radius:999px; border:1px solid #c7d8f2; background:#f4f8ff; color:#1f3a6d; font-size:0.78rem; cursor:pointer; }
.range-chip.active { background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 4px 10px rgba(43,108,176,0.25); }
.share-status { margin-top:12px; font-size:0.82rem; color:var(--muted); min-height:20px; }
.share-records { margin-top:18px; display:flex; flex-direction:column; gap:14px; }
.share-record { background:var(--card); border-radius:16px; padding:18px; border:1px solid rgba(43,108,176,0.12); box-shadow:0 8px 20px rgba(24,72,140,0.08); }
.share-record.latest { border-color:#7aa7ff; box-shadow:0 14px 28px rgba(24,72,140,0.18); position:relative; }
.share-record.latest::before { content:"最新"; position:absolute; top:14px; right:16px; background:var(--accent); color:#fff; font-size:0.7rem; padding:2px 8px; border-radius:999px; letter-spacing:0.04em; }
.record-meta { font-size:0.85rem; color:#3a5684; display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
.record-submeta { font-size:0.85rem; color:#3a5684; margin-top:6px; line-height:1.6; }
.record-submeta strong { font-weight:600; }
.record-text { font-size:0.95rem; line-height:1.7; color:#1f2a44; white-space:pre-wrap; word-break:break-word; }
.keyword-hit { background:var(--highlight); padding:0 4px; border-radius:4px; font-weight:600; }
.keyword-hit.health { background:#ffe4e6; color:#b91c1c; }
.keyword-hit.alert { background:#fde68a; color:#92400e; }
.keyword-hit.new { background:#e0f2f1; color:#047857; }
.record-attachments { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; }
.record-attachments a { padding:6px 12px; border-radius:12px; background:#eef4ff; color:#1a56a3; font-size:0.82rem; text-decoration:none; }
.record-attachments a:hover { background:#d9e6ff; }
.empty-state { margin-top:28px; text-align:center; color:var(--muted); font-size:0.9rem; }
.load-more { margin:12px auto 0; display:none; padding:10px 22px; border-radius:999px; border:none; background:var(--accent); color:#fff; font-size:0.9rem; cursor:pointer; box-shadow:0 8px 18px rgba(43,108,176,0.26); }
.load-more:hover { opacity:0.92; }
.share-footer { margin-top:40px; font-size:0.8rem; color:var(--muted); text-align:center; line-height:1.6; }
.share-footer ul { margin:10px auto 0; padding-left:20px; text-align:left; max-width:560px; }
.share-footer li { margin-bottom:6px; }
.keyword-legend { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; font-size:0.78rem; color:#4a5a75; }
.keyword-legend span { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:8px; background:#f1f5ff; }
@media (max-width:640px){
  .share-app { padding:18px 14px 36px; }
  .share-header { padding:18px; }
  .report-card { padding:18px; }
  .report-card-header { flex-direction:column; align-items:stretch; }
  .qr-block { width:100%; }
  .filter-row { flex-direction:column; }
  .filter { width:100%; }
  .quick-range { flex-direction:column; }
  .share-profile { grid-template-columns:1fr; }
}
@media print{
  body { background:#fff; color:#000; }
  .share-app { max-width:100%; padding:0 12mm; }
  .share-header { box-shadow:none; border:1px solid #cbd5f5; }
  .report-card { box-shadow:none; border:1px solid #cbd5f5; page-break-inside:avoid; }
  .qr-block { border:1px solid #cbd5f5; background:#fff; }
  .report-body { background:#fff; }
  .print-button { display:none !important; }
  .share-actions, .share-filters, .share-footer { display:none !important; }
}
</style>
</head>
<body>
<div class="share-app" id="shareApp">
  <header class="share-header">
    <div class="share-heading">
      <h1 class="share-title">モニタリング共有ビュー</h1>
      <div class="share-badges">
        <span class="badge">閲覧専用</span>
        <span class="badge subtle">個人情報は必要最小限のみ表示</span>
        <span class="badge audience" id="shareAudienceBadge">共有先を確認中…</span>
      </div>
    </div>
    <div class="share-member" id="shareMember">閲覧対象を確認しています…</div>
    <div class="share-profile" id="shareProfile" style="display:none;">
      <div class="profile-item">
        <span class="profile-label">ほのぼのID</span>
        <span class="profile-value" id="shareMemberId">確認中…</span>
      </div>
      <div class="profile-item">
        <span class="profile-label">地域包括支援センター</span>
        <span class="profile-value" id="shareMemberCenter">確認中…</span>
      </div>
      <div class="profile-item">
        <span class="profile-label">ご担当者</span>
        <span class="profile-value" id="shareMemberStaff">確認中…</span>
      </div>
    </div>
    <div class="share-meta">
      <span class="meta-item" id="shareRange">表示範囲を確認しています…</span>
      <span class="meta-item" id="shareExpiry"></span>
      <span class="meta-item" id="shareRemaining"></span>
      <span class="meta-item" id="shareMask"></span>
      <span class="meta-item" id="shareAttachmentPolicy"></span>
    </div>
    <div class="share-actions" id="printControls" style="display:none;">
      <div class="print-controls">
        <label>印刷対象
          <select id="printScope" class="print-select">
            <option value="record">この記録のみ</option>
            <option value="center">地域包括支援センター全件</option>
            <option value="staff">担当者全件</option>
          </select>
        </label>
      </div>
      <button type="button" class="print-button" id="printButton" disabled>印刷</button>
    </div>
  </header>
  <section class="report-card" id="reportCard" style="display:none;">
    <div class="report-card-header">
      <div class="report-card-info">
        <h2 class="report-title">月次モニタリング報告書</h2>
        <p class="report-subtitle" id="reportSubtitle">対象月を確認しています…</p>
        <p class="report-meta" id="reportGeneratedAt"></p>
        <div id="reportStatus" class="report-status" style="display:none;"></div>
      </div>
      <div class="qr-block" id="qrBlock">
        <img id="qrImage" class="qr-image" alt="共有QRコード">
        <div id="qrPlaceholder" class="qr-placeholder">QRコードを準備しています…</div>
        <p class="qr-caption">印刷してご活用ください。</p>
      </div>
    </div>
    <div class="report-body" id="reportContent">読み込み中です…</div>
  </section>
  <section id="shareIntro" class="share-intro">
    共有いただいたモニタリング記録を安全に閲覧できるページです。最新の様子を時系列で確認できます。
  </section>
  <div id="shareAlert" class="share-alert"></div>
  <section id="shareAuth" class="share-auth" style="display:none;">
    <form id="authForm">
      <label>閲覧パスワード
        <input type="password" id="authPassword" autocomplete="one-time-code" placeholder="パスワードを入力してください">
      </label>
      <button type="submit">記録を表示</button>
      <div id="authStatus" class="share-muted"></div>
    </form>
  </section>
  <section id="shareFilters" class="share-filters" style="display:none;">
    <div class="filter-row">
      <label class="filter" style="flex:1; min-width:220px;">
        キーワード検索
        <input type="text" id="filterSearch" placeholder="本文・添付名で検索">
      </label>
      <label class="filter">
        種別
        <select id="filterKind">
          <option value="all">すべて</option>
        </select>
      </label>
      <label class="filter">
        表示順
        <select id="filterSort">
          <option value="desc" selected>日付が新しい順</option>
          <option value="asc">日付が古い順</option>
          <option value="kind">区分順</option>
        </select>
      </label>
    </div>
    <div class="filter-row">
      <label class="filter">
        表示期間（開始）
        <input type="date" id="filterFrom">
      </label>
      <label class="filter">
        表示期間（終了）
        <input type="date" id="filterTo">
      </label>
      <div class="filter quick-range" style="flex:1;">
        <span>クイック選択</span>
        <div class="range-chips" id="rangeChips">
          <button type="button" class="range-chip" data-range="7">直近7日</button>
          <button type="button" class="range-chip" data-range="30">直近30日</button>
          <button type="button" class="range-chip" data-range="90">直近90日</button>
          <button type="button" class="range-chip" data-range="all">全期間</button>
        </div>
      </div>
    </div>
    <div class="keyword-legend">
      <span><span class="keyword-hit health">体調変化</span> などの重要ワードを自動で色付けします</span>
      <span><span class="keyword-hit new">新規追加</span> などの新着キーワードも強調表示します</span>
    </div>
  </section>
  <div id="shareStatus" class="share-status"></div>
  <div id="recordsContainer" class="share-records"></div>
  <div id="emptyState" class="empty-state" style="display:none;">共有可能な記録はまだありません。</div>
  <button id="loadMore" class="load-more">さらに表示</button>
  <footer class="share-footer" id="shareFooter">
    閲覧方法や期限についてご不明な点がありましたら、担当のケアマネジャーまでご連絡ください。
  </footer>
</div>
<script>
const TEMPLATE_TOKEN_RAW = <?= typeof shareToken === 'string' ? JSON.stringify(shareToken) : '""' ?>;
const TEMPLATE_RECORD_ID_RAW = <?= typeof shareRecordId === 'string' ? JSON.stringify(shareRecordId) : '""' ?>;
const queryParams = new URLSearchParams(window.location.search);

function toTrimmedString(value){
  if(value === null || value === undefined) return '';
  return String(value).trim();
}

function isNullishPseudoString(value){
  const lowered = toTrimmedString(value).toLowerCase();
  return !lowered || lowered === 'null' || lowered === 'undefined';
}

function sanitizeShareValue(value){
  let str = toTrimmedString(value);
  if(isNullishPseudoString(str)) return '';
  for(let i = 0; i < 3 && str.length >= 2; i += 1){
    const first = str[0];
    const last = str[str.length - 1];
    if((first === '"' && last === '"') || (first === "'" && last === "'")){
      str = str.slice(1, -1).trim();
      if(isNullishPseudoString(str)) return '';
    }else{
      break;
    }
  }
  return str;
}

function getTokenFromUrl(){
  const sp = new URLSearchParams(window.location.search);
  const raw = sp.get('shareId') || sp.get('share') || sp.get('token') || '';
  return sanitizeShareValue(raw);
}

const TEMPLATE_TOKEN = sanitizeShareValue(TEMPLATE_TOKEN_RAW);
const TEMPLATE_RECORD_ID = sanitizeShareValue(TEMPLATE_RECORD_ID_RAW);
const externalToken = sanitizeShareValue(TEMPLATE_TOKEN) || getTokenFromUrl();
const RECORD_ID_PARAM = TEMPLATE_RECORD_ID || sanitizeShareValue(queryParams.get('recordId') || queryParams.get('record') || '');
console.log("🐛 TEMPLATE_TOKEN_RAW =", TEMPLATE_TOKEN_RAW);
console.log("🐛 TEMPLATE_TOKEN (sanitized) =", TEMPLATE_TOKEN);
console.log("🐛 URL query shareId =", queryParams.get('shareId'));
console.log("🐛 URL token (sanitized) =", getTokenFromUrl());
console.log("🐛 externalToken =", externalToken);
const shareAudienceInfo = {
  family: {
    label: '家族向け共有',
    description: '日々の様子をわかりやすくまとめています。',
    intro: '大切なご家族の近況を共有する専用ページです。安心してご覧ください。',
    manualTips: [
      'QRコードからアクセスし、最新の記録を順番に確認できます。',
      '気になる点がありましたら担当ケアマネジャーへご連絡ください。'
    ]
  },
  center: {
    label: '地域包括支援センター向け共有',
    description: '日付・区分付きで状況を把握できます。',
    intro: '地域包括支援センターさまとの情報連携ページです。必要事項のみ抜粋しています。',
    manualTips: [
      '検索や期間フィルターで必要な記録を絞り込めます。',
      '支援が必要な事項は担当ケアマネジャーまでお知らせください。'
    ]
  },
  caremanager: {
    label: 'ケアマネジャー向け共有',
    description: '月次報告と記録をまとめています。',
    intro: 'ケアマネジャーさま専用の共有ページです。月次モニタリング報告書と最新記録をご確認ください。',
    manualTips: [
      '月次モニタリング報告書で全体の状況を確認できます。',
      '必要に応じて印刷し、関係者との情報共有にご活用ください。'
    ]
  },
  medical: {
    label: '医療連携向け共有',
    description: '体調変化を把握しやすい構成です。',
    intro: '医療機関のみなさまとの共有ページです。経過の確認にお役立てください。',
    manualTips: [
      '強調表示されたワードから急ぎの情報を確認できます。',
      '必要に応じて診察・訪問時の資料としてご活用ください。'
    ]
  },
  service: {
    label: 'サービス事業者向け共有',
    description: '現場スタッフが把握しやすいように整理しています。',
    intro: 'サービス提供事業者さま向けの共有ページです。日々のケアにご活用ください。',
    manualTips: [
      '本文検索や種別フィルターで必要な記録を抽出できます。',
      '気づきや連絡事項は担当ケアマネジャーまで共有をお願いします。'
    ]
  }
};
const shareAudienceDefault = 'family';
const KEYWORD_RULES = [
  { pattern: '体調変化|発熱|発作|血圧|脈拍|食欲不振|倦怠感|転倒|怪我|受診', className: 'health' },
  { pattern: '緊急|至急|要連絡|報告必須|注意', className: 'alert' },
  { pattern: '新規追加|開始|導入|初回|更新', className: 'new' }
];
const DISPLAY_LIMIT_DEFAULT = 30;
const DISPLAY_STEP = 30;
const rangeButtons = [];
let currentShare = null;
let recordsCache = [];
let filteredRecords = [];
let displayLimit = DISPLAY_LIMIT_DEFAULT;
let latestTimestamp = null;
let searchTimer = null;
let resolvedRecordId = RECORD_ID_PARAM;
let primaryRecordData = null;
let singleRecordMode = !!resolvedRecordId;
let currentReport = null;

function getAudienceInfo(audience){
  const key = String(audience || '').toLowerCase();
  return shareAudienceInfo[key] || shareAudienceInfo[shareAudienceDefault];
}

function escapeHtml(value){
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
  return String(value ?? '').replace(/[&<>"']/g, ch => map[ch]);
}

function callGoogle(functionName, ...args){
  return new Promise((resolve, reject) => {
    try {
      const runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(err => reject(err));
      runner[functionName](...args);
    } catch (e) {
      reject(e);
    }
  });
}

const EXEC_BASE_URL = window.location.href.split('#')[0].split('?')[0];

function pickFirstArray(...candidates){
  for(const candidate of candidates){
    if(Array.isArray(candidate)) return candidate;
  }
  return [];
}

function resolveSharePayload(res){
  if(!res || typeof res !== 'object'){ return { share:null, records:[], report:null, primaryRecord:null, message:'', status:'' }; }
  const meta = res.meta && typeof res.meta === 'object' ? res.meta : null;
  const share = res.share || (meta && meta.share) || null;
  const report = res.report || (meta && meta.report) || null;
  const records = pickFirstArray(res.records, res.rawRecords, meta && meta.records, meta && meta.rawRecords);
  const primaryRecord = res.primaryRecord || (meta && meta.primaryRecord) || (records.length ? records[0] : null);
  const message = typeof res.message === 'string' && res.message
    ? res.message
    : (meta && typeof meta.message === 'string' ? meta.message : '');
  const status = typeof res.status === 'string' && res.status
    ? res.status
    : (meta && typeof meta.status === 'string' ? meta.status : '');
  return { share, records, report, primaryRecord, message, status };
}

async function callShareApi(action, options = {}) {
  const token = sanitizeShareValue(options.token || externalToken);
  if (!token) throw new Error('共有リンクが見つかりません。');
  const requestedRecordId = options.recordId !== undefined ? options.recordId : resolvedRecordId;
  const recordIdValue = sanitizeShareValue(requestedRecordId);
  const canUseGoogleRun = typeof google !== 'undefined' && google.script && google.script.run;

  // まず google.script.run が使える場合（GAS クライアント経由）を優先
  if (canUseGoogleRun) {
    if (action === 'meta') {
      return callGoogle('getExternalShareMeta', token, recordIdValue || '');
    }
    if (action === 'enter') {
      const passwordValue = typeof options.password === 'string' ? options.password : '';
      const sanitizedPassword = isNullishPseudoString(passwordValue) ? '' : passwordValue;
      return callGoogle('enterExternalShare', token, sanitizedPassword, recordIdValue || '');
    }
  }

  // API 呼び出し用に shareApi パラメータを必ず付与する（HTML表示と区別）
  if (action === 'meta') {
    const params = new URLSearchParams({ api: 'shareMeta', shareId: token });
    if (recordIdValue) params.set('recordId', recordIdValue);

    const res = await fetch(`${EXEC_BASE_URL}?${params.toString()}`);
    if (!res.ok) throw new Error('共有設定の取得に失敗しました。');

    try {
      return await res.json();
    } catch (err) {
      throw new Error('共有設定の解析に失敗しました。');
    }
  }

  if (action === 'enter') {
    // POST で JSON を要求（shareApi=enter を付与）
    const passwordValue = typeof options.password === 'string' ? options.password : '';
    const sanitizedPassword = isNullishPseudoString(passwordValue) ? '' : passwordValue;
    const body = new URLSearchParams({ shareApi: 'enter', shareId: token, password: sanitizedPassword });
    if (recordIdValue) body.append('recordId', recordIdValue);
    const res = await fetch(EXEC_BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: body.toString(),
      credentials: 'include'
    });
    if (!res.ok) throw new Error('閲覧に失敗しました。');
    try {
      return await res.json();
    } catch (err) {
      throw new Error('閲覧レスポンスの解析に失敗しました。');
    }
  }

  throw new Error('未知の共有APIアクションです');
}


function setLoading(message){
  const statusEl = document.getElementById('shareStatus');
  const recordsEl = document.getElementById('recordsContainer');
  const emptyEl = document.getElementById('emptyState');
  if(statusEl) statusEl.textContent = message ? String(message) : '';
  if(recordsEl) recordsEl.innerHTML = '';
  if(emptyEl) emptyEl.style.display = 'none';
  const loadMore = document.getElementById('loadMore');
  if(loadMore) loadMore.style.display = 'none';
  updatePrintControls(null);
}

function showEmptyState(message){
  const emptyEl = document.getElementById('emptyState');
  if(!emptyEl) return;
  emptyEl.textContent = message || '共有可能な記録はまだありません。';
  emptyEl.style.display = 'block';
}

function showAlert(type, message){
  const alertEl = document.getElementById('shareAlert');
  if(!alertEl) return;
  alertEl.className = 'share-alert' + (type ? ' ' + type : '');
  alertEl.style.display = message ? 'block' : 'none';
  alertEl.textContent = message || '';
}

function updateHeader(share){
  const info = getAudienceInfo(share && share.audience);
  const audienceBadge = document.getElementById('shareAudienceBadge');
  if(audienceBadge) audienceBadge.textContent = info.label;
  const memberEl = document.getElementById('shareMember');
  if(memberEl){
    memberEl.textContent = share && share.memberName ? `${share.memberName} 様のモニタリング` : '対象を確認しています…';
  }
  const profileEl = document.getElementById('shareProfile');
  const memberIdEl = document.getElementById('shareMemberId');
  const memberCenterEl = document.getElementById('shareMemberCenter');
  const memberStaffEl = document.getElementById('shareMemberStaff');
  const memberId = share && share.memberId ? String(share.memberId).trim() : '';
  const memberCenter = share && share.memberCenter ? String(share.memberCenter).trim() : '';
  const memberStaff = share && share.memberStaff ? String(share.memberStaff).trim() : '';
  if(memberIdEl) memberIdEl.textContent = memberId || '未登録';
  if(memberCenterEl) memberCenterEl.textContent = memberCenter || '未設定';
  if(memberStaffEl) memberStaffEl.textContent = memberStaff || '未設定';
  if(profileEl){
    profileEl.style.display = 'grid';
  }
  const rangeEl = document.getElementById('shareRange');
  if(rangeEl){
    const label = share && share.rangeLabel ? share.rangeLabel : '最新記録';
    rangeEl.textContent = `表示範囲：${label}`;
  }
  const expiryEl = document.getElementById('shareExpiry');
  if(expiryEl){
    expiryEl.textContent = share && share.expiresAtText ? `閲覧期限：${share.expiresAtText}` : '閲覧期限：設定なし';
  }
  const remainingEl = document.getElementById('shareRemaining');
  if(remainingEl){
    remainingEl.textContent = share && share.remainingLabel ? share.remainingLabel : '';
  }
  const maskEl = document.getElementById('shareMask');
  if(maskEl){
    maskEl.textContent = share && share.maskMode === 'none' ? '本文：マスクなし' : '本文：個人情報を自動マスク';
  }
  const attachmentEl = document.getElementById('shareAttachmentPolicy');
  if(attachmentEl){
    const allowAll = share && share.allowAllAttachments;
    const count = share && typeof share.allowedCount === 'number' ? share.allowedCount : 0;
    attachmentEl.textContent = allowAll ? '添付：すべて閲覧可能' : `添付：${count}件のみ共有`;
  }
}

function updateQrSection(share){
  const qrImage = document.getElementById('qrImage');
  const placeholder = document.getElementById('qrPlaceholder');
  if(!qrImage || !placeholder) return;
  const candidates = [
    share && share.qrEmbedUrl,
    share && share.qrDataUrl,
    share && share.qrDriveUrl,
    share && share.qrUrl,
    share && share.qrCode
  ];
  const src = candidates.find(value => typeof value === 'string' && value.trim().length) || '';
  if(src){
    qrImage.src = src;
    qrImage.style.display = 'block';
    placeholder.style.display = 'none';
  }else{
    qrImage.removeAttribute('src');
    qrImage.style.display = 'none';
    placeholder.style.display = 'flex';
    placeholder.textContent = 'QRコードが登録されていません。';
  }
}

function shouldShowReportSection(report, share){
  if(!report) return false;
  const audience = String(share && share.audience || '').toLowerCase();
  if(audience !== 'caremanager') return false;
  const rangeType = String(share && (share.rangeType || share.rangeSpec || '') || '').toLowerCase();
  if(rangeType === 'month') return true;
  const rangeSpec = String(share && share.rangeSpec || '').toLowerCase();
  if(rangeSpec === 'month') return true;
  const rangeLabel = share && share.rangeLabel ? String(share.rangeLabel) : '';
  return rangeLabel.includes('月次');
}

function buildReportHtml(text){
  const value = String(text || '');
  if(!value.trim()){
    return '<p class="report-placeholder">レポート内容がありません。</p>';
  }
  const lines = value.replace(/\r/g,'').split('\n');
  return lines.map(line => {
    if(!line.trim()) return '<p class="report-empty-line">&nbsp;</p>';
    return `<p>${escapeHtml(line)}</p>`;
  }).join('');
}

function updateReportCard(report, share, options = {}){
  const card = document.getElementById('reportCard');
  const subtitle = document.getElementById('reportSubtitle');
  const generatedAtEl = document.getElementById('reportGeneratedAt');
  const statusEl = document.getElementById('reportStatus');
  const bodyEl = document.getElementById('reportContent');
  currentReport = report || null;

  if(!card || !subtitle || !generatedAtEl || !statusEl || !bodyEl){
    return;
  }

  if(options.showLoading){
    card.style.display = 'flex';
    subtitle.textContent = '対象月を確認しています…';
    generatedAtEl.textContent = '';
    statusEl.style.display = 'none';
    bodyEl.innerHTML = `<p class="report-placeholder">${escapeHtml(options.showLoading)}</p>`;
    return;
  }

  if(!shouldShowReportSection(report, share)){
    card.style.display = 'none';
    return;
  }

  card.style.display = 'flex';
  const monthLabel = report && report.monthLabel ? report.monthLabel : '';
  const rangeLabel = share && share.rangeLabel ? share.rangeLabel : '';
  if(subtitle){
    if(monthLabel){
      subtitle.textContent = `対象月：${monthLabel}`;
    }else if(rangeLabel){
      subtitle.textContent = `表示範囲：${rangeLabel}`;
    }else{
      subtitle.textContent = '対象月：最新月を確認中…';
    }
  }

  if(generatedAtEl){
    generatedAtEl.textContent = report && report.generatedAtText ? `生成日時：${report.generatedAtText}` : '';
  }

  if(statusEl){
    const statusText = report && report.status ? `ステータス：${report.status}` : '';
    statusEl.textContent = statusText;
    statusEl.style.display = statusText ? 'inline-block' : 'none';
  }

  if(report && Object.prototype.hasOwnProperty.call(report, 'reportText')){
    bodyEl.innerHTML = buildReportHtml(report.reportText);
  }else{
    bodyEl.innerHTML = '<p class="report-placeholder">レポート内容がありません。</p>';
  }
}

function setIntro(share){
  const info = getAudienceInfo(share && share.audience);
  const introEl = document.getElementById('shareIntro');
  if(!introEl) return;
  const passwordMsg = share && share.requirePassword ? 'パスワード入力後に閲覧できます。' : 'パスワード入力は不要です。';
  const rangeMsg = share && share.rangeLabel ? `${share.rangeLabel}の記録を表示中です。` : '最新の記録を表示中です。';
  introEl.innerHTML = `${escapeHtml(info.intro)}<br><span class="share-muted">${escapeHtml(passwordMsg)} ${escapeHtml(rangeMsg)}</span>`;
}

function setFooter(share){
  const footer = document.getElementById('shareFooter');
  if(!footer) return;
  const info = getAudienceInfo(share && share.audience);
  const tips = Array.isArray(info.manualTips) ? info.manualTips : [];
  footer.innerHTML = `閲覧方法や期限についてご不明な点がありましたら、担当のケアマネジャーまでご連絡ください。`;
  if(tips.length){
    footer.innerHTML += `<ul>${tips.map(t => `<li>${escapeHtml(t)}</li>`).join('')}</ul>`;
  }
}

function updateFilterVisibility(){
  const filters = document.getElementById('shareFilters');
  if(!filters) return;
  const shouldShow = !singleRecordMode && recordsCache.length > 1;
  filters.style.display = shouldShow ? 'flex' : 'none';
}

function setSingleRecordMode(enabled){
  singleRecordMode = !!enabled;
  updateFilterVisibility();
}

function getResolvedRecordId(){
  if(resolvedRecordId) return resolvedRecordId;
  const primaryId = sanitizeShareValue(primaryRecordData && primaryRecordData.recordId);
  if(primaryId){
    resolvedRecordId = primaryId;
    return resolvedRecordId;
  }
  if(recordsCache.length){
    const firstId = sanitizeShareValue(recordsCache[0] && recordsCache[0].recordId);
    if(firstId){
      resolvedRecordId = firstId;
      return resolvedRecordId;
    }
  }
  return '';
}

function updatePrintControls(record){
  const container = document.getElementById('printControls');
  const select = document.getElementById('printScope');
  const button = document.getElementById('printButton');
  if(!container || !select || !button) return;
  if(!record){
    container.style.display = 'none';
    button.disabled = true;
    return;
  }
  container.style.display = 'flex';
  const hasCenter = !!String(record.center || '').trim();
  const hasStaff = !!String(record.staff || '').trim();
  const centerOption = select.querySelector('option[value="center"]');
  const staffOption = select.querySelector('option[value="staff"]');
  if(centerOption) centerOption.disabled = !hasCenter;
  if(staffOption) staffOption.disabled = !hasStaff;
  if(select.value === 'center' && !hasCenter) select.value = 'record';
  if(select.value === 'staff' && !hasStaff) select.value = 'record';
  button.disabled = false;
}

function handlePrintClick(){
  const recordId = getResolvedRecordId();
  if(!externalToken || !recordId){
    showAlert('error', '印刷対象の記録を特定できません。');
    return;
  }
  const select = document.getElementById('printScope');
  const mode = select ? select.value : 'record';
  const params = new URLSearchParams({ shareId: externalToken, print: '1', recordId });
  if(mode && mode !== 'record') params.set('mode', mode);
  const url = `${EXEC_BASE_URL}?${params.toString()}`;
  window.open(url, '_blank', 'noopener');
}

/** キーワード装飾は try/catch で必ず成功させる */
function decorateText(value){
  let safe = escapeHtml(value || '');
  try {
    KEYWORD_RULES.forEach(rule => {
      const regex = new RegExp(rule.pattern, 'gi');
      safe = safe.replace(regex, match => `<span class="keyword-hit ${rule.className}">${escapeHtml(match)}</span>`);
    });
  } catch(_e) { /* 無視して素の本文を表示 */ }
  return safe.replace(/\n/g, '<br>');
}

function buildRecordHtml(record, showKind){
  const meta = [];
  meta.push(escapeHtml(record.dateText || '---'));
  if (showKind) meta.push(escapeHtml(record.kind || '種別未設定'));
  if (record.center) meta.push(`地域包括支援センター：${escapeHtml(record.center)}`);
  if (record.staff)  meta.push(`担当：${escapeHtml(record.staff)}`);

  const attachments = Array.isArray(record.attachments) ? record.attachments : [];
  const attachmentsHtml = attachments.length
    ? `<div class="record-attachments">${
        attachments.map(att => {
          const name = escapeHtml(att && att.name ? att.name : '添付ファイル');
          const url  = escapeHtml(att && att.url  ? att.url  : '#');
          return `<a href="${url}" target="_blank" rel="noopener">📎 ${name}</a>`;
        }).join('')
      }</div>`
    : '';

  const details = [];
  if (record.status)  details.push(`<div class="record-submeta"><strong>状態・経過：</strong>${escapeHtml(record.status)}</div>`);
  if (record.special) details.push(`<div class="record-submeta"><strong>特記事項：</strong>${escapeHtml(record.special)}</div>`);

  const isLatest = (latestTimestamp && Number(record.timestamp || 0) === latestTimestamp);
  const cls = isLatest ? 'share-record latest' : 'share-record';

  return [
    `<article class="${cls}">`,
      `<div class="record-meta">${meta.map(m => `<span>${m}</span>`).join('<span>｜</span>')}</div>`,
      `<div class="record-text">${decorateText(record.text || '') || '<span class="share-muted">（本文なし）</span>'}</div>`,
      details.join(''),
      attachmentsHtml,
    `</article>`
  ].join('');
}

function updateKindOptions(){
  const select = document.getElementById('filterKind');
  if(!select) return;
  const kinds = Array.from(new Set(recordsCache.map(rec => rec.kind).filter(Boolean))).sort((a,b) => String(a).localeCompare(String(b), 'ja'));
  const current = select.value;
  select.innerHTML = '<option value="all">すべて</option>' + kinds.map(kind => `<option value="${escapeHtml(kind)}">${escapeHtml(kind)}</option>`).join('');
  if(kinds.includes(current)){
    select.value = current;
  }
}

function updateRangeButtons(active){
  rangeButtons.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.range === active);
  });
}

function formatDateInput(ts){
  if(!ts) return '';
  const date = new Date(ts);
  if(Number.isNaN(date.getTime())) return '';
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth()+1).padStart(2,'0');
  const dd = String(date.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function getDefaultQuickRange(share){
  if(!share) return '30';
  const label = String(share.rangeLabel || '').toLowerCase();
  if(label.includes('全期間')) return 'all';
  if(label.includes('90')) return '90';
  if(label.includes('7')) return '7';
  return '30';
}

function applyQuickRange(range){
  const fromInput = document.getElementById('filterFrom');
  const toInput = document.getElementById('filterTo');
  updateRangeButtons(range);
  if(range === 'all'){
    if(fromInput) fromInput.value = '';
    if(toInput) toInput.value = '';
    applyFilters(true);
    return;
  }
  const days = Number(range);
  if(Number.isNaN(days)){
    applyFilters(true);
    return;
  }
  const endTs = latestTimestamp || Date.now();
  const startTs = endTs - days * 24 * 3600 * 1000;
  if(toInput) toInput.value = formatDateInput(endTs);
  if(fromInput) fromInput.value = formatDateInput(startTs);
  applyFilters(true);
}

function getFilterValues(){
  const searchInput = document.getElementById('filterSearch');
  const kindSelect = document.getElementById('filterKind');
  const sortSelect = document.getElementById('filterSort');
  const fromInput = document.getElementById('filterFrom');
  const toInput = document.getElementById('filterTo');
  const searchValue = searchInput ? searchInput.value.trim() : '';
  const kindValue = kindSelect ? kindSelect.value : 'all';
  const sortValue = sortSelect ? sortSelect.value : 'desc';
  const fromValue = fromInput ? fromInput.value : '';
  const toValue = toInput ? toInput.value : '';
  const fromTime = fromValue ? new Date(fromValue + 'T00:00:00').getTime() : null;
  const toTime = toValue ? new Date(toValue + 'T23:59:59').getTime() : null;
  return { searchValue, kindValue, sortValue, fromTime, toTime };
}

/** フィルタ＆ソート（安全に） */
function applyFilters(resetLimit){
  if (resetLimit) displayLimit = DISPLAY_LIMIT_DEFAULT;

  if (singleRecordMode) {
    filteredRecords = recordsCache.slice();
    displayLimit = filteredRecords.length;
    renderRecords();
    updateStatus('');
    return;
  }

  const { searchValue, kindValue, sortValue, fromTime, toTime } = getFilterValues();
  let results = recordsCache.slice();

  if (kindValue && kindValue !== 'all') {
    results = results.filter(rec => String(rec.kind || '') === kindValue);
  }
  if (fromTime) results = results.filter(rec => typeof rec.timestamp === 'number' ? rec.timestamp >= fromTime : true);
  if (toTime)   results = results.filter(rec => typeof rec.timestamp === 'number' ? rec.timestamp <= toTime   : true);

  if (searchValue) {
    const lower = searchValue.toLowerCase();
    results = results.filter(rec => (rec.searchIndex || '').includes(lower));
  }

  const cmpDesc = (a, b) => (Number(b.timestamp || 0) || 0) - (Number(a.timestamp || 0) || 0);
  if (sortValue === 'asc') {
    results.sort((a,b) => (Number(a.timestamp||0)||0) - (Number(b.timestamp||0)||0));
  } else if (sortValue === 'kind') {
    results.sort((a,b) => {
      const d = String(a.kind||'').localeCompare(String(b.kind||''), 'ja');
      return d !== 0 ? d : cmpDesc(a,b);
    });
  } else {
    results.sort(cmpDesc);
  }

  filteredRecords = results;
  renderRecords();
  updateStatus(searchValue);
}

/** 安定レンダリング（空配列や件数に耐性） */
function renderRecords(){
  const container = document.getElementById('recordsContainer');
  const emptyEl   = document.getElementById('emptyState');
  const loadMore  = document.getElementById('loadMore');
  if (!container) return;

  if (!filteredRecords.length) {
    container.innerHTML = '';
    if (emptyEl) {
      if (recordsCache.length) {
        emptyEl.textContent = '条件に合致する記録がありません。';
      } else {
        const noRecordMessage = currentShare && currentShare.hasRecords === false
          ? '記録が存在しません'
          : '共有可能な記録はまだありません。';
        emptyEl.textContent = noRecordMessage;
      }
      emptyEl.style.display = 'block';
    }
    if (loadMore) loadMore.style.display = 'none';
    return;
  }

  if (emptyEl) emptyEl.style.display = 'none';
  const showKind = currentShare ? (currentShare.audience !== 'family') : true;
  const items = filteredRecords.slice(0, displayLimit).map(rec => buildRecordHtml(rec, showKind)).join('\n');
  container.innerHTML = items;
  if (loadMore) loadMore.style.display = filteredRecords.length > displayLimit ? 'block' : 'none';
}

/** ステータス行（件数表示の安定化） */
function updateStatus(searchValue){
  const statusEl = document.getElementById('shareStatus');
  if (!statusEl) return;

  if (singleRecordMode) {
    statusEl.textContent = filteredRecords.length ? `${filteredRecords.length}件表示` : '表示できる記録がありません。';
    return;
  }
  if (!filteredRecords.length) {
    statusEl.textContent = searchValue ? `該当する記録はありません（キーワード「${searchValue}」）。` : '';
    return;
  }
  const total = recordsCache.length;
  const shown = Math.min(displayLimit, filteredRecords.length);
  const base  = (filteredRecords.length === total) ? `${filteredRecords.length}件表示` : `${shown}件表示（全${total}件中）`;
  statusEl.textContent = searchValue ? `${base} ｜ キーワード「${searchValue}」` : base;
}

function updateStatus(searchValue){
  const statusEl = document.getElementById('shareStatus');
  if(!statusEl) return;
  if(singleRecordMode){
    if(!filteredRecords.length){
      statusEl.textContent = '表示できる記録がありません。';
    }else{
      statusEl.textContent = `${filteredRecords.length}件表示`;
    }
    return;
  }
  if(!filteredRecords.length){
    if(searchValue){
      statusEl.textContent = `該当する記録はありません（キーワード「${searchValue}」）。`;
    }else{
      statusEl.textContent = '';
    }
    return;
  }
  const total = recordsCache.length;
  const shown = Math.min(displayLimit, filteredRecords.length);
  const base = filteredRecords.length === total ? `${filteredRecords.length}件表示` : `${shown}件表示（全${total}件中）`;
  statusEl.textContent = searchValue ? `${base} ｜ キーワード「${searchValue}」` : base;
}

function handleSearchInput(){
  if(searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(() => applyFilters(true), 180);
}

function handleLoadMore(){
  displayLimit += DISPLAY_STEP;
  renderRecords();
  const searchInput = document.getElementById('filterSearch');
  updateStatus(searchInput ? searchInput.value.trim() : '');
}

function prepareRangeButtons(){
  const chips = document.querySelectorAll('#rangeChips .range-chip');
  chips.forEach(btn => {
    rangeButtons.push(btn);
    btn.addEventListener('click', () => applyQuickRange(btn.dataset.range));
  });
}

function normalizeRecords(records){
  const audience = currentShare ? currentShare.audience : 'family';
  return records.map(rec => {
    const timestamp = Number(rec.timestamp || 0) || 0;
    const textValue = String(rec.text || '');
    const attachments = Array.isArray(rec.attachments) ? rec.attachments : [];
    const attachmentNames = attachments.map(att => String(att && att.name || '')).join(' ');
    const centerValue = String(rec.center || '');
    const staffValue = String(rec.staff || '');
    const statusValue = String(rec.status || '');
    const specialValue = String(rec.special || '');
    const searchIndex = `${textValue} ${attachmentNames} ${centerValue} ${staffValue} ${statusValue} ${specialValue}`.toLowerCase();
    return { ...rec, timestamp, searchIndex, audience };
  });
}

function onAuthSubmit(event){
  event.preventDefault();
  const input = document.getElementById('authPassword');
  const statusEl = document.getElementById('authStatus');
  const password = input ? input.value : '';
  if(statusEl) statusEl.textContent = '照合中です…';
  loadShareData(password).finally(() => {
    if(input) input.value = '';
  });
}

function fetchShareMeta(){
  if(!externalToken){
    showAlert('error', '共有リンクが見つかりません。担当のケアマネジャーにお問い合わせください。');
    setLoading('共有リンクが無効です。');
    return Promise.resolve(null);
  }
  setLoading('共有設定を確認しています…');
  return callShareApi('meta', { token: externalToken, recordId: resolvedRecordId }).then(res => {
    console.log("📥 fetchShareMeta response", res);   // デバッグ用ログ
    const payload = resolveSharePayload(res || {});
    const respStatus = (res && typeof res.status === 'string' && res.status) || payload.status || 'success';
    if(respStatus !== 'success'){
      const msg = payload.message || (res && res.message) || '共有設定の取得に失敗しました。';
      showAlert('error', msg);
      setLoading('閲覧を開始できませんでした。');
      return null;
    }

    const share = payload.share || {};
    currentShare = share;
    updateHeader(share);
    setIntro(share);
    setFooter(share);
    updateQrSection(share);

    currentReport = payload.report || null;
    if(share.requirePassword && !currentReport){
      updateReportCard(null, share, { requirePassword: true });
    }else{
      updateReportCard(currentReport, share);
    }

    let normalizedRecords = [];
    primaryRecordData = payload.primaryRecord || null;
    if(!primaryRecordData && Array.isArray(payload.records) && payload.records.length){
      primaryRecordData = payload.records[0];
    }
    console.log("📥 primaryRecordData", primaryRecordData);   // デバッグ用ログ

    // recordId が指定されていない場合は primaryRecord から拾う
    if(!resolvedRecordId && primaryRecordData){
      resolvedRecordId = sanitizeShareValue(primaryRecordData.recordId);
    }

    if(!share.requirePassword){
      normalizedRecords = normalizeRecords(Array.isArray(payload.records) ? payload.records : []);
      console.log("📥 normalizedRecords", normalizedRecords);   // デバッグ用ログ
      recordsCache = normalizedRecords;
      latestTimestamp = recordsCache.reduce((max, rec) => Math.max(max, Number(rec.timestamp||0)||0), 0) || null;
      updateKindOptions();
      updatePrintControls(primaryRecordData);
    }else{
      recordsCache = [];
      latestTimestamp = null;
      updateKindOptions();
      updatePrintControls(null);
    }

    // ✅ recordsCache の代入が終わったあとに呼ぶ
    // しかも「URLに recordId がある場合のみ true」にする
    setSingleRecordMode(Boolean(RECORD_ID_PARAM));

    updateFilterVisibility();

    if(share.expired){
      showAlert('warning', 'この共有リンクは期限切れです。最新のリンクを発行してください。');
      setLoading('期限切れのため閲覧できません。');
      return null;
    }

    showAlert('', '');
    const responseMessage = payload.message || (share && share.hasRecords === false ? '記録が存在しません' : '');
    const gotRecords = Array.isArray(normalizedRecords) && normalizedRecords.length > 0;
    const hasRecordsFlag = share && share.hasRecords;
    const shouldAutoEnter = !share.requirePassword && !share.expired && !gotRecords && hasRecordsFlag !== false;

    if(shouldAutoEnter){
      return loadShareData('').then(result => {
        if(result && Array.isArray(result.records) && result.records.length){
          return result;
        }
        const fallbackRecords = result && Array.isArray(result.records) ? result.records : normalizedRecords;
        const fallbackMessage = result && typeof result.message === 'string' ? result.message : responseMessage;
        return { share: currentShare, records: fallbackRecords, message: fallbackMessage };
      });
    }

    return { share, records: normalizedRecords, message: responseMessage };
  }).catch(err => {
    const msg = err && err.message ? err.message : '共有設定の取得に失敗しました。';
    showAlert('error', msg);
    setLoading('閲覧を開始できませんでした。');
    return null;
  });
}


function loadShareData(password){
  setLoading('記録を読み込んでいます…');
  return callShareApi('enter', { token: externalToken, password: password || '', recordId: resolvedRecordId }).then(res => {
    const payload = resolveSharePayload(res || {});
    const respStatus = (res && typeof res.status === 'string' && res.status) || payload.status || 'success';
    if(respStatus !== 'success'){
      const msg = payload.message || (res && res.message) || '閲覧に失敗しました。';
      showAlert('error', msg);
      const statusEl = document.getElementById('authStatus');
      if(statusEl) statusEl.textContent = msg;
      const auth = document.getElementById('shareAuth');
      if(auth) auth.style.display = 'block';
      setLoading('閲覧できませんでした。');
      return null;
    }

    const statusEl = document.getElementById('authStatus');
    if(statusEl) statusEl.textContent = '';

    currentShare = payload.share || currentShare;
    updateHeader(currentShare);
    setIntro(currentShare);
    setFooter(currentShare);
    updateQrSection(currentShare);

    currentReport = payload.report || currentReport;
    updateReportCard(currentReport, currentShare);

    const auth = document.getElementById('shareAuth');
    if(auth) auth.style.display = 'none';

    // primaryRecord の更新
    primaryRecordData = payload.primaryRecord || (Array.isArray(payload.records) ? payload.records[0] : primaryRecordData);
    if(!resolvedRecordId && primaryRecordData){
      resolvedRecordId = sanitizeShareValue(primaryRecordData.recordId);
    }

    showAlert(currentShare.expired ? 'warning' : '', currentShare.expired ? 'リンクの期限が切れています。再発行を依頼してください。' : '');

    // ✅ ここで recordsCache を更新
    recordsCache = normalizeRecords(Array.isArray(payload.records) ? payload.records : []);
    latestTimestamp = recordsCache.reduce((max, rec) => Math.max(max, Number(rec.timestamp||0)||0), 0) || null;

    // ✅ recordsCache 更新のあとに呼ぶ
    setSingleRecordMode(Boolean(RECORD_ID_PARAM));

    updateKindOptions();
    updateFilterVisibility();
    updatePrintControls(primaryRecordData);
    applyQuickRange(getDefaultQuickRange(currentShare));

    const responseMessage = payload.message || (currentShare && currentShare.hasRecords === false ? '記録が存在しません' : '');

    if(!recordsCache.length){
      const message = responseMessage || '共有可能な記録はまだありません。';
      setLoading(message);
      showEmptyState(message);
      return { share: currentShare, records: recordsCache, message };
    }

    applyFilters(true);
    return { share: currentShare, records: recordsCache, message: responseMessage };
  }).catch(err => {
    const msg = err && err.message ? err.message : '閲覧に失敗しました。';
    showAlert('error', msg);
    const statusEl = document.getElementById('authStatus');
    if(statusEl) statusEl.textContent = msg;
    setLoading('閲覧できませんでした。');
    return null;
  });
}


function initSharePage(){
  if(!externalToken){
    showAlert('error', '共有リンクが見つかりません。URLをご確認ください。');
    return;
  }
  prepareRangeButtons();
  const search = document.getElementById('filterSearch');
  if(search) search.addEventListener('input', handleSearchInput);
  const kind = document.getElementById('filterKind');
  if(kind) kind.addEventListener('change', () => applyFilters(true));
  const sort = document.getElementById('filterSort');
  if(sort) sort.addEventListener('change', () => applyFilters(true));
  const fromInput = document.getElementById('filterFrom');
  if(fromInput) fromInput.addEventListener('change', () => { updateRangeButtons(''); applyFilters(true); });
  const toInput = document.getElementById('filterTo');
  if(toInput) toInput.addEventListener('change', () => { updateRangeButtons(''); applyFilters(true); });
  const loadMore = document.getElementById('loadMore');
  if(loadMore) loadMore.addEventListener('click', handleLoadMore);
  const authForm = document.getElementById('authForm');
  if(authForm) authForm.addEventListener('submit', onAuthSubmit);
  const printButton = document.getElementById('printButton');
  if(printButton) printButton.addEventListener('click', handlePrintClick);

  fetchShareMeta().then(result => {
    if(!result) return;
    const share = result.share || currentShare || {};
    const responseMessage = result && result.message ? result.message : (share && share.hasRecords === false ? '記録が存在しません' : '');
    if(share.requirePassword){
      const auth = document.getElementById('shareAuth');
      if(auth) auth.style.display = 'block';
      if(share.hasRecords === false){
        const message = responseMessage || '記録が存在しません';
        setLoading(message);
        showEmptyState(message);
      }else{
        setLoading('パスワードを入力してください。');
      }
      return;
    }
    updateFilterVisibility();
    updatePrintControls(primaryRecordData);
    showAlert(share.expired ? 'warning' : '', share.expired ? 'リンクの期限が切れています。再発行を依頼してください。' : '');
    if(share.expired){
      setLoading('期限切れのため閲覧できません。');
      return;
    }
    const initialRecords = Array.isArray(result.records) ? result.records : recordsCache;
    if(initialRecords && initialRecords.length){
      recordsCache = initialRecords;
      latestTimestamp = recordsCache.reduce((max, rec) => Math.max(max, Number(rec.timestamp||0)||0), 0) || null;
      updateKindOptions();
      applyQuickRange(getDefaultQuickRange(share));
      applyFilters(true);
    }else{
      recordsCache = [];
      latestTimestamp = null;
      updateKindOptions();
      const message = responseMessage || '共有可能な記録はまだありません。';
      setLoading(message);
      showEmptyState(message);
    }
  });
}

if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', initSharePage);
}else{
  initSharePage();
}
</script>
</body>
</html>
