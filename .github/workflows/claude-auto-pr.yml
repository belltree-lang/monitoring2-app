name: Claude Auto UI Fix

on:
  pull_request:
    branches:
      - main

jobs:
  claude-auto-fix:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude to refactor UI code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          mkdir -p claude-changes
          SUMMARY=""

          for file in $(find src/components -name "*.jsx"); do
            echo "Refactoring $file..."
            claude "ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¢ãƒ€ãƒ³UIã«æ”¹å–„ã—ã¦ãã ã•ã„ã€‚æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„:" < $file > $file.new
            mv $file.new $file

            # æ”¹å–„å†…å®¹ã®è¦ç´„ã‚’ç”Ÿæˆ
            DESC=$(claude "æ¬¡ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã«ã¤ã„ã¦ã€UI/UXæ”¹å–„ã®è¦³ç‚¹ã‹ã‚‰è¦ç´„ã—ã¦ãã ã•ã„ï¼ˆ100å­—ä»¥å†…ã€æ—¥æœ¬èªã§ç°¡æ½”ã«ï¼‰:" < $file)
            SUMMARY="$SUMMARY\n- **$file**: $DESC"
          done

          echo -e "$SUMMARY" > claude-summary.md

      - name: Create new branch
        run: |
          BRANCH_NAME="claude-auto-fix-${{ github.run_id }}"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: auto UI refactor with Claude"
          git push origin $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          base: main
          title: "Auto UI Fix by Claude"
          body: |
            ğŸ¤– Claude ãŒè‡ªå‹•ã§ UI æ”¹å–„ã‚’è¡Œã„ã¾ã—ãŸã€‚
            
            ### æ”¹å–„å†…å®¹ã®è¦ç´„
            $(cat claude-summary.md)

            ---

            ã“ã® PR ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
