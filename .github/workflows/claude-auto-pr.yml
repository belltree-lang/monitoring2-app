name: Claude Auto UI Fix

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  claude-auto-fix:
    runs-on: ubuntu-latest
    env:
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - name: Checkout repo with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Resolve changed files in PR (only UI-like files)
        id: diff
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆè¿½åŠ /å¤‰æ›´ã®ã¿ï¼‰
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff --name-only --diff-filter=AM origin/${{ github.base_ref }}...HEAD > changed.txt

          # å¯¾è±¡æ‹¡å¼µå­ã®ã¿æŠ½å‡º
          awk '
            /\.jsx$|\.js$|\.tsx$|\.css$|\.scss$|\.html$/ { print }
          ' changed.txt > targets.txt || true

          echo "Changed files:"
          cat changed.txt || true
          echo "Claude targets:"
          cat targets.txt || true

          if [ -s targets.txt ]; then
            echo "has_targets=true" >> $GITHUB_OUTPUT
          else
            echo "has_targets=false" >> $GITHUB_OUTPUT
          fi

      - name: Short-circuit if no target files
        if: steps.diff.outputs.has_targets == 'false'
        run: |
          echo "No target UI files in this PR. Skipping Claude."
          printf "ã“ã®è‡ªå‹•PRã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚å¯¾è±¡UIãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.js/.jsx/.tsx/.css/.scss/.htmlï¼‰ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n" > claude-summary.md

      - name: Run Claude to refactor and summarize (with retry)
        if: steps.diff.outputs.has_targets == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set -euo pipefail

          python3 - <<'PY'
import subprocess, sys, time, pathlib

def run_claude(prompt, input_text, retries=3):
    for i in range(retries):
        try:
            p = subprocess.run(
                ["claude", prompt],
                input=input_text.encode("utf-8"),
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                check=True,
            )
            return p.stdout.decode("utf-8", errors="replace")
        except subprocess.CalledProcessError as e:
            if i == retries - 1:
                sys.stderr.write(f"Claude failed: {e.stderr.decode('utf-8', 'replace')}\n")
                raise
            time.sleep(2 * (i + 1))
    return ""

targets = []
with open("targets.txt", "r", encoding="utf-8", errors="ignore") as f:
    targets = [line.strip() for line in f if line.strip()]

summary_lines = []
for fpath in targets:
    try:
        with open(fpath, "r", encoding="utf-8", errors="replace") as rf:
            original = rf.read()

        # 1) ã‚³ãƒ¼ãƒ‰å¤‰æ›ï¼ˆã‚³ãƒ¼ãƒ‰ã®ã¿è¿”ã™æŒ‡ç¤ºï¼‰
        new_code = run_claude(
            "æ—¢å­˜ã®æ©Ÿèƒ½ã‚„è¦ç´ ã¯ä¿æŒã—ã¤ã¤ã€ã‚ˆã‚Šè‰¯ã„UIã«æ”¹å–„ã—ã¦ãã ã•ã„ã€‚\
- è¦‹ã‚„ã™ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰\
- ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ä¸€è²«æ€§\
- è‰²ã‚„ä½™ç™½ã‚’æ•´ç†ã—ã¦ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š\
- ARIAãƒ©ãƒ™ãƒ«ã‚„ä»£æ›¿ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ \
æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜Žã¯ä¸è¦ã§ã™ã€‚",
            original
        )
        if new_code.strip():
            with open(fpath, "w", encoding="utf-8") as wf:
                wf.write(new_code)

        # 2) è¦ç´„ï¼ˆçŸ­ãè¦ç‚¹ï¼‰
        desc = run_claude(
            "æ¬¡ã®å¤‰æ›´ç‚¹ã‚’UI/UXè¦³ç‚¹ã§100å­—ä»¥å†…ã®æ—¥æœ¬èªžã§ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚ç®‡æ¡æ›¸ãä¸å¯ã€1æ–‡ã§ã€‚",
            new_code if new_code.strip() else original
        ).strip()
        if not desc:
            desc = "ã‚³ãƒ¼ãƒ‰ã®æ•´å½¢ã¾ãŸã¯è»½å¾®ãªæ”¹å–„ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚"

        summary_lines.append(f"- **{fpath}**: {desc}")

    except Exception as e:
        summary_lines.append(f"- **{fpath}**: è¦ç´„ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ{e}ï¼‰ã€‚")

# è¦ç´„æœ¬æ–‡ã®ç”Ÿæˆ
pathlib.Path("claude-summary.md").write_text(
    "ðŸ¤– Claude ãŒè‡ªå‹•ã§ UI æ”¹å–„ã‚’è¡Œã„ã¾ã—ãŸã€‚\n\n"
    "### æ”¹å–„å†…å®¹ã®è¦ç´„\n"
    + ("\n".join(summary_lines) if summary_lines else "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
    + "\n\n---\næœ¬PRã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚\n",
    encoding="utf-8"
)
PY

      - name: Commit Claude-changed files to new branch
        run: |
          BRANCH_NAME="claude-auto-fix-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit (Claude produced no modifications)."
          else
            git commit -m "chore: auto UI refactor with Claude"
          fi
          git push origin "$BRANCH_NAME" || true
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request with body-path
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          base: main
          title: "Auto UI Fix by Claude"
          body-path: "claude-summary.md"

      - name: Upload artifacts (summary & diff)
        uses: actions/upload-artifact@v4
        with:
          name: claude-report-${{ github.run_id }}
          path: |
            claude-summary.md
            changed.txt
            targets.txt
