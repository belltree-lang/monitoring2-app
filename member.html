<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ケアマネ・モニタリング</title>
<style>
:root {
  --fg:#222; --bg:#f4f6fa; --card:#fff; --brand:#1976d2;
  --muted:#555; --accent:#e3f2fd;
}
body { font-family:"Noto Sans JP",system-ui,sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--fg);}
h1 { margin:0 0 20px; font-size:1.6rem; color:var(--brand);}
h2 { margin:14px 0 8px; font-size:1.15rem; color:#333;}
.card { background:var(--card); border-radius:10px; padding:16px; margin-bottom:18px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);}
.toolbar { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0;}
input[type=text], select, textarea { font-family:inherit; border:1px solid #ccc; border-radius:6px; padding:8px 10px;}
textarea { width:100%; min-height:120px;}
button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; transition:.2s; font-size:0.85rem;}
button { background:var(--brand); color:#fff;}
button.secondary { background:#eee; color:#333;}
button.danger { background:#d32f2f; color:#fff;}
button:hover { opacity:0.9;}
.btn-compact { padding:4px 8px; font-size:0.8rem; }
.pill { display:inline-block; padding:4px 10px; font-size:.85rem; border-radius:999px; background:var(--accent); color:var(--brand);}
.autocomplete-list { position:absolute; background:#fff; border:1px solid #ccc; border-radius:6px;
  max-height:220px; overflow-y:auto; width:260px; box-shadow:0 2px 6px rgba(0,0,0,.1); z-index:100;}
.autocomplete-item { padding:8px 12px; cursor:pointer; font-size:0.9rem;}
.autocomplete-item:hover { background:var(--accent);}
.layout { display:grid; grid-template-columns:1fr 320px; gap:16px;}
@media(max-width:960px){.layout{grid-template-columns:1fr;}}
.record { margin-bottom:12px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff;}
.record .muted { font-size:0.85rem; color:#666;}
.record .toolbar { margin-top:6px;}

.record .text { margin:6px 0; font-size:0.92rem; white-space:pre-wrap; line-height:1.5; }
.record .attachments { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
.record .attachments a { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; font-size:0.8rem; border-radius:999px; background:#f0f4ff; color:var(--brand); text-decoration:none; }
.record .attachments a:hover { background:#dbe5ff; }
.search-toolbar { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 4px; }
.search-toolbar label { font-size:0.85rem; color:#666; display:flex; align-items:center; gap:6px; }
.search-toolbar input[type=date], .search-toolbar input[type=text] { font-size:0.85rem; }
.media-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); }
.media-card { border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.05); }
.media-card a { display:block; color:inherit; text-decoration:none; }
.media-card img { width:100%; height:100px; object-fit:cover; display:block; background:#f6f8fb; }
.media-card .media-icon { height:100px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; background:#f6f8fb; }
.media-card .media-meta { padding:8px; font-size:0.75rem; color:#555; }
.media-card .media-meta .name { font-weight:600; color:#333; margin-bottom:4px; }
.dashboard-card h2 { display:flex; align-items:center; justify-content:space-between; gap:8px; }
.dashboard-wrapper { display:flex; gap:14px; align-items:flex-start; margin-top:8px; }
.dashboard-sidebar { width:48px; display:flex; flex-direction:column; gap:6px; position:sticky; top:12px; }
.dashboard-sidebar .dashboard-index-btn { background:#e9f0fb; color:#1c3a6b; border:none; border-radius:12px; padding:8px 0; font-size:0.75rem; cursor:pointer; transition:.2s; width:100%; min-height:32px; }
.dashboard-sidebar .dashboard-index-btn.active { background:var(--brand); color:#fff; box-shadow:0 2px 8px rgba(25,118,210,0.25); }
.dashboard-sidebar .dashboard-index-btn:hover { opacity:0.85; }
.dashboard-sidebar .dashboard-index-empty { font-size:0.75rem; color:#718096; writing-mode:vertical-rl; text-orientation:mixed; padding:8px 0; }
.dashboard-main { flex:1; display:flex; flex-direction:column; gap:12px; }
.dashboard-filters { background:#f5f8ff; border:1px solid #d3e0f6; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; }
.dashboard-filter-row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.dashboard-filter { display:flex; flex-direction:column; gap:6px; font-size:0.8rem; color:#4a5a75; min-width:160px; }
.dashboard-filter label { font-weight:600; }
.dashboard-filter select { font-size:0.85rem; padding:6px 8px; border-radius:6px; border:1px solid #ccd5e6; background:#fff; }
.dashboard-care-chips { display:flex; flex-wrap:wrap; gap:6px; }
.dashboard-chip { border:1px solid #b8c7e6; background:#fff; color:#2b3d6d; border-radius:999px; padding:6px 12px; font-size:0.78rem; cursor:pointer; transition:.2s; }
.dashboard-chip.active { background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 2px 8px rgba(25,118,210,0.25); }
.dashboard-filter-summary { font-size:0.78rem; color:#5a6a85; }
.dashboard-sections { display:flex; flex-direction:column; gap:12px; }
.dashboard-section { border:1px solid #dbe6f6; border-radius:12px; background:#fff; overflow:hidden; }
.dashboard-section-toggle { width:100%; background:#f1f6ff; border:none; display:flex; align-items:center; gap:10px; padding:12px 14px; font-size:0.95rem; color:#1f3763; font-weight:600; cursor:pointer; transition:.2s; text-align:left; }
.dashboard-section-toggle::after { content:'▸'; margin-left:auto; font-size:1rem; color:#4a5a75; transition:transform .2s; }
.dashboard-section-toggle.is-open { background:#e4efff; }
.dashboard-section-toggle.is-open::after { content:'▾'; }
.dashboard-section-count { font-size:0.78rem; color:#5a6a85; font-weight:500; }
.dashboard-section-body { display:none; }
.dashboard-section-body.is-open { display:block; }
.dashboard-entry { display:flex; flex-wrap:wrap; align-items:flex-start; gap:12px; padding:12px 16px; border-top:1px solid #e3ebf8; }
.dashboard-entry:first-of-type { border-top:none; }
.dashboard-entry.status-pending { background:#fff9f4; }
.dashboard-entry.status-completed { background:#f5faf4; }
.dashboard-entry.selected { box-shadow:0 0 0 2px rgba(25,118,210,0.2); border-radius:10px; }
.dashboard-entry-main { flex:1; min-width:220px; }
.dashboard-entry-name { font-weight:600; font-size:0.95rem; color:#1f2f4b; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.dashboard-entry-id { font-size:0.8rem; color:#5a6a85; background:#eef3ff; border-radius:6px; padding:2px 6px; }
.dashboard-entry-meta { margin-top:6px; display:flex; flex-wrap:wrap; gap:8px 14px; font-size:0.8rem; color:#5a6a85; }
.dashboard-entry-actions { display:flex; flex-direction:column; gap:6px; align-items:flex-end; min-width:140px; }
.dashboard-status-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.78rem; font-weight:600; }
.dashboard-status-badge.pending { background:#ffe4d6; color:#c55400; }
.dashboard-status-badge.completed { background:#e4f3e8; color:#2e7d32; }
.dashboard-entry-actions .link-button { text-decoration:none; }
.dashboard-index-note { font-size:0.75rem; color:#5a6a85; }
@media(max-width:960px){
  .dashboard-wrapper{flex-direction:column;}
  .dashboard-sidebar{width:100%; position:static; flex-direction:row; flex-wrap:wrap; justify-content:flex-start; }
  .dashboard-sidebar .dashboard-index-btn{flex:0 0 auto; padding:6px 10px; min-width:36px; }
  .dashboard-sidebar .dashboard-index-empty{writing-mode:initial; text-align:center; width:100%; }
  .dashboard-entry-actions{flex-direction:row; align-items:center; justify-content:flex-end; }
}
.muted { color:#666; font-size:0.8rem; }
  
#mediaGallery { min-height:80px; }
.media-grid { display:flex; flex-direction:column; gap:8px; }
.media-item { background:#f7f9ff; border:1px solid #dbe6f6; border-radius:8px; padding:8px 10px; }
.media-item a { color:var(--brand); font-weight:600; text-decoration:none; word-break:break-all; }
.media-item a:hover { text-decoration:underline; }
.media-missing { color:#777; font-weight:600; word-break:break-all; }
.media-meta { margin-top:4px; font-size:0.78rem; color:var(--muted); display:flex; gap:6px; flex-wrap:wrap; }
.share-card .toolbar { justify-content:flex-start; }
.share-list { display:flex; flex-direction:column; gap:10px; }
.share-item { border:1px solid #dbe6f6; border-radius:8px; padding:10px; background:#f8fbff; position:relative; }
.share-item.expired { background:#fff3f3; border-color:#f5c2c2; }
.share-item .share-item-header { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
.share-item .share-url { flex:1; display:flex; gap:6px; align-items:center; }
.share-item .share-url input { flex:1; font-size:0.78rem; padding:4px 6px; border-radius:6px; border:1px solid #c7d7ef; background:#fff; }
.share-item .share-meta { display:flex; flex-wrap:wrap; gap:10px; font-size:0.75rem; color:#546079; margin-top:6px; }
.share-item .share-actions { display:flex; gap:6px; margin-top:8px; }
.share-form { border-top:1px dashed #c7d7ef; padding-top:10px; margin-top:10px; }
.share-form .share-field { margin-bottom:10px; }
.share-form label { font-size:0.82rem; color:#445; display:flex; flex-direction:column; gap:4px; }
.share-form input[type="text"], .share-form input[type="datetime-local"] { font-size:0.85rem; padding:6px 8px; border:1px solid #c7d7ef; border-radius:6px; }
.share-attachments { display:flex; flex-direction:column; gap:6px; max-height:180px; overflow-y:auto; padding:6px; background:#f2f7ff; border-radius:6px; border:1px solid #d2def5; }
.share-attachments .share-attachment { display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#334; }
.share-attachments .share-attachment .muted { margin-left:auto; }
.share-attachments .share-attachment-info { display:flex; flex-direction:column; }
.share-attachments .share-attachment-info span { font-size:0.76rem; color:#667; }
.share-empty { font-size:0.8rem; color:#666; padding:6px 4px; }
.share-helper { font-size:0.75rem; color:#6a7a93; margin-top:4px; }
.share-item .badge { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; border-radius:999px; background:#e3f2fd; color:#1957a3; font-size:0.7rem; }
.share-item.expired .badge { background:#ffe6e6; color:#b71c1c; }
.share-item .tag-group { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.share-form .toolbar { gap:8px; }
.share-attachments-all { font-size:0.82rem; display:flex; align-items:center; gap:6px; margin-bottom:6px; }
.external-wrapper { max-width:800px; margin:0 auto; }
.external-card { background:#fff; border-radius:16px; padding:20px; box-shadow:0 6px 24px rgba(25,118,210,0.16); margin-top:30px; }
.external-header { display:flex; flex-direction:column; gap:6px; margin-bottom:16px; }
.external-title { font-size:1.4rem; color:var(--brand); margin:0; }
.external-member { font-size:1rem; color:#40566f; }
.external-intro { font-size:0.92rem; color:#4f5b6c; line-height:1.6; background:#f1f7ff; padding:12px; border-radius:12px; border:1px solid #d3e4ff; }
.external-alert { margin-top:12px; padding:10px; border-radius:10px; font-size:0.88rem; display:none; }
.external-alert.error { background:#ffe4e4; color:#b71c1c; border:1px solid #f5b5b5; display:block; }
.external-alert.warning { background:#fff7e0; color:#8d6e02; border:1px solid #f4d67a; display:block; }
.external-auth { margin-top:16px; padding:16px; border-radius:12px; background:#f9fbff; border:1px solid #dfe8fb; }
.external-auth label { font-size:0.85rem; color:#445; display:flex; flex-direction:column; gap:6px; }
.external-auth input[type="password"] { padding:8px; border-radius:6px; border:1px solid #c1ceeb; font-size:0.95rem; }
.external-auth button { margin-top:12px; }
.external-records { margin-top:20px; display:flex; flex-direction:column; gap:14px; }
.external-record { background:#f6f9ff; border:1px solid #d8e4ff; border-radius:12px; padding:14px; box-shadow:0 2px 6px rgba(25,118,210,0.08); }
.external-record .meta { font-size:0.85rem; color:#386087; margin-bottom:6px; display:flex; gap:6px; flex-wrap:wrap; }
.external-record .text { font-size:0.95rem; line-height:1.6; color:#223; white-space:pre-wrap; }
.external-record .attachments { margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
.external-record .attachments a { padding:6px 10px; background:#fff; border-radius:999px; border:1px solid #b7cef5; color:#1a56a3; font-size:0.82rem; text-decoration:none; }
.external-record .attachments a:hover { background:#e8f1ff; }
.external-footer { font-size:0.78rem; color:#718096; margin-top:24px; text-align:center; }
.external-muted { font-size:0.85rem; color:#6b7b92; }
body.external-mode { background:#f0f4ff; }
.external-mode #internalApp { display:none !important; }
.external-mode #externalApp { display:block !important; }
</style>
</head>
<body>
<div id="internalApp">
<h1>ケアマネ・モニタリング
  <span class="pill" id="memberTag">未選択</span>
</h1>

<!-- 利用者選択 -->
<div class="card">
  <h2>利用者を選択</h2>
  <div class="toolbar" style="position:relative;">
    <input type="text" id="memberIdInput" placeholder="IDまたは氏名で検索" autocomplete="off" style="min-width:260px;">
    <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
    <select id="recordRange">
      <option value="all">全件</option>
      <option value="90">直近90日</option>
      <option value="30" selected>直近30日</option>
      <option value="7">直近7日</option>
    </select>
    <button id="btnReload" class="secondary">更新</button>
  </div>
  <div id="idStatus" class="muted"></div>
</div>

<!-- 新規利用者登録 -->
<div class="card">
  <h2>新規利用者登録</h2>
  <div class="toolbar">
    <input type="text" id="newMemberId" placeholder="ID (4桁)" maxlength="4" style="width:100px;">
    <input type="text" id="newMemberName" placeholder="氏名（例: 山田　太郎）" style="flex:1;">
    <button id="btnAddMember">登録</button>
  </div>
  <div id="addMemberStatus" class="muted"></div>
</div>

<!-- メインUI -->
<div id="mainArea" style="display:none;">
  <div class="layout">
    <div class="left">
      <!-- 新規記録 -->
      <div class="card">
        <h2>新規モニタリング記録</h2>
        <div class="toolbar">
          <label for="kindSelect">種別:</label>
          <select id="kindSelect">
            <option value="訪問">訪問</option>
            <option value="電話">電話</option>
            <option value="施設面談">施設面談</option>
            <option value="通所観察">通所観察</option>
            <option value="サービス担当者会議">サービス担当者会議</option>
            <option value="その他" selected>その他</option>
          </select>
        </div>
        <textarea id="inputText" placeholder="記録を入力..."></textarea>
        <div class="toolbar">
          <input id="fileInput" type="file" multiple />
          <button id="btnSave">保存</button>
          <span id="saveStatus" class="muted"></span>
        </div>
      </div>
      <!-- AI要約 -->
      <div class="card">
        <h2>AI要約</h2>
        <div class="toolbar">
          <select id="summaryFormat">
            <option value="normal">標準</option>
            <option value="icf">ICF形式</option>
            <option value="soap">SOAP形式</option>
            <option value="doctor">医療連携</option>
            <option value="family">家族向け</option>
          </select>
          <button id="btnSummary">要約生成</button>
        </div>
        <div id="summaryOutput" class="muted">ここに要約が表示されます</div>
      </div>
      <!-- 提案 -->
      <div class="card">
        <h2>ケアマネからの提案</h2>
        <div class="toolbar">
          <select id="adviceHorizonSelect">
            <option value="now">すぐに対応</option>
            <option value="2w">2週間</option>
            <option value="1m">1か月</option>
            <option value="3m" selected>3か月</option>
          </select>
          <button id="btnAdvice">提案生成</button>
        </div>
        <div id="adviceOutput" class="muted">ここに提案が表示されます</div>
      </div>
      <!-- 過去の記録 -->
      <div class="card">
        <h2>過去の記録</h2>
        <div class="search-toolbar">
          <label>種別
            <select id="filterKind">
              <option value="all">すべて</option>
              <option value="訪問">訪問</option>
              <option value="電話">電話</option>
              <option value="施設面談">施設面談</option>
              <option value="通所観察">通所観察</option>
              <option value="サービス担当者会議">サービス担当者会議</option>
              <option value="その他">その他</option>
            </select>
          </label>
          <label>開始
            <input type="date" id="filterDateFrom">
          </label>
          <label>終了
            <input type="date" id="filterDateTo">
          </label>
          <input type="text" id="filterText" placeholder="本文検索（キーワード）" style="flex:1; min-width:160px;">
          <button id="btnClearFilters" class="secondary btn-compact">クリア</button>
        </div>
        <div id="recordList" class="muted">利用者を選択してください</div>
      </div>
    </div>
    <aside class="right">
      <div class="card">
        <h2>添付ギャラリー</h2>
        <div id="mediaGallery" class="muted">利用者を選択してください</div>
      </div>
      <div class="card dashboard-card">
        <h2>利用者ダッシュボード</h2>
        <div id="dashboardStatus" class="muted">読込中…</div>
        <div class="dashboard-wrapper">
          <nav id="dashboardIndex" class="dashboard-sidebar" aria-label="五十音ナビ"></nav>
          <div class="dashboard-main">
            <div id="dashboardFilters" class="dashboard-filters"></div>
            <div id="dashboardTable" class="dashboard-sections"></div>
          </div>
        </div>
      </div>
      <div class="card share-card">
        <h2>外部共有</h2>
        <div id="shareList" class="share-list muted">利用者を選択すると共有リンクが表示されます</div>
        <div class="toolbar">
          <button id="btnOpenShareForm" class="secondary btn-compact">共有リンクを作成</button>
        </div>
        <div id="shareForm" class="share-form" style="display:none;">
          <div class="share-field">
            <label>閲覧期限（未設定の場合は無期限）
              <input type="datetime-local" id="shareExpires">
            </label>
          </div>
          <div class="share-field">
            <label>閲覧用パスワード（任意）
              <input type="text" id="sharePassword" placeholder="未入力の場合はパスワードなし">
            </label>
            <div class="share-helper">安全のため、英数字を組み合わせた8文字以上を推奨します。</div>
          </div>
          <div class="share-field">
            <label><input type="checkbox" id="shareMaskCheckbox" checked> 本文をやさしくマスキングする</label>
          </div>
          <div class="share-field">
            <div class="share-attachments-all">
              <label><input type="checkbox" id="shareAttachmentAll"> すべての添付ファイルを共有する</label>
            </div>
            <div id="shareAttachments" class="share-attachments muted">記録を読み込み中です…</div>
          </div>
          <div class="toolbar">
            <button id="btnCreateShare">共有リンクを発行</button>
            <button type="button" id="btnCancelShare" class="secondary">キャンセル</button>
          </div>
          <div id="shareFormStatus" class="muted"></div>
        </div>
      </div>
    </aside>
  </div>
</div>

<div id="externalApp" style="display:none;">
  <div class="external-wrapper">
    <div class="external-card">
      <div class="external-header">
        <h1 class="external-title">モニタリング共有ビュー</h1>
        <div id="externalMember" class="external-member"></div>
        <div id="externalExpiry" class="external-muted"></div>
      </div>
      <div id="externalIntro" class="external-intro">
        大切なご家族や関係者の皆さまと状況を共有するためのページです。必要な情報だけをまとめていますので、安心してご覧ください。
      </div>
      <div id="externalAlert" class="external-alert"></div>
      <div id="externalAuth" class="external-auth" style="display:none;">
        <form id="externalAuthForm">
          <label>閲覧パスワード
            <input type="password" id="externalPassword" autocomplete="one-time-code" placeholder="パスワードを入力してください">
          </label>
          <button type="submit">表示する</button>
          <div id="externalAuthStatus" class="external-muted" style="margin-top:8px;"></div>
        </form>
      </div>
      <div id="externalRecords" class="external-records"></div>
      <div id="externalFooter" class="external-footer"></div>
    </div>
  </div>
</div>

<script>
let memberId = null, memberName = "";
let memberList = [];
let recordsCache = [];
const queryParams = new URLSearchParams(window.location.search);
const externalToken = queryParams.get("share") || queryParams.get("token") || "";
const isExternalMode = !!externalToken;

const DASHBOARD_COLLAPSE_STORAGE_KEY = "monitoringDashboardCollapsed";

function loadDashboardCollapsedSections() {
  try {
    const raw = sessionStorage.getItem(DASHBOARD_COLLAPSE_STORAGE_KEY);
    if (!raw) return {};
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed === "object" && !Array.isArray(parsed)) {
      return parsed;
    }
  } catch (err) {
    console.warn("collapse-state-load", err);
  }
  return {};
}

function saveDashboardCollapsedSections() {
  try {
    const snapshot = dashboardState && dashboardState.collapsedSections ? dashboardState.collapsedSections : {};
    sessionStorage.setItem(DASHBOARD_COLLAPSE_STORAGE_KEY, JSON.stringify(snapshot));
  } catch (err) {
    console.warn("collapse-state-save", err);
  }
}

function getInitialDashboardFiltersFromQuery() {
  const validStatus = ["all", "pending", "completed"];
  const statusParam = String(queryParams.get("monitoringStatus") || "").toLowerCase();
  const status = validStatus.includes(statusParam) ? statusParam : "all";
  const careManagers = queryParams.getAll("careManager").map(v => String(v || "").trim()).filter(Boolean);
  return {
    status,
    careManagers
  };
}

let dashboardState = {
  data: [],
  monthLabel: "",
  sortKey: "name",
  sortDir: "asc",
  activeInitial: null,
  filters: getInitialDashboardFiltersFromQuery(),
  collapsedSections: loadDashboardCollapsedSections(),
  pendingScrollLabel: null
};
let externalShares = [];
let shareFormOpen = false;
const queryParams = new URLSearchParams(window.location.search);
const externalToken = queryParams.get("share") || queryParams.get("token") || "";
const isExternalMode = !!externalToken;

let externalShares = [];
let shareFormOpen = false;

const DASHBOARD_KANA_GROUPS = [
  { label: "あ", members: ["ア", "イ", "ウ", "エ", "オ", "ァ", "ィ", "ゥ", "ェ", "ォ"] },
  { label: "か", members: ["カ", "キ", "ク", "ケ", "コ", "ガ", "ギ", "グ", "ゲ", "ゴ"] },
  { label: "さ", members: ["サ", "シ", "ス", "セ", "ソ", "ザ", "ジ", "ズ", "ゼ", "ゾ"] },
  { label: "た", members: ["タ", "チ", "ツ", "テ", "ト", "ダ", "ヂ", "ヅ", "デ", "ド", "ッ"] },
  { label: "な", members: ["ナ", "ニ", "ヌ", "ネ", "ノ"] },
  { label: "は", members: ["ハ", "ヒ", "フ", "ヘ", "ホ", "バ", "ビ", "ブ", "ベ", "ボ", "パ", "ピ", "プ", "ペ", "ポ"] },
  { label: "ま", members: ["マ", "ミ", "ム", "メ", "モ"] },
  { label: "や", members: ["ヤ", "ユ", "ヨ", "ャ", "ュ", "ョ"] },
  { label: "ら", members: ["ラ", "リ", "ル", "レ", "ロ"] },
  { label: "わ", members: ["ワ", "ヲ", "ン"] }
];
const DASHBOARD_ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const DASHBOARD_COLLATOR = new Intl.Collator(["ja", "en"], { sensitivity: "base", numeric: true, caseFirst: "false" });

function toKatakanaChar(ch) {
  if (!ch) return "";
  const code = ch.charCodeAt(0);
  if (code >= 0x3041 && code <= 0x3096) {
    return String.fromCharCode(code + 0x60);
  }
  return ch;
}

function getInitialGroupFromName(name) {
  const base = String(name || "").trim();
  if (!base) return "#";
  const firstChar = base[0].normalize("NFKC");
  if (!firstChar) return "#";
  const katakana = toKatakanaChar(firstChar);
  for (const group of DASHBOARD_KANA_GROUPS) {
    if (group.members.includes(katakana)) {
      return group.label;
    }
  }
  const upper = firstChar.toUpperCase();
  if (DASHBOARD_ALPHABET.includes(upper)) {
    return upper;
  }
  if (/\d/.test(firstChar)) {
    return "0-9";
  }
  return "#";
}

function getDashboardIndexGroups(sortedData) {
  const exists = new Set();
  (Array.isArray(sortedData) ? sortedData : []).forEach(entry => {
    const label = getInitialGroupFromName(entry && (entry.name || entry.id));
    exists.add(label);
  });
  const order = [
    ...DASHBOARD_KANA_GROUPS.map(g => g.label),
    ...DASHBOARD_ALPHABET,
    "0-9",
    "#"
  ];
  return order.filter(label => exists.has(label));
}

function parseCareManagerList(value) {
  const raw = String(value || "").trim();
  if (!raw) return [];
  return raw
    .split(/[、,，;；\/／\|｜\n]+/)
    .map(part => part.trim())
    .filter(Boolean);
}

function getDashboardCareManagerOptions(data) {
  const set = new Set();
  (Array.isArray(data) ? data : []).forEach(entry => {
    parseCareManagerList(entry && entry.careManager).forEach(name => set.add(name));
  });
  const list = Array.from(set);
  list.sort((a, b) => DASHBOARD_COLLATOR.compare(a, b));
  return list;
}

function applyDashboardFilters(data) {
  const filters = dashboardState && dashboardState.filters ? dashboardState.filters : {};
  const status = filters.status || "all";
  const careManagers = Array.isArray(filters.careManagers) ? filters.careManagers : [];
  return (Array.isArray(data) ? data : []).filter(entry => {
    if (!entry) return false;
    const statusKey = (entry.monitoringStatus === "completed") ? "completed" : "pending";
    if (status === "pending" && statusKey !== "pending") return false;
    if (status === "completed" && statusKey !== "completed") return false;
    if (careManagers.length) {
      const entryManagers = parseCareManagerList(entry.careManager);
      if (!entryManagers.some(name => careManagers.includes(name))) {
        return false;
      }
    }
    return true;
  });
}

function buildDashboardSections(data) {
  const sections = [];
  const groups = new Map();
  (Array.isArray(data) ? data : []).forEach(entry => {
    const label = getInitialGroupFromName(entry && (entry.name || entry.id));
    if (!groups.has(label)) {
      groups.set(label, []);
    }
    groups.get(label).push(entry);
  });
  const order = getDashboardIndexGroups(data);
  order.forEach(label => {
    sections.push({ label, entries: groups.get(label) || [] });
  });
  return sections;
}

function getDashboardSectionDomId(label) {
  const base = String(label || "").trim();
  const safe = base.replace(/[^0-9A-Za-z\u3040-\u30FF]/g, "").toLowerCase();
  return `dashboard-section-${safe || "misc"}`;
}

function updateDashboardFilterQueryParams() {
  if (isExternalMode) return;
  try {
    const params = new URLSearchParams(window.location.search);
    const filters = dashboardState && dashboardState.filters ? dashboardState.filters : {};
    const status = filters.status || "all";
    if (status && status !== "all") {
      params.set("monitoringStatus", status);
    } else {
      params.delete("monitoringStatus");
    }
    params.delete("careManager");
    const careManagers = Array.isArray(filters.careManagers) ? filters.careManagers : [];
    careManagers.forEach(name => params.append("careManager", name));
    const query = params.toString();
    const newUrl = `${window.location.pathname}${query ? `?${query}` : ""}${window.location.hash}`;
    window.history.replaceState(null, "", newUrl);
  } catch (err) {
    console.warn("filter-query-update", err);
  }
}

function getEntryLatestTimestamp(entry) {
  if (!entry) return NaN;
  const candidates = [
    entry.latestTimestamp,
    entry.latestDate,
    entry.latestDateValue,
    entry.latestDateText
  ];
  for (const value of candidates) {
    if (typeof value === "number" && isFinite(value)) return value;
    if (value instanceof Date && isFinite(value.getTime())) return value.getTime();
    if (typeof value === "string" && value) {
      const parsed = Date.parse(value);
      if (!isNaN(parsed)) return parsed;
    }
  }
  return NaN;
}

function getSortedDashboardData() {
  const data = Array.isArray(dashboardState.data) ? dashboardState.data.slice() : [];
  const dir = dashboardState.sortDir === "desc" ? -1 : 1;
  const sortKey = dashboardState.sortKey || "name";
  data.sort((a, b) => {
    const nameA = String(a && a.name || "").trim();
    const nameB = String(b && b.name || "").trim();
    const idA = String(a && a.id || "").trim();
    const idB = String(b && b.id || "").trim();
    if (sortKey === "latest") {
      const tsA = getEntryLatestTimestamp(a);
      const tsB = getEntryLatestTimestamp(b);
      const safeA = Number.isFinite(tsA) ? tsA : (dir === -1 ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY);
      const safeB = Number.isFinite(tsB) ? tsB : (dir === -1 ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY);
      if (safeA !== safeB) {
        return (safeA - safeB) * dir;
      }
      const cmpName = DASHBOARD_COLLATOR.compare(nameA, nameB);
      if (cmpName !== 0) return cmpName;
      return DASHBOARD_COLLATOR.compare(idA, idB);
    }
    if (sortKey === "id") {
      const cmpId = DASHBOARD_COLLATOR.compare(idA, idB);
      if (cmpId !== 0) return cmpId * dir;
      return DASHBOARD_COLLATOR.compare(nameA, nameB);
    }
    const cmpName = DASHBOARD_COLLATOR.compare(nameA, nameB);
    if (cmpName !== 0) return cmpName * dir;
    const cmpId = DASHBOARD_COLLATOR.compare(idA, idB);
    if (cmpId !== 0) return cmpId * dir;
    return 0;
  });
  return data;
}

function jumpToDashboardInitial(label) {
  if (!label || dashboardState.sortKey !== "name") return;
  dashboardState.activeInitial = label;
  if (!dashboardState.collapsedSections || typeof dashboardState.collapsedSections !== "object") {
    dashboardState.collapsedSections = {};
  }
  dashboardState.collapsedSections[label] = false;
  dashboardState.pendingScrollLabel = label;
  saveDashboardCollapsedSections();
  renderDashboard();
}

function toHalfDigits(s) {
  return String(s || "").replace(/[０-９]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));
}

let initialMemberId = (() => {
  const raw = queryParams.get("id") || "";
  if (!raw) return "";
  const half = toHalfDigits(raw.trim());
  if (!half) return "";
  if (/^\d{1,4}$/.test(half)) return ("0000" + half).slice(-4);
  return "";
})();

function escapeHtml(value) {
  const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };
  return String(value ?? "").replace(/[&<>"']/g, ch => map[ch]);
}

function callGoogle(functionName, ...args) {
  return new Promise((resolve, reject) => {
    try {
      const runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(err => reject(err));
      runner[functionName](...args);
    } catch (e) {
      reject(e);
    }
  });
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = String(reader.result || "");
      const base64 = result.includes(",") ? result.split(",")[1] : result;
      resolve({
        base64,
        mimeType: file.type || "application/octet-stream",
        name: file.name || "attachment"
      });
    };
    reader.onerror = () => reject(reader.error || new Error("ファイルの読み込みに失敗しました"));
    reader.readAsDataURL(file);
  });
}

function getRecordTimestamp(record) {
  if (record && typeof record.timestamp === "number" && !isNaN(record.timestamp)) {
    return record.timestamp;
  }
  if (record && record.date instanceof Date && !isNaN(record.date.getTime())) {
    return record.date.getTime();
  }
  const raw = record && (record.dateValue || record.dateText || record.date);
  const parsed = raw ? Date.parse(raw) : NaN;
  return isNaN(parsed) ? null : parsed;
}

function normalizeRecord(record) {
  const attachments = Array.isArray(record.attachments) ? record.attachments : [];
  return {
    ...record,
    attachments,
    timestamp: getRecordTimestamp(record)
  };
}

function buildAttachmentViewUrl(att) {
  if (!att) return "#";
  if (att.url) return att.url;
  if (att.fileId) return "https://drive.google.com/file/d/" + att.fileId + "/view";
  return "#";
}

function buildAttachmentThumbnailUrl(att) {
  if (!att) return "";
  if (att.fileId) {
    return "https://drive.google.com/thumbnail?id=" + att.fileId + "&sz=w200";
  }
  return "";
}

function refreshMemberList() {
  google.script.run.withSuccessHandler(list => {
    memberList = Array.isArray(list) ? list : [];
    if (initialMemberId && !memberId) {
      const hit = memberList.find(m => m.id === initialMemberId);
      if (hit) {
        selectMember(hit.id, hit.name);
        initialMemberId = "";
      } else if (/^\d{4}$/.test(initialMemberId)) {
        selectMember(initialMemberId, "");
        initialMemberId = "";
      }
    }
  }).withFailureHandler(err => {
    console.error("member list error", err);
  }).getMemberList();
}

function loadDashboard() {
  const statusEl = document.getElementById("dashboardStatus");
  const container = document.getElementById("dashboardTable");
  if (statusEl) statusEl.textContent = "読込中…";
  if (container) container.innerHTML = "";
  callGoogle("getDashboardSummary").then(res => {
    if (!res || res.status !== "success") {
      if (statusEl) statusEl.textContent = "エラー: " + (res && res.message ? res.message : "取得に失敗しました");
      dashboardState.data = [];
      dashboardState.monthLabel = "";
      dashboardState.activeInitial = null;
      if (container) container.innerHTML = "";
      return;
    }
    dashboardState.data = Array.isArray(res.data) ? res.data : [];
    dashboardState.monthLabel = res.monthLabel || "";
    dashboardState.activeInitial = null;
    renderDashboard();
  }).catch(err => {
    console.error("dashboard error", err);
    if (statusEl) statusEl.textContent = "エラー: " + (err && err.message ? err.message : err);
    dashboardState.data = [];
    dashboardState.monthLabel = "";
    dashboardState.activeInitial = null;
  });
}

function renderDashboard() {
  const container = document.getElementById("dashboardTable");
  const filterContainer = document.getElementById("dashboardFilters");
  const indexContainer = document.getElementById("dashboardIndex");
  const statusEl = document.getElementById("dashboardStatus");
  if (!container) return;

  const sortedData = getSortedDashboardData();
  const careManagerOptions = getDashboardCareManagerOptions(sortedData);
  if (!dashboardState.filters || typeof dashboardState.filters !== "object") {
    dashboardState.filters = { status: "all", careManagers: [] };
  }
  const validStatus = ["all", "pending", "completed"];
  if (!validStatus.includes(dashboardState.filters.status)) {
    dashboardState.filters.status = "all";
  }
  if (!Array.isArray(dashboardState.filters.careManagers)) {
    dashboardState.filters.careManagers = [];
  }
  const normalizedCare = dashboardState.filters.careManagers.filter(name => careManagerOptions.includes(name));
  if (normalizedCare.length !== dashboardState.filters.careManagers.length) {
    dashboardState.filters.careManagers = normalizedCare;
  }

  const filteredData = applyDashboardFilters(sortedData);
  const showIndexNav = dashboardState.sortKey === "name";
  const indexGroups = showIndexNav ? getDashboardIndexGroups(filteredData) : [];
  const sections = buildDashboardSections(filteredData);

  if (!dashboardState.collapsedSections || typeof dashboardState.collapsedSections !== "object") {
    dashboardState.collapsedSections = {};
  }
  let collapseChanged = false;
  sections.forEach(section => {
    if (!(section.label in dashboardState.collapsedSections)) {
      dashboardState.collapsedSections[section.label] = true;
      collapseChanged = true;
    }
  });
  Object.keys(dashboardState.collapsedSections).forEach(label => {
    if (!sections.some(section => section.label === label)) {
      delete dashboardState.collapsedSections[label];
      collapseChanged = true;
    }
  });
  if (memberId) {
    const targetSection = sections.find(section => section.entries.some(entry => entry && entry.id === memberId));
    if (targetSection) {
      if (dashboardState.collapsedSections[targetSection.label] !== false) {
        dashboardState.collapsedSections[targetSection.label] = false;
        collapseChanged = true;
      }
      if (!dashboardState.pendingScrollLabel && dashboardState.activeInitial !== targetSection.label) {
        dashboardState.activeInitial = targetSection.label;
      }
    }
  }
  if (collapseChanged) {
    saveDashboardCollapsedSections();
  }

  if (!dashboardState.activeInitial || !sections.some(section => section.label === dashboardState.activeInitial)) {
    dashboardState.activeInitial = sections.length ? sections[0].label : null;
  }

  if (statusEl) {
    const monthLabel = dashboardState.monthLabel ? `対象月：${dashboardState.monthLabel}` : "";
    const countLabel = `${filteredData.length}名 / 全${sortedData.length}名`;
    statusEl.textContent = monthLabel ? `${monthLabel}（${countLabel}）` : countLabel;
  }

  if (filterContainer) {
    const sortOptions = [
      { value: "name:asc", label: "氏名（あ→ん順）" },
      { value: "name:desc", label: "氏名（ん→あ順）" },
      { value: "latest:desc", label: "最新記録日（新しい順）" },
      { value: "latest:asc", label: "最新記録日（古い順）" },
      { value: "id:asc", label: "ID（昇順）" },
      { value: "id:desc", label: "ID（降順）" }
    ];
    const sortValue = `${dashboardState.sortKey}:${dashboardState.sortDir}`;
    const sortHtml = sortOptions.map(opt => `<option value="${opt.value}"${opt.value === sortValue ? " selected" : ""}>${opt.label}</option>`).join("");

    const statusOptions = [
      { value: "all", label: "すべて" },
      { value: "pending", label: "モニタリング未実施" },
      { value: "completed", label: "モニタリング実施済み" }
    ];
    const statusHtml = statusOptions.map(opt => `<option value="${opt.value}"${opt.value === dashboardState.filters.status ? " selected" : ""}>${opt.label}</option>`).join("");

    const chipsHtml = careManagerOptions.length
      ? careManagerOptions.map(name => {
          const active = dashboardState.filters.careManagers.includes(name);
          return `<button type="button" class="dashboard-chip${active ? " active" : ""}" data-care="${escapeHtml(name)}" aria-pressed="${active}">${escapeHtml(name)}</button>`;
        }).join("")
      : `<div class="dashboard-index-note">担当者情報が未登録です</div>`;

    filterContainer.innerHTML = `
      <div class="dashboard-filter-row">
        <div class="dashboard-filter">
          <label for="dashboardSortSelect">並び替え</label>
          <select id="dashboardSortSelect">${sortHtml}</select>
        </div>
        <div class="dashboard-filter">
          <label for="dashboardStatusFilter">モニタリング状況</label>
          <select id="dashboardStatusFilter">${statusHtml}</select>
        </div>
        <div class="dashboard-filter">
          <label>担当ケアマネ</label>
          <div class="dashboard-care-chips">
            ${chipsHtml}
          </div>
        </div>
        <button type="button" id="dashboardClearFilters" class="secondary btn-compact">フィルタをクリア</button>
      </div>
      <div class="dashboard-filter-summary">絞り込み：${filteredData.length}名 / 全${sortedData.length}名</div>
    `;
  }

  if (!filteredData.length) {
    container.innerHTML = '<div class="muted">該当する利用者がいません。</div>';
  } else {
    container.innerHTML = sections.map(section => {
      const sectionId = getDashboardSectionDomId(section.label);
      const collapsed = dashboardState.collapsedSections[section.label] !== false;
      const isOpen = !collapsed;
      const headerHtml = `
        <button type="button" class="dashboard-section-toggle${isOpen ? " is-open" : ""}" data-section="${escapeHtml(section.label)}" aria-expanded="${isOpen}" aria-controls="${sectionId}-body">
          <span>${escapeHtml(section.label)}</span>
          <span class="dashboard-section-count">${section.entries.length}名</span>
        </button>
      `;
      const rows = section.entries.map(entry => {
        const statusKey = entry && entry.monitoringStatus === "completed" ? "completed" : "pending";
        const statusText = statusKey === "completed" ? "モニタリング実施済み" : "モニタリング未実施";
        const statusIcon = statusKey === "completed" ? "✅" : "⚠️";
        const safeId = escapeHtml(entry.id || "");
        const safeNameAttr = escapeHtml(entry.name || "");
        const displayName = entry.name ? escapeHtml(entry.name) : "（氏名未登録）";
        const latest = entry.latestDateText ? escapeHtml(entry.latestDateText) : "---";
        const careRaw = String(entry.careManager || "").trim();
        const careParts = parseCareManagerList(careRaw);
        const careLabel = careParts.length
          ? careParts.map(part => escapeHtml(part)).join('／')
          : '<span class="muted">担当未設定</span>';
        const count = Number(entry.countThisMonth || 0);
        const link = `?id=${encodeURIComponent(entry.id || "")}`;
        const selected = memberId && entry.id === memberId ? " selected" : "";
        return `
          <div class="dashboard-entry status-${statusKey}${selected}">
            <div class="dashboard-entry-main">
              <div class="dashboard-entry-name">
                <span>${displayName}</span>
                <span class="dashboard-entry-id">${safeId}</span>
              </div>
              <div class="dashboard-entry-meta">
                <span>担当：${careLabel}</span>
                <span>最新記録：${latest}</span>
                <span>今月：${count}件</span>
              </div>
            </div>
            <div class="dashboard-entry-actions">
              <span class="dashboard-status-badge ${statusKey}">${statusIcon} ${statusText}</span>
              <button class="secondary btn-compact dashboard-select" data-id="${safeId}" data-name="${safeNameAttr}">表示</button>
              <a class="link-button" href="${link}">詳細</a>
            </div>
          </div>
        `;
      }).join("");
      return `
        <section class="dashboard-section" id="${sectionId}" data-section-label="${escapeHtml(section.label)}">
          ${headerHtml}
          <div class="dashboard-section-body${isOpen ? " is-open" : ""}" id="${sectionId}-body">
            ${rows}
          </div>
        </section>
      `;
    }).join("");
  }

  if (indexContainer) {
    if (!showIndexNav) {
      indexContainer.innerHTML = `<div class="dashboard-index-note">氏名順ソート時にジャンプが利用できます</div>`;
    } else if (!indexGroups.length) {
      indexContainer.innerHTML = `<div class="dashboard-index-empty">該当なし</div>`;
    } else {
      indexContainer.innerHTML = indexGroups.map(label => {
        const sectionId = getDashboardSectionDomId(label);
        const active = dashboardState.activeInitial === label ? " active" : "";
        return `<button type="button" class="dashboard-index-btn${active}" data-index="${escapeHtml(label)}" data-target="${sectionId}">${escapeHtml(label)}</button>`;
      }).join("");
    }
  }

  bindDashboardActions();
  bindDashboardUi();
  updateDashboardFilterQueryParams();

  if (dashboardState.pendingScrollLabel) {
    const scrollId = getDashboardSectionDomId(dashboardState.pendingScrollLabel);
    requestAnimationFrame(() => {
      const target = document.getElementById(scrollId);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
    dashboardState.pendingScrollLabel = null;
  }
}

function bindDashboardUi() {
  const filterContainer = document.getElementById("dashboardFilters");
  if (filterContainer) {
    if (!dashboardState.filters || typeof dashboardState.filters !== "object") {
      dashboardState.filters = { status: "all", careManagers: [] };
    }
    const validStatus = ["all", "pending", "completed"];
    const sortSelect = filterContainer.querySelector("#dashboardSortSelect");
    if (sortSelect) {
      sortSelect.onchange = (event) => {
        const raw = String(event.target.value || "");
        const [key, dir] = raw.split(":");
        dashboardState.sortKey = key || "name";
        dashboardState.sortDir = dir === "desc" ? "desc" : "asc";
        dashboardState.activeInitial = null;
        renderDashboard();
      };
    }
    const statusSelect = filterContainer.querySelector("#dashboardStatusFilter");
    if (statusSelect) {
      statusSelect.onchange = (event) => {
        const value = String(event.target.value || "all");
        dashboardState.filters.status = validStatus.includes(value) ? value : "all";
        renderDashboard();
      };
    }
    filterContainer.querySelectorAll(".dashboard-chip").forEach(btn => {
      const name = btn.dataset.care || "";
      btn.onclick = () => {
        if (!name) return;
        const current = Array.isArray(dashboardState.filters.careManagers) ? dashboardState.filters.careManagers.slice() : [];
        const idx = current.indexOf(name);
        if (idx >= 0) {
          current.splice(idx, 1);
        } else {
          current.push(name);
        }
        dashboardState.filters.careManagers = current;
        renderDashboard();
      };
    });
    const clearBtn = filterContainer.querySelector("#dashboardClearFilters");
    if (clearBtn) {
      clearBtn.onclick = () => {
        dashboardState.filters = { status: "all", careManagers: [] };
        renderDashboard();
      };
    }
  }

  const container = document.getElementById("dashboardTable");
  if (container) {
    container.querySelectorAll(".dashboard-section-toggle").forEach(btn => {
      const label = btn.dataset.section || "";
      btn.onclick = () => {
        if (!label) return;
        if (!dashboardState.collapsedSections || typeof dashboardState.collapsedSections !== "object") {
          dashboardState.collapsedSections = {};
        }
        const collapsed = dashboardState.collapsedSections[label] !== false;
        if (collapsed) {
          dashboardState.collapsedSections[label] = false;
          dashboardState.activeInitial = label;
        } else {
          dashboardState.collapsedSections[label] = true;
        }
        saveDashboardCollapsedSections();
        renderDashboard();
      };
    });
  }

  const nav = document.getElementById("dashboardIndex");
  if (nav) {
    nav.querySelectorAll(".dashboard-index-btn").forEach(btn => {
      const label = btn.dataset.index || "";
      btn.onclick = () => { jumpToDashboardInitial(label); };
    });
  }
}

function bindDashboardActions() {
  document.querySelectorAll(".dashboard-select").forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.id || "";
      const name = btn.dataset.name || "";
      selectMember(toHalfDigits(id), name);
    };
  });
}

const input = document.getElementById("memberIdInput");
const listBox = document.getElementById("autocompleteList");

function setupSearchBox() {
  if (!input || !listBox) return;
  input.addEventListener("input", () => {
    const qRaw = input.value.trim();
    if (!qRaw) { listBox.style.display = "none"; return; }
    const q = toHalfDigits(qRaw);
    const hits = memberList.filter(m => m.id.includes(q) || m.name.includes(qRaw));
    if (!hits.length) { listBox.style.display = "none"; return; }
    listBox.innerHTML = hits.map(m => `<div class="autocomplete-item" data-id="${m.id}" data-name="${escapeHtml(m.name)}">${m.id}　${escapeHtml(m.name)}</div>`).join("");
    listBox.style.display = "block";
  });
  listBox.addEventListener("click", e => {
    const item = e.target.closest(".autocomplete-item");
    if (!item) return;
    selectMember(item.dataset.id, item.dataset.name);
  });
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); resolveInput(); }
  });
  input.addEventListener("blur", () => { setTimeout(resolveInput, 100); });
}

function resolveInput() {
  const val = input.value.trim();
  if (!val) return;
  const half = toHalfDigits(val);
  const hit = memberList.find(m => m.id === half || m.name === val);
  if (hit) { selectMember(hit.id, hit.name); return; }
  if (/^\d{4}$/.test(half)) { selectMember(half, ""); return; }
  document.getElementById("idStatus").textContent = "候補が見つかりません";
}

function selectMember(id, name) {
  memberId = id;
  memberName = name || "";
  if (input) input.value = `${id}${memberName ? "　" + memberName : ""}`;
  if (listBox) listBox.style.display = "none";
  document.getElementById("idStatus").textContent = `選択中: ${id}${memberName ? "　" + memberName : ""}`;
  document.getElementById("memberTag").textContent = `${id}${memberName ? "　" + memberName : ""}`;
  document.getElementById("mainArea").style.display = "";
  document.getElementById("filterKind").value = "all";
  document.getElementById("filterDateFrom").value = "";
  document.getElementById("filterDateTo").value = "";
  document.getElementById("filterText").value = "";
  document.getElementById("summaryOutput").textContent = "ここに要約が表示されます";
  document.getElementById("adviceOutput").textContent = "ここに提案が表示されます";
  updateMediaGallery([]);
  closeShareForm();
  resetShareListPlaceholder();
  renderDashboard();
  loadRecords();
  fetchExternalShareList();
}

function setupMemberUi() {
  const btnAddMember = document.getElementById("btnAddMember");
  if (btnAddMember) {
    btnAddMember.onclick = () => {
      const idInput = document.getElementById("newMemberId");
      const nameInput = document.getElementById("newMemberName");
      const id = idInput.value.trim();
      const name = nameInput.value.trim();
      const status = document.getElementById("addMemberStatus");
      if (!id || !name) { status.textContent = "IDと氏名を入力してください"; return; }
      google.script.run.withSuccessHandler(res => {
        if (res.status === "success") {
          status.textContent = `登録しました: ${res.id} ${res.name}`;
          idInput.value = "";
          nameInput.value = "";
          refreshMemberList();
          loadDashboard();
        } else {
          status.textContent = "失敗: " + res.message;
        }
      }).withFailureHandler(err => {
        status.textContent = "エラー: " + (err && err.message ? err.message : err);
      }).addMember(id, name);
    };
  }

  const btnSave = document.getElementById("btnSave");
  if (btnSave) {
    btnSave.addEventListener("click", handleSave);
  }

  const btnSummary = document.getElementById("btnSummary");
  if (btnSummary) {
    btnSummary.onclick = () => {
      if (!memberId) { alert("利用者を選択してください"); return; }
      const fmt = document.getElementById("summaryFormat").value;
      const days = document.getElementById("recordRange").value;
      const out = document.getElementById("summaryOutput");
      out.textContent = "生成中…";
      google.script.run.withSuccessHandler(res => {
        out.textContent = (res.status === "success") ? res.summary : ("失敗:" + res.message);
      }).withFailureHandler(err => {
        out.textContent = "失敗: " + (err && err.message ? err.message : err);
      }).generateAISummaryForDays(memberId, fmt, days);
    };
  }

  const btnAdvice = document.getElementById("btnAdvice");
  if (btnAdvice) {
    btnAdvice.onclick = () => {
      if (!memberId) { alert("利用者を選択してください"); return; }
      const horizon = document.getElementById("adviceHorizonSelect").value;
      const days = document.getElementById("recordRange").value;
      const out = document.getElementById("adviceOutput");
      out.textContent = "生成中…";
      google.script.run.withSuccessHandler(res => {
        out.textContent = (res.status === "success") ? res.advice : ("失敗:" + res.message);
      }).withFailureHandler(err => {
        out.textContent = "失敗: " + (err && err.message ? err.message : err);
      }).generateCareAdviceWithHorizon(memberId, days, horizon);
    };
  }

  const btnReload = document.getElementById("btnReload");
  if (btnReload) {
    btnReload.onclick = () => loadRecords();
  }

  const range = document.getElementById("recordRange");
  if (range) {
    range.addEventListener("change", () => {
      if (memberId) loadRecords();
    });
  }
}

async function handleSave() {
  const text = document.getElementById("inputText").value.trim();
  const files = Array.from(document.getElementById("fileInput").files || []);
  const status = document.getElementById("saveStatus");
  if (!memberId) { alert("利用者を選択してください"); return; }
  if (!text && files.length === 0) { alert("内容または添付を入力してください"); return; }
  status.textContent = "送信中…";
  try {
    const kind = document.getElementById("kindSelect").value;
    const attachmentsMeta = [];
    for (const file of files) {
      const payload = await readFileAsBase64(file);
      const uploadRes = await callGoogle("uploadAttachment_", memberId, payload.name, payload.mimeType, payload.base64);
      if (!uploadRes || uploadRes.status !== "success") {
        throw new Error(uploadRes && uploadRes.message ? uploadRes.message : "添付ファイルのアップロードに失敗しました");
      }
      attachmentsMeta.push({
        fileId: uploadRes.fileId,
        url: uploadRes.url,
        name: uploadRes.name || payload.name,
        mimeType: uploadRes.mimeType || payload.mimeType
      });
    }
    await callGoogle("saveRecordFromBrowser", memberId, text, new Date().toISOString(), JSON.stringify(attachmentsMeta), kind);
    status.textContent = "保存しました";
    document.getElementById("inputText").value = "";
    document.getElementById("fileInput").value = "";
    setTimeout(() => { status.textContent = ""; }, 3000);
    loadRecords();
    loadDashboard();
  } catch (err) {
    status.textContent = "失敗: " + (err && err.message ? err.message : err);
  }
}

  function loadRecords() {
    const days = document.getElementById("recordRange").value;
    const list = document.getElementById("recordList");
    if (!memberId) {
      list.textContent = "利用者を選択してください";
      recordsCache = [];
      updateMediaGallery([]);
      updateShareAttachmentOptions([]);
      return;
    }
    list.textContent = "読込中…";
    google.script.run.withSuccessHandler(res => {
      if (!res || res.status !== "success") {
        list.textContent = "エラー:" + (res && res.message ? res.message : "取得に失敗しました");
        recordsCache = [];
        updateMediaGallery([]);
        updateShareAttachmentOptions([]);
        return;
      }
      recordsCache = (res.records || []).map(normalizeRecord);
      renderRecords();
      updateShareAttachmentOptions(recordsCache);
    }).withFailureHandler(err => {
      list.textContent = "エラー: " + (err && err.message ? err.message : err);
      recordsCache = [];
      updateMediaGallery([]);
      updateShareAttachmentOptions([]);
    }).getRecordsByMemberId_v3(memberId, days);
  }

  function renderRecords() {
  const list = document.getElementById("recordList");
  if (!memberId) {
    list.textContent = "利用者を選択してください";
    updateMediaGallery([]);
    return;
  }
  if (!recordsCache.length) {
    list.textContent = "記録なし";
    updateMediaGallery([]);
    return;
  }
  const filtered = filterRecords(recordsCache);
  if (!filtered.length) {
    list.textContent = "条件に一致する記録がありません";
    updateMediaGallery([]);
    return;
  }
  const html = filtered.map((r, idx) => {
    const text = escapeHtml(r.text || "").replace(/\n/g, "<br>");
    const attachmentsHtml = (r.attachments && r.attachments.length)
      ? `<div class="attachments">${r.attachments.map((att, i) => renderAttachment(att, r, i)).join("")}</div>`
      : "";
    return `<div class="record" data-row="${r.rowIndex}">
      <div><b>${escapeHtml(r.dateText || "")}</b>【${escapeHtml(r.kind || "")}】</div>
      <div class="text">${text || '<span class="muted">（本文なし）</span>'}</div>
      ${attachmentsHtml}
      <div class="toolbar">
        <button class="secondary btnEdit">編集</button>
        <button class="danger btnDelete">削除</button>
      </div>
    </div>`;
  }).join("");
  list.innerHTML = html;
  bindRecordActions();
  updateMediaGallery(filtered);
}

function renderAttachment(att, record, index) {
  const url = escapeHtml(buildAttachmentViewUrl(att));
  const label = escapeHtml(att && att.name ? att.name : `添付${index + 1}`);
  return `<a href="${url}" target="_blank" rel="noopener">📎 ${label}</a>`;
}

function filterRecords(records) {
  const kind = document.getElementById("filterKind").value;
  const text = document.getElementById("filterText").value.trim().toLowerCase();
  const fromVal = document.getElementById("filterDateFrom").value;
  const toVal = document.getElementById("filterDateTo").value;
  const fromTime = fromVal ? new Date(fromVal + "T00:00:00").getTime() : null;
  const toTime = toVal ? new Date(toVal + "T23:59:59").getTime() : null;
  return records.filter(r => {
    const ts = getRecordTimestamp(r);
    if (kind && kind !== "all" && String(r.kind) !== kind) return false;
    if (fromTime && (ts === null || ts < fromTime)) return false;
    if (toTime && (ts === null || ts > toTime)) return false;
    if (text) {
      const hay = `${(r.text || "").toLowerCase()} ${(r.kind || "").toLowerCase()}`;
      if (!hay.includes(text)) return false;
    }
    return true;
  }).sort((a, b) => (getRecordTimestamp(b) || 0) - (getRecordTimestamp(a) || 0));
}

function updateMediaGallery(records) {
  const gallery = document.getElementById("mediaGallery");
  if (!records || !records.length) {
    gallery.textContent = "添付ファイルはありません";
    return;
  }
  const items = [];
  records.forEach(r => {
    if (Array.isArray(r.attachments)) {
      r.attachments.forEach(att => items.push({ attachment: att, record: r }));
    }
  });
  if (!items.length) {
    gallery.textContent = "添付ファイルはありません";
    return;
  }
  const cards = items.map(item => {
    const att = item.attachment || {};
    const rec = item.record || {};
    const viewUrl = escapeHtml(buildAttachmentViewUrl(att));
    const thumbUrlRaw = buildAttachmentThumbnailUrl(att);
    const thumbUrl = thumbUrlRaw ? escapeHtml(thumbUrlRaw) : "";
    const isImage = att.mimeType && att.mimeType.indexOf("image/") === 0;
    const preview = (isImage && thumbUrl)
      ? `<img src="${thumbUrl}" alt="${escapeHtml(att.name || "添付ファイル")}のサムネイル">`
      : `<div class="media-icon">📎</div>`;
    return `<div class="media-card">
      <a href="${viewUrl}" target="_blank" rel="noopener">
        ${preview}
        <div class="media-meta">
          <div class="name">${escapeHtml(att.name || "添付ファイル")}</div>
          <div>${escapeHtml(rec.dateText || "")}</div>
        </div>
      </a>
    </div>`;
  }).join("");
  gallery.innerHTML = `<div class="media-grid">${cards}</div>`;
}

// ===== 過去記録（編集・削除付き） =====
function loadRecords(){
  const days=document.getElementById("recordRange").value;
  const list=document.getElementById("recordList");
  if(!memberId){
    list.textContent="利用者を選択してください";
    setGalleryMessage("利用者を選択してください");
    return;
  }
  list.textContent="読込中…";
  setGalleryMessage("添付を読み込んでいます…");
  google.script.run.withSuccessHandler(res=>{
    if(res.status!=="success"){
      list.textContent="エラー:"+(res.message||"不明なエラー");
      setGalleryMessage("添付ファイルを読み込めませんでした");
      return;
    }
    const records=Array.isArray(res.records)?res.records:[];
    renderMediaGallery(records);
    if(!records.length){
      list.textContent="記録なし";
      return;
    }
    list.innerHTML=records.map(r=>
      `<div class="record" data-row="${r.rowIndex}">
        <div><b>${r.dateText}</b>【${r.kind}】</div>
        <div class="text">${r.text}</div>
        <div class="toolbar">
          <button class="secondary btnEdit">編集</button>
          <button class="danger btnDelete">削除</button>
        </div>
      </div>`
    ).join("");
    bindRecordActions();
  }).withFailureHandler(err=>{
    const msg=(err&&err.message)||err||"不明なエラー";
    list.textContent="エラー:"+msg;
    setGalleryMessage("添付ファイルを読み込めませんでした");
  }).getRecordsByMemberId_v3(memberId,days);
}

function bindRecordActions() {
  document.querySelectorAll(".btnEdit").forEach(btn => {
    btn.onclick = () => {
      const rec = btn.closest(".record");
      if (!rec) return;
      const row = rec.dataset.row;
      const textEl = rec.querySelector(".text");
      const oldText = textEl ? textEl.textContent : "";
      const nv = prompt("内容を修正:", oldText);
      if (nv === null) return;
      google.script.run.withSuccessHandler(() => {
        loadRecords();
      }).withFailureHandler(err => {
        alert("更新に失敗しました: " + (err && err.message ? err.message : err));
      }).updateRecord(row, nv);
    };
  });
  document.querySelectorAll(".btnDelete").forEach(btn => {
    btn.onclick = () => {
      const rec = btn.closest(".record");
      if (!rec) return;
      const row = rec.dataset.row;
      if (!confirm("この記録を削除しますか？")) return;
      google.script.run.withSuccessHandler(() => {
        loadRecords();
        loadDashboard();
      }).withFailureHandler(err => {
        alert("削除に失敗しました: " + (err && err.message ? err.message : err));
      }).deleteRecord(row);
    };
  });
}


  function setupFilters() {
    ["filterKind", "filterDateFrom", "filterDateTo"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", () => { renderRecords(); });
      }
    });
    const text = document.getElementById("filterText");
    if (text) {
      text.addEventListener("input", () => { renderRecords(); });
    }
    const clear = document.getElementById("btnClearFilters");
    if (clear) {
      clear.addEventListener("click", () => {
        const kindEl = document.getElementById("filterKind");
        const fromEl = document.getElementById("filterDateFrom");
        const toEl = document.getElementById("filterDateTo");
        const textEl = document.getElementById("filterText");
        if (kindEl) kindEl.value = "all";
        if (fromEl) fromEl.value = "";
        if (toEl) toEl.value = "";
        if (textEl) textEl.value = "";
        renderRecords();
      });
    }
  }

function setGalleryMessage(message){
  const gallery=document.getElementById("mediaGallery");
  if(!gallery) return;
  gallery.classList.add("muted");
  gallery.innerHTML="";
  gallery.textContent=message;
}

function renderMediaGallery(records){
  const gallery=document.getElementById("mediaGallery");
  if(!gallery) return;
  gallery.innerHTML="";
  const attachments=[];
  (Array.isArray(records)?records:[]).forEach(record=>{
    if(!record) return;
    const files=Array.isArray(record.attachments)?record.attachments:[];
    files.forEach(att=>{
      if(att==null) return;
      const normalized=(typeof att==="object" && !Array.isArray(att))?{...att}:{ name:String(att)};
      normalized.recordDate=record.dateText;
      attachments.push(normalized);
    });
  });
  if(!attachments.length){
    setGalleryMessage("添付ファイルはありません");
    return;
  }
  gallery.classList.remove("muted");
  const container=document.createElement("div");
  container.className="media-grid";
  attachments.sort((a,b)=>{
    const tb=getAttachmentTime(b);
    const ta=getAttachmentTime(a);
    if(isNaN(ta) && isNaN(tb)) return 0;
    if(isNaN(ta)) return 1;
    if(isNaN(tb)) return -1;
    return tb-ta;
  });
  attachments.forEach(att=>{
    const item=document.createElement("div");
    item.className="media-item";
    const label=att.name||att.fileName||att.title||att.displayName||"名称未設定のファイル";
    if(att.url){
      const link=document.createElement("a");
      link.href=att.url;
      link.target="_blank";
      link.rel="noopener noreferrer";
      link.textContent=label;
      item.appendChild(link);
    }else{
      const span=document.createElement("span");
      span.className="media-missing";
      span.textContent=label;
      item.appendChild(span);
    }
    const metaParts=[];
    const uploadedLabel=formatDateTime(att.uploadedAt||att.createdAt||att.timestamp);
    if(uploadedLabel){
      metaParts.push(`アップロード: ${uploadedLabel}`);
    }else if(att.recordDate){
      metaParts.push(`記録日: ${att.recordDate}`);
    }
    if(att.mimeType) metaParts.push(att.mimeType);
    if(!att.url) metaParts.push("リンク情報なし");
    if(metaParts.length){
      const meta=document.createElement("div");
      meta.className="media-meta";
      meta.textContent=metaParts.join(" ｜ ");
      item.appendChild(meta);
    }
    container.appendChild(item);
  });
  gallery.appendChild(container);
}

function getAttachmentTime(att){
  if(!att) return NaN;
  const candidate=att.uploadedAt||att.createdAt||att.timestamp||att.recordDate;
  return toTime(candidate);
}

function toTime(value){
  if(!value) return NaN;
  const d=new Date(value);
  const t=d.getTime();
  return Number.isNaN(t)?NaN:t;
}

function formatDateTime(value){
  const t=toTime(value);
  if(Number.isNaN(t)) return "";
  const d=new Date(t);
  const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function collectAttachmentOptions(records){
  const map=new Map();
  (Array.isArray(records)?records:[]).forEach(record=>{
    if(!record) return;
    const ts=getRecordTimestamp(record);
    const files=Array.isArray(record.attachments)?record.attachments:[];
    files.forEach(att=>{
      if(!att || typeof att!=="object" || Array.isArray(att)) return;
      const fileId=String(att.fileId||att.id||"").trim();
      if(!fileId || map.has(fileId)) return;
      map.set(fileId,{
        fileId,
        name:att.name||att.fileName||att.title||"添付ファイル",
        recordDate:record.dateText||"",
        uploadedAt:att.uploadedAt||att.createdAt||att.timestamp||"",
        mimeType:att.mimeType||"",
        timestamp:ts||toTime(att.uploadedAt||att.createdAt||att.timestamp)
      });
    });
  });
  return Array.from(map.values()).sort((a,b)=>{
    const tb=Number.isFinite(b.timestamp)?b.timestamp:0;
    const ta=Number.isFinite(a.timestamp)?a.timestamp:0;
    if(tb!==ta) return tb-ta;
    return String(a.name||"").localeCompare(String(b.name||""),"ja");
  });
}

function updateShareAttachmentOptions(records){
  if(isExternalMode) return;
  const container=document.getElementById("shareAttachments");
  if(!container) return;
  const data=collectAttachmentOptions(typeof records!=='undefined'?records:recordsCache);
  const shareAll=document.getElementById("shareAttachmentAll");
  if(!data.length){
    container.classList.add("muted");
    container.innerHTML='<div class="share-empty">共有できる添付ファイルはまだありません</div>';
    if(shareAll) shareAll.checked=false;
    return;
  }
  container.classList.remove("muted");
  container.innerHTML=data.map(att=>{
    const detailParts=[];
    if(att.recordDate) detailParts.push(`記録日: ${escapeHtml(att.recordDate)}`);
    const uploadedLabel=att.uploadedAt?formatDateTime(att.uploadedAt):"";
    if(uploadedLabel) detailParts.push(`アップロード: ${escapeHtml(uploadedLabel)}`);
    if(att.mimeType) detailParts.push(escapeHtml(att.mimeType));
    const detail=detailParts.length?`<span>${detailParts.join(' ｜ ')}</span>`:"";
    return `<label class="share-attachment"><input type="checkbox" data-file-id="${escapeHtml(att.fileId)}"><div class="share-attachment-info"><strong>${escapeHtml(att.name||'添付ファイル')}</strong>${detail}</div></label>`;
  }).join("\n");
  applyShareAllState();
}

function applyShareAllState(){
  if(isExternalMode) return;
  const shareAll=document.getElementById("shareAttachmentAll");
  const container=document.getElementById("shareAttachments");
  if(!container) return;
  const checkboxes=container.querySelectorAll('input[type="checkbox"][data-file-id]');
  const disable=!!(shareAll && shareAll.checked);
  checkboxes.forEach(cb=>{
    cb.disabled=disable;
    if(disable) cb.checked=false;
  });
}

function setupShareUi(){
  if(isExternalMode) return;
  const openBtn=document.getElementById("btnOpenShareForm");
  if(openBtn){
    openBtn.onclick=()=>toggleShareForm(true);
  }
  const cancelBtn=document.getElementById("btnCancelShare");
  if(cancelBtn){
    cancelBtn.onclick=()=>toggleShareForm(false);
  }
  const createBtn=document.getElementById("btnCreateShare");
  if(createBtn){
    createBtn.addEventListener("click",handleCreateShare);
  }
  const shareAll=document.getElementById("shareAttachmentAll");
  if(shareAll){
    shareAll.addEventListener("change",applyShareAllState);
  }
  const list=document.getElementById("shareList");
  if(list){
    list.addEventListener("click",handleShareListClick);
  }
}

function toggleShareForm(open){
  if(isExternalMode) return;
  const form=document.getElementById("shareForm");
  if(!form) return;
  shareFormOpen=!!open;
  form.style.display=shareFormOpen?"":"none";
  const status=document.getElementById("shareFormStatus");
  if(status) status.textContent="";
  if(shareFormOpen){
    updateShareAttachmentOptions(recordsCache);
  }else{
    const expires=document.getElementById("shareExpires");
    const password=document.getElementById("sharePassword");
    const mask=document.getElementById("shareMaskCheckbox");
    const shareAll=document.getElementById("shareAttachmentAll");
    if(expires) expires.value="";
    if(password) password.value="";
    if(mask) mask.checked=true;
    if(shareAll) shareAll.checked=false;
    applyShareAllState();
  }
}

function closeShareForm(){ toggleShareForm(false); }

function resetShareListPlaceholder(){
  if(isExternalMode) return;
  const list=document.getElementById("shareList");
  if(!list) return;
  list.classList.add("muted");
  list.innerHTML="利用者を選択すると共有リンクが表示されます";
}

function fetchExternalShareList(){
  if(isExternalMode) return;
  const list=document.getElementById("shareList");
  if(!memberId){
    externalShares=[];
    resetShareListPlaceholder();
    return;
  }
  if(list){
    list.classList.add("muted");
    list.innerHTML="共有リンクを取得しています…";
  }
  callGoogle("getExternalShares",memberId).then(res=>{
    if(!res || res.status!=="success"){
      if(list){
        const msg=res && res.message ? escapeHtml(res.message) : "取得に失敗しました";
        list.innerHTML=`エラー: ${msg}`;
      }
      return;
    }
    externalShares=Array.isArray(res.shares)?res.shares:[];
    renderShareList();
  }).catch(err=>{
    if(list){
      const msg=err && err.message ? err.message : String(err);
      list.innerHTML=`エラー: ${escapeHtml(msg)}`;
    }
  });
}

function renderShareList(){
  if(isExternalMode) return;
  const list=document.getElementById("shareList");
  if(!list) return;
  if(!externalShares.length){
    list.classList.add("muted");
    list.innerHTML="共有リンクはまだありません";
    return;
  }
  list.classList.remove("muted");
  list.innerHTML=externalShares.map(renderShareItem).join("\n");
}

function renderShareItem(share){
  const expired=!!share.expired;
  const itemClass=expired?"share-item expired":"share-item";
  const badgeLabel=expired?"期限切れ":"共有中";
  const expiresLabel=share.expiresAtText?`期限: ${escapeHtml(share.expiresAtText)}`:"期限: 設定なし";
  const attachmentsLabel=share.allowAllAttachments?"添付: すべて共有":`添付: ${share.allowedCount||0}件`;
  const passwordLabel=share.passwordProtected?"パスワードあり":"パスワードなし";
  const maskLabel=share.maskMode==='simple'?"本文マスクあり":"本文そのまま";
  const lastAccess=share.lastAccessText?`最終閲覧: ${escapeHtml(share.lastAccessText)}`:"";
  const remaining=share.remainingLabel?`有効期間: ${escapeHtml(share.remainingLabel)}`:"";
  const metaParts=[expiresLabel,attachmentsLabel,passwordLabel,maskLabel].concat([remaining,lastAccess].filter(Boolean));
  const metaHtml=metaParts.map(p=>`<span>${p}</span>`).join("\n");
  return `<div class="${itemClass}">`
    + `<div class="share-item-header"><span class="badge">${badgeLabel}</span>`
    + `<div class="share-url"><input type="text" readonly value="${escapeHtml(share.url||'')}" onclick="this.select();">`
    + `<button class="secondary btn-compact" data-action="copy-url" data-url="${escapeHtml(share.url||'')}">URLコピー</button>`
    + `</div></div>`
    + `<div class="tag-group">${metaHtml}</div>`
    + `<div class="share-actions">`
    + `<button class="danger btn-compact" data-action="revoke" data-token="${escapeHtml(share.token||'')}">リンク停止</button>`
    + `</div>`
    + `</div>`;
}

async function handleShareListClick(event){
  if(isExternalMode) return;
  const btn=event.target.closest('[data-action]');
  if(!btn) return;
  const action=btn.dataset.action;
  if(action==='copy-url'){
    const url=btn.dataset.url||"";
    if(!url) return;
    const ok=await copyToClipboard(url);
    if(ok){
      const original=btn.textContent;
      btn.textContent="コピーしました";
      setTimeout(()=>{ btn.textContent=original||"URLコピー"; },1800);
    }else{
      alert("コピーできませんでした。手動で選択してください。");
    }
    return;
  }
  if(action==='revoke'){
    const token=btn.dataset.token||"";
    if(!token) return;
    if(!confirm("この共有リンクを停止しますか？")) return;
    const status=document.getElementById("shareList");
    if(status) status.classList.add("muted");
    try {
      const res=await callGoogle("revokeExternalShare", token);
      if(!res || res.status!=="success"){
        const msg=res && res.message ? res.message : "停止に失敗しました";
        alert(msg);
      }
    } catch(err){
      alert(err && err.message ? err.message : "共有リンクの停止に失敗しました");
    }
    fetchExternalShareList();
  }
}

async function handleCreateShare(event){
  if(event) event.preventDefault();
  if(isExternalMode) return;
  if(!memberId){ alert("利用者を選択してください"); return; }
  const status=document.getElementById("shareFormStatus");
  if(status) status.textContent="共有リンクを発行しています…";
  try {
    const config=collectShareFormConfig();
    const res=await callGoogle("createExternalShare", memberId, config);
    if(!res || res.status!=="success"){
      const msg=res && res.message ? res.message : "共有リンクの発行に失敗しました";
      throw new Error(msg);
    }
    if(status) status.textContent="共有リンクを発行しました。リストからURLをコピーしてください。";
    toggleShareForm(false);
    fetchExternalShareList();
  } catch(err){
    if(status) status.textContent="失敗: " + (err && err.message ? err.message : err);
  }
}

function collectShareFormConfig(){
  const expires=document.getElementById("shareExpires");
  const password=document.getElementById("sharePassword");
  const mask=document.getElementById("shareMaskCheckbox");
  const shareAll=document.getElementById("shareAttachmentAll");
  const attachmentsContainer=document.getElementById("shareAttachments");
  const allowed=[];
  if(shareAll && shareAll.checked){
    allowed.push("__ALL__");
  }else if(attachmentsContainer){
    attachmentsContainer.querySelectorAll('input[type="checkbox"][data-file-id]').forEach(cb=>{
      if(cb.checked) allowed.push(cb.dataset.fileId);
    });
  }
  return {
    expiresAt: expires && expires.value ? convertLocalDateTimeToIso(expires.value) : "",
    password: password ? password.value.trim() : "",
    maskMode: mask && mask.checked ? "simple" : "none",
    allowedAttachmentIds: allowed
  };
}

function convertLocalDateTimeToIso(value){
  if(!value) return "";
  const m=value.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
  if(!m) return "";
  const date=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), Number(m[4]), Number(m[5]));
  if(Number.isNaN(date.getTime())) return "";
  return date.toISOString();
}

function copyToClipboard(text){
  if(!text) return Promise.resolve(false);
  if(navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text).then(()=>true).catch(()=>fallbackCopy(text));
  }
  return fallbackCopy(text);
}

function fallbackCopy(text){
  try {
    const textarea=document.createElement("textarea");
    textarea.value=text;
    textarea.style.position="fixed";
    textarea.style.opacity="0";
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    const ok=document.execCommand("copy");
    document.body.removeChild(textarea);
    return Promise.resolve(ok);
  } catch(_err){
    return Promise.resolve(false);
  }
}

function setupExternalAuth(){
  const form=document.getElementById("externalAuthForm");
  if(form){
    form.addEventListener("submit",e=>{
      e.preventDefault();
      handleExternalAuthSubmit();
    });
  }
}

function initInternalApp(){
  document.body.classList.remove("external-mode");
  setupSearchBox();
  setupMemberUi();
  setupFilters();
  setupShareUi();
  resetShareListPlaceholder();
  refreshMemberList();
  loadDashboard();
}

function initExternalMode(){
  document.body.classList.add("external-mode");
  setupExternalAuth();
  if(!externalToken){
    showExternalAlert("error","共有リンクが見つかりません。管理者にお問い合わせください。");
    return;
  }
  fetchExternalShareMeta();
}

function fetchExternalShareMeta(){
  setExternalLoading("共有設定を確認しています…");
  callGoogle("getExternalShareMeta", externalToken).then(res=>{
    if(!res || res.status!=="success"){
      const msg=res && res.message ? res.message : "共有情報を取得できませんでした";
      showExternalAlert("error", msg);
      setExternalLoading("");
      return;
    }
    const share=res.share||{};
    updateExternalHeader(share);
    if(share.expired){
      showExternalAlert("warning","この共有リンクは期限切れです。最新のリンクを発行してください。");
      showExternalAuthForm(false);
      setExternalLoading("この共有リンクは無効になっています。");
      setExternalFooter(share);
      return;
    }
    showExternalAlert("","");
    if(share.requirePassword){
      showExternalAuthForm(true);
      setExternalLoading("パスワードを入力してください。");
    }else{
      showExternalAuthForm(false);
      loadExternalShareData("");
    }
  }).catch(err=>{
    const msg=err && err.message ? err.message : String(err);
    showExternalAlert("error", msg);
    setExternalLoading("");
  });
}

function showExternalAuthForm(show){
  const auth=document.getElementById("externalAuth");
  if(auth) auth.style.display=show?"":"none";
}

function setExternalLoading(message){
  const recordsEl=document.getElementById("externalRecords");
  if(!recordsEl) return;
  if(message){
    recordsEl.innerHTML=`<div class="external-muted">${escapeHtml(message)}</div>`;
  }else if(!recordsEl.innerHTML.trim()){
    recordsEl.innerHTML="";
  }
}

function showExternalAlert(type,message){
  const alertEl=document.getElementById("externalAlert");
  if(!alertEl) return;
  alertEl.textContent=message?message:"";
  alertEl.classList.remove("error","warning");
  if(!message){
    alertEl.style.display="none";
    return;
  }
  alertEl.style.display="block";
  if(type==='error') alertEl.classList.add("error");
  else if(type==='warning') alertEl.classList.add("warning");
}

function updateExternalHeader(share){
  const memberEl=document.getElementById("externalMember");
  if(memberEl){
    const label=share.memberName?`${share.memberName}（ID: ${share.memberId}）`:`利用者ID: ${share.memberId}`;
    memberEl.textContent=label;
  }
  const expiry=document.getElementById("externalExpiry");
  if(expiry){
    expiry.textContent=share.expiresAtText?`閲覧期限：${share.expiresAtText}`:"閲覧期限：設定なし";
  }
}

function setExternalFooter(share){
  const footer=document.getElementById("externalFooter");
  if(!footer) return;
  const note=share.expired?"※ このリンクは期限切れです。新しいURLを受け取っていない場合は発行元へご連絡ください。":"※ このページのURLとパスワードは第三者に共有しないようご注意ください。";
  footer.textContent=note;
}

function handleExternalAuthSubmit(){
  const passwordInput=document.getElementById("externalPassword");
  const status=document.getElementById("externalAuthStatus");
  const password=passwordInput?passwordInput.value:"";
  if(status) status.textContent="確認中…";
  loadExternalShareData(password).finally(()=>{
    if(passwordInput) passwordInput.value="";
  });
}

function loadExternalShareData(password){
  setExternalLoading("記録を読み込んでいます…");
  return callGoogle("enterExternalShare", externalToken, password||"").then(res=>{
    const status=document.getElementById("externalAuthStatus");
    if(!res || res.status!=="success"){
      const msg=res && res.message ? res.message : "閲覧に失敗しました";
      if(status) status.textContent=msg;
      showExternalAuthForm(true);
      setExternalLoading("");
      return;
    }
    if(status) status.textContent="";
    const share=res.share||{};
    updateExternalHeader(share);
    showExternalAuthForm(false);
    showExternalAlert(share.expired?"warning":"", share.expired?"リンクの期限が切れています。再発行を依頼してください。":"");
    renderExternalRecords(Array.isArray(res.records)?res.records:[]);
    setExternalFooter(share);
  }).catch(err=>{
    const status=document.getElementById("externalAuthStatus");
    if(status) status.textContent=err && err.message ? err.message : "閲覧に失敗しました";
    setExternalLoading("");
  });
}

function renderExternalRecords(records){
  const container=document.getElementById("externalRecords");
  if(!container) return;
  if(!records.length){
    container.innerHTML='<div class="external-muted">共有可能な記録はまだありません。</div>';
    return;
  }
  container.innerHTML=records.map(rec=>{
    const text=escapeHtml(rec.text||"").replace(/\n/g,"<br>") || '<span class="external-muted">（本文なし）</span>';
    const attachments=Array.isArray(rec.attachments)?rec.attachments:[];
    const attachmentsHtml=attachments.length?`<div class="attachments">${attachments.map(att=>`<a href="${escapeHtml(att.url||'#')}" target="_blank" rel="noopener">📎 ${escapeHtml(att.name||'添付ファイル')}</a>`).join('')}</div>`:"";
    return `<div class="external-record">`
      + `<div class="meta"><span>${escapeHtml(rec.dateText||'---')}</span><span>${escapeHtml(rec.kind||'種別未設定')}</span></div>`
      + `<div class="text">${text}</div>`
      + attachmentsHtml
      + `</div>`;
  }).join("\n");
}

if(isExternalMode){
  initExternalMode();
}else{
  initInternalApp();
}
</script>
</body>
</html>