<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ケアマネ・モニタリング</title>
<style>
:root {
  --fg:#222; --bg:#f4f6fa; --card:#fff; --brand:#1976d2;
  --muted:#555; --accent:#e3f2fd;
}
body { font-family:"Noto Sans JP",system-ui,sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--fg);}
h1 { margin:0 0 20px; font-size:1.6rem; color:var(--brand);}
h2 { margin:14px 0 8px; font-size:1.15rem; color:#333;}
.card { background:var(--card); border-radius:10px; padding:16px; margin-bottom:18px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);}
.toolbar { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0;}
input[type=text], select, textarea { font-family:inherit; border:1px solid #ccc; border-radius:6px; padding:8px 10px;}
textarea { width:100%; min-height:120px;}
button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; transition:.2s; font-size:0.85rem;}
button { background:var(--brand); color:#fff;}
button.secondary { background:#eee; color:#333;}
button.danger { background:#d32f2f; color:#fff;}
button:hover { opacity:0.9;}
.btn-compact { padding:4px 8px; font-size:0.8rem; }
.pill { display:inline-block; padding:4px 10px; font-size:.85rem; border-radius:999px; background:var(--accent); color:var(--brand);}
.autocomplete-list { position:absolute; background:#fff; border:1px solid #ccc; border-radius:6px;
  max-height:220px; overflow-y:auto; width:260px; box-shadow:0 2px 6px rgba(0,0,0,.1); z-index:100;}
.autocomplete-item { padding:8px 12px; cursor:pointer; font-size:0.9rem;}
.autocomplete-item:hover { background:var(--accent);}
.autocomplete-item.autocomplete-empty { color:var(--muted); cursor:default; pointer-events:none; }
.layout { display:grid; grid-template-columns:minmax(260px,320px) minmax(0,1fr) minmax(260px,320px); gap:16px; align-items:start; }
.layout-column { display:flex; flex-direction:column; gap:16px; }
.layout-right { display:flex; flex-direction:column; gap:16px; }
@media(max-width:1200px){
  .layout { grid-template-columns:minmax(260px,320px) minmax(0,1fr); }
  .layout-right { grid-column:1 / -1; }
}
@media(max-width:960px){
  .layout { grid-template-columns:1fr; }
}
.record { margin-bottom:12px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff;}
.record .muted { font-size:0.85rem; color:#666;}
.record .toolbar { margin-top:6px;}

.record .text { margin:6px 0; font-size:0.92rem; white-space:pre-wrap; line-height:1.5; }
.record .attachments { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
.record .attachments a { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; font-size:0.8rem; border-radius:999px; background:#f0f4ff; color:var(--brand); text-decoration:none; }
.record .attachments a:hover { background:#dbe5ff; }
.search-toolbar { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 4px; }
.search-toolbar label { font-size:0.85rem; color:#666; display:flex; align-items:center; gap:6px; }
.search-toolbar input[type=date], .search-toolbar input[type=text] { font-size:0.85rem; }
.media-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); }
.media-card { border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.05); }
.media-card a { display:block; color:inherit; text-decoration:none; }
.media-card img { width:100%; height:100px; object-fit:cover; display:block; background:#f6f8fb; }
.media-card .media-icon { height:100px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; background:#f6f8fb; }
.media-card .media-meta { padding:8px; font-size:0.75rem; color:#555; }
.media-card .media-meta .name { font-weight:600; color:#333; margin-bottom:4px; }
.dashboard-card h2 { display:flex; align-items:center; justify-content:space-between; gap:8px; }
.dashboard-content { min-height:180px; display:flex; flex-direction:column; gap:14px; }
.dashboard-empty { color:var(--muted); font-size:0.85rem; }
.dashboard-summary { display:flex; flex-direction:column; gap:10px; background:#f5f8ff; border:1px solid #d3e0f6; border-radius:10px; padding:12px; }
.dashboard-summary-header { display:flex; flex-wrap:wrap; gap:8px; font-size:0.85rem; color:#1f2f4b; }
.dashboard-summary-header span { background:#eef3ff; padding:4px 10px; border-radius:999px; }
.dashboard-meta { font-size:0.8rem; color:#4a5a75; display:flex; flex-wrap:wrap; gap:12px; }
.dashboard-form { display:flex; flex-direction:column; gap:12px; }
.dashboard-form label { display:flex; flex-direction:column; gap:6px; font-size:0.82rem; color:#334; }
.dashboard-form input[type="text"], .dashboard-form textarea { font-family:inherit; border:1px solid #ccd5e6; border-radius:8px; padding:8px 10px; font-size:0.9rem; background:#fff; }
.dashboard-form textarea { min-height:110px; resize:vertical; }
.dashboard-actions { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.dashboard-message { font-size:0.78rem; color:#4a5a75; }
.record.selected { border-color:var(--brand); box-shadow:0 0 0 2px rgba(25,118,210,0.18); }
.muted { color:#666; font-size:0.8rem; }
  
#mediaGallery { min-height:80px; }
.media-grid { display:flex; flex-direction:column; gap:8px; }
.media-item { background:#f7f9ff; border:1px solid #dbe6f6; border-radius:8px; padding:8px 10px; }
.media-item a { color:var(--brand); font-weight:600; text-decoration:none; word-break:break-all; }
.media-item a:hover { text-decoration:underline; }
.media-missing { color:#777; font-weight:600; word-break:break-all; }
.media-meta { margin-top:4px; font-size:0.78rem; color:var(--muted); display:flex; gap:6px; flex-wrap:wrap; }
.share-card .toolbar { justify-content:flex-start; }
.share-list { display:flex; flex-direction:column; gap:10px; }
.share-item { border:1px solid #dbe6f6; border-radius:8px; padding:10px; background:#f8fbff; position:relative; }
.share-item.expired { background:#fff3f3; border-color:#f5c2c2; }
.share-item .share-item-header { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
.share-item .share-url { flex:1; display:flex; gap:6px; align-items:center; }
.share-item .share-url input { flex:1; font-size:0.78rem; padding:4px 6px; border-radius:6px; border:1px solid #c7d7ef; background:#fff; }
.share-item .share-meta { display:flex; flex-wrap:wrap; gap:10px; font-size:0.75rem; color:#546079; margin-top:6px; }
.share-item .share-actions { display:flex; gap:6px; margin-top:8px; }
.share-item .share-actions .btn-compact { white-space:nowrap; }
.share-qr { margin-top:10px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.share-qr img { width:110px; height:110px; border:1px solid #d0ddf4; border-radius:12px; background:#fff; padding:6px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
.share-qr .share-qr-actions { display:flex; flex-wrap:wrap; gap:6px; }
.share-qr .share-qr-url { font-size:0.75rem; color:#334; word-break:break-all; }
.share-qr .share-qr-note { font-size:0.72rem; color:#60708f; }
.share-meta-notes { font-size:0.72rem; color:#60708f; margin-top:6px; }
.share-form { border-top:1px dashed #c7d7ef; padding-top:10px; margin-top:10px; }
.share-form .share-field { margin-bottom:10px; }
.share-form label { font-size:0.82rem; color:#445; display:flex; flex-direction:column; gap:4px; }
.share-form input[type="text"], .share-form input[type="datetime-local"] { font-size:0.85rem; padding:6px 8px; border:1px solid #c7d7ef; border-radius:6px; }
.share-form select { font-size:0.85rem; padding:6px 8px; border:1px solid #c7d7ef; border-radius:6px; }
.share-attachments { display:flex; flex-direction:column; gap:6px; max-height:180px; overflow-y:auto; padding:6px; background:#f2f7ff; border-radius:6px; border:1px solid #d2def5; }
.share-attachments .share-attachment { display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#334; }
.share-attachments .share-attachment .muted { margin-left:auto; }
.share-attachments .share-attachment-info { display:flex; flex-direction:column; }
.share-attachments .share-attachment-info span { font-size:0.76rem; color:#667; }
.share-empty { font-size:0.8rem; color:#666; padding:6px 4px; }
.share-helper { font-size:0.75rem; color:#6a7a93; margin-top:4px; }
.share-item .badge { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; border-radius:999px; background:#e3f2fd; color:#1957a3; font-size:0.7rem; }
.share-item.expired .badge { background:#ffe6e6; color:#b71c1c; }
.share-item .tag-group { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.share-form .toolbar { gap:8px; }
.share-attachments-all { font-size:0.82rem; display:flex; align-items:center; gap:6px; margin-bottom:6px; }
</style>
</head>
<body>
<div id="internalApp">
<h1>ケアマネ・モニタリング
  <span class="pill" id="memberTag">未選択</span>
</h1>

<!-- 利用者選択 -->
<div class="card">
  <h2>利用者を選択</h2>
  <div class="toolbar" style="position:relative;">
    <input type="text" id="memberIdInput" placeholder="IDまたは氏名で検索" autocomplete="off" style="min-width:260px;">
    <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
    <select id="recordRange">
      <option value="all">全件</option>
      <option value="90">直近90日</option>
      <option value="30" selected>直近30日</option>
      <option value="7">直近7日</option>
    </select>
    <button id="btnReload" class="secondary">更新</button>
  </div>
  <div id="idStatus" class="muted"></div>
</div>

<!-- 新規利用者登録 -->
<div class="card">
  <h2>新規利用者登録</h2>
  <div class="toolbar">
    <input type="text" id="newMemberId" placeholder="ID (4桁)" maxlength="4" style="width:100px;">
    <input type="text" id="newMemberName" placeholder="氏名（例: 山田　太郎）" style="flex:1;">
    <button id="btnAddMember">登録</button>
  </div>
  <div id="addMemberStatus" class="muted"></div>
</div>

<!-- メインUI -->
<div id="mainArea" style="display:none;">
  <div class="layout">
    <div class="layout-column layout-compose">
      <!-- 新規記録 -->
      <div class="card">
        <h2>新規モニタリング記録</h2>
        <div class="toolbar">
          <label for="kindSelect">種別:</label>
          <select id="kindSelect">
            <option value="訪問">訪問</option>
            <option value="電話">電話</option>
            <option value="施設面談">施設面談</option>
            <option value="通所先">通所先</option>
            <option value="サービス担当者会議">サービス担当者会議</option>
            <option value="その他" selected>その他</option>
          </select>
        </div>
        <textarea id="inputText" placeholder="記録を入力..."></textarea>
        <div class="toolbar">
          <input id="fileInput" type="file" multiple />
          <button id="btnSave">保存</button>
          <span id="saveStatus" class="muted"></span>
        </div>
      </div>
      <!-- AI要約 -->
      <div class="card">
        <h2>AI要約</h2>
        <div class="toolbar">
          <select id="summaryFormat">
            <option value="normal">標準</option>
            <option value="icf">ICF形式</option>
            <option value="soap">SOAP形式</option>
            <option value="doctor">医療連携</option>
            <option value="family">家族向け</option>
          </select>
          <button id="btnSummary">要約生成</button>
        </div>
        <div id="summaryOutput" class="muted">ここに要約が表示されます</div>
      </div>
      <!-- 提案 -->
      <div class="card">
        <h2>ケアマネからの提案</h2>
        <div class="toolbar">
          <select id="adviceHorizonSelect">
            <option value="now">すぐに対応</option>
            <option value="2w">2週間</option>
            <option value="1m">1か月</option>
            <option value="3m" selected>3か月</option>
          </select>
          <button id="btnAdvice">提案生成</button>
        </div>
        <div id="adviceOutput" class="muted">ここに提案が表示されます</div>
      </div>
    </div>
    <div class="layout-column layout-history">
      <div class="card">
        <h2>過去の記録</h2>
        <div class="search-toolbar">
          <label>種別
            <select id="filterKind">
              <option value="all">すべて</option>
              <option value="訪問">訪問</option>
              <option value="電話">電話</option>
              <option value="施設面談">施設面談</option>
              <option value="通所先">通所先</option>
              <option value="サービス担当者会議">サービス担当者会議</option>
              <option value="その他">その他</option>
            </select>
          </label>
          <label>開始
            <input type="date" id="filterDateFrom">
          </label>
          <label>終了
            <input type="date" id="filterDateTo">
          </label>
          <input type="text" id="filterText" placeholder="本文検索（キーワード）" style="flex:1; min-width:160px;">
          <button id="btnClearFilters" class="secondary btn-compact">クリア</button>
        </div>
        <div id="recordList" class="muted">利用者を選択してください</div>
      </div>
      <div class="card dashboard-card">
        <h2>利用者ダッシュボード</h2>
        <div id="dashboardContent" class="dashboard-content">
          <div class="dashboard-empty">記録を選択すると詳細が表示されます</div>
        </div>
        <div id="dashboardMessage" class="dashboard-message"></div>
      </div>
    </div>
    <aside class="layout-right">
      <div class="card">
        <h2>添付ギャラリー</h2>
        <div id="mediaGallery" class="muted">利用者を選択してください</div>
      </div>
      <div class="card share-card">
        <h2>外部共有</h2>
        <div id="shareList" class="share-list muted">利用者を選択すると共有リンクが表示されます</div>
        <div class="toolbar">
          <button id="btnOpenShareForm" class="secondary btn-compact">共有リンクを作成</button>
        </div>
        <div id="shareForm" class="share-form" style="display:none;">
          <div class="share-field">
            <label>共有先を選択
              <select id="shareAudience">
                <option value="family">家族：生活の様子を共有</option>
                <option value="center">地域包括支援センター：定期確認</option>
                <option value="medical">医療機関：医師・看護師との連携</option>
                <option value="service">サービス事業者：ケア実務者と共有</option>
              </select>
            </label>
            <div class="share-helper">共有先に応じて表示内容や案内文が自動で切り替わります。</div>
          </div>
          <div class="share-field">
            <label>閲覧期限
              <select id="shareExpiryPreset">
                <option value="7">7日間（短期共有）</option>
                <option value="30" selected>30日間（標準）</option>
                <option value="90">90日間（長期共有）</option>
                <option value="none">期限なし</option>
                <option value="custom">日付を指定する</option>
              </select>
            </label>
            <input type="datetime-local" id="shareExpires" style="display:none; margin-top:6px;">
            <div class="share-helper">「日付を指定する」を選ぶと任意の期限を設定できます。</div>
          </div>
          <div class="share-field">
            <label>閲覧用パスワード（任意）
              <input type="text" id="sharePassword" placeholder="未入力の場合はパスワードなし">
            </label>
            <div class="share-helper">安全のため、英数字を組み合わせた8文字以上を推奨します。</div>
          </div>
          <div class="share-field">
            <label><input type="checkbox" id="shareMaskCheckbox" checked> 本文をやさしくマスキングする</label>
          </div>
          <div class="share-field">
            <label>共有する期間
              <select id="shareRange">
                <option value="30" selected>直近30日</option>
                <option value="90">直近90日</option>
                <option value="all">全期間</option>
              </select>
            </label>
            <div class="share-helper">閲覧者側では期間を変更できません。必要最小限の期間に絞って共有できます。</div>
          </div>
          <div class="share-field">
            <div class="share-attachments-all">
              <label><input type="checkbox" id="shareAttachmentAll"> すべての添付ファイルを共有する</label>
            </div>
            <div id="shareAttachments" class="share-attachments muted">記録を読み込み中です…</div>
          </div>
          <div class="toolbar">
            <button id="btnCreateShare">共有リンクを発行</button>
            <button type="button" id="btnCancelShare" class="secondary">キャンセル</button>
          </div>
          <div id="shareFormStatus" class="muted"></div>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
let memberId = null, memberName = "";
let memberList = [];
let memberSearchResults = [];
let memberListLoading = false;
let memberListLoaded = false;
let recordsCache = [];
let selectedRecord = null;
let selectedRecordId = "";
let dashboardMessageTimer = null;
const queryParams = new URLSearchParams(window.location.search);

function getRecordTimestamp(record) {
  if (record && typeof record.timestamp === "number" && !isNaN(record.timestamp)) {
    return record.timestamp;
  }
  if (record && record.date instanceof Date && !isNaN(record.date.getTime())) {
    return record.date.getTime();
  }
  const raw = record && (record.dateValue || record.dateText || record.date);
  const parsed = raw ? Date.parse(raw) : NaN;
  return Number.isNaN(parsed) ? null : parsed;
}

function normalizeRecord(record) {
  const attachments = Array.isArray(record.attachments) ? record.attachments : [];
  return {
    ...record,
    attachments,
    timestamp: getRecordTimestamp(record)
  };
}

function buildAttachmentViewUrl(att) {
  if (!att) return "#";
  if (att.url) return att.url;
  if (att.fileId) return "https://drive.google.com/file/d/" + att.fileId + "/view";
  return "#";
}

function buildAttachmentThumbnailUrl(att) {
  if (!att) return "";
  if (att.fileId) {
    return "https://drive.google.com/thumbnail?id=" + att.fileId + "&sz=w200";
  }
  return "";
}

function getRecordIdentifier(record) {
  if (!record || typeof record !== "object") return "";
  if (record.recordId != null && record.recordId !== "") return String(record.recordId);
  if (record.rowIndex != null && record.rowIndex !== "") return String(record.rowIndex);
  return "";
}

function setDashboardMessage(text, isError) {
  const messageEl = document.getElementById("dashboardMessage");
  if (!messageEl) return;
  messageEl.textContent = text || "";
  messageEl.style.color = isError ? "#b91c1c" : "#1f2a44";
  if (dashboardMessageTimer) {
    clearTimeout(dashboardMessageTimer);
    dashboardMessageTimer = null;
  }
  if (text && !isError) {
    dashboardMessageTimer = setTimeout(() => {
      if (messageEl.textContent === text) {
        messageEl.textContent = "";
      }
    }, 4000);
  }
}

function scrollDashboardIntoView() {
  const card = document.querySelector('.dashboard-card');
  if (card) {
    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function renderDashboardPanel() {
  const container = document.getElementById("dashboardContent");
  if (!container) return;
  if (!memberId) {
    container.innerHTML = '<div class="dashboard-empty">利用者を選択してください</div>';
    setDashboardMessage("", false);
    return;
  }
  if (!recordsCache.length) {
    container.innerHTML = '<div class="dashboard-empty">記録が存在しません</div>';
    setDashboardMessage("", false);
    return;
  }
  if (!selectedRecord) {
    container.innerHTML = '<div class="dashboard-empty">記録を選択すると詳細が表示されます</div>';
    return;
  }
  const identifier = getRecordIdentifier(selectedRecord);
  if (identifier && identifier !== selectedRecordId) {
    selectedRecordId = identifier;
  }
  const metaParts = [];
  if (selectedRecord.center) metaParts.push(`地域包括支援センター: ${escapeHtml(selectedRecord.center)}`);
  if (selectedRecord.staff) metaParts.push(`担当者名: ${escapeHtml(selectedRecord.staff)}`);
  container.innerHTML = `
    <div class="dashboard-summary">
      <div class="dashboard-summary-header">
        <span>${escapeHtml(selectedRecord.dateText || '日付未設定')}</span>
        <span>${escapeHtml(selectedRecord.kind || '種別未設定')}</span>
        ${identifier ? `<span>ID: ${escapeHtml(identifier)}</span>` : ''}
      </div>
      ${metaParts.length ? `<div class="dashboard-meta">${metaParts.map(part => `<span>${part}</span>`).join('')}</div>` : ''}
      <form id="dashboardForm" class="dashboard-form" data-row-index="${escapeHtml(String(selectedRecord.rowIndex || ''))}" data-record-id="${escapeHtml(identifier)}">
        <label>地域包括支援センター
          <input type="text" id="dashboardCenter" value="${escapeHtml(selectedRecord.center || '')}" placeholder="例：○○地域包括支援センター">
        </label>
        <label>担当者名
          <input type="text" id="dashboardStaff" value="${escapeHtml(selectedRecord.staff || '')}" placeholder="例：担当ケアマネ氏名">
        </label>
        <label>状態・経過
          <textarea id="dashboardStatus">${escapeHtml(selectedRecord.status || '')}</textarea>
        </label>
        <label>特記事項
          <textarea id="dashboardSpecial">${escapeHtml(selectedRecord.special || '')}</textarea>
        </label>
        <div class="dashboard-actions">
          <button type="submit">保存</button>
          <button type="button" id="dashboardDelete" class="danger">削除</button>
        </div>
      </form>
    </div>
  `;
  const form = document.getElementById("dashboardForm");
  if (form) {
    form.addEventListener("submit", handleDashboardSubmit);
  }
  const deleteBtn = document.getElementById("dashboardDelete");
  if (deleteBtn) {
    deleteBtn.addEventListener("click", handleDashboardDelete);
  }
}

function ensureSelectedRecord() {
  if (!memberId || !recordsCache.length) {
    selectedRecord = null;
    selectedRecordId = "";
    renderDashboardPanel();
    return;
  }
  if (selectedRecordId) {
    const existing = recordsCache.find(rec => getRecordIdentifier(rec) === selectedRecordId);
    if (existing) {
      selectedRecord = existing;
      renderDashboardPanel();
      return;
    }
  }
  selectedRecord = recordsCache[0] || null;
  selectedRecordId = getRecordIdentifier(selectedRecord);
  renderDashboardPanel();
}

function selectRecordByRow(rowIndex, recordId) {
  if (!recordsCache.length) {
    selectedRecord = null;
    selectedRecordId = "";
    renderDashboardPanel();
    return;
  }
  let match = null;
  if (recordId) {
    match = recordsCache.find(rec => getRecordIdentifier(rec) === String(recordId));
  }
  if (!match && rowIndex) {
    match = recordsCache.find(rec => String(rec.rowIndex || '') === String(rowIndex));
  }
  selectedRecord = match || null;
  selectedRecordId = match ? getRecordIdentifier(match) : "";
  renderRecords();
  renderDashboardPanel();
  scrollDashboardIntoView();
}

async function handleDashboardSubmit(event) {
  event.preventDefault();
  if (!memberId) return;
  const form = event.currentTarget;
  if (!form) return;
  const payload = {
    memberId,
    rowIndex: form.dataset.rowIndex || "",
    recordId: form.dataset.recordId || "",
    center: (document.getElementById("dashboardCenter")?.value || "").trim(),
    staff: (document.getElementById("dashboardStaff")?.value || "").trim(),
    status: (document.getElementById("dashboardStatus")?.value || "").trim(),
    special: (document.getElementById("dashboardSpecial")?.value || "").trim()
  };
  setDashboardMessage("保存中…", false);
  try {
    const res = await callGoogle("updateMonitoringRecord", payload);
    if (!res || res.status !== "success") {
      throw new Error(res && res.message ? res.message : "保存に失敗しました");
    }
    await loadRecords({ keepRowIndex: payload.rowIndex, keepRecordId: payload.recordId });
    setDashboardMessage("保存しました", false);
  } catch (err) {
    setDashboardMessage("失敗: " + (err && err.message ? err.message : err), true);
  }
}

async function handleDashboardDelete() {
  if (!memberId) return;
  const form = document.getElementById("dashboardForm");
  if (!form) return;
  if (!confirm("この記録を削除しますか？")) return;
  const payload = {
    memberId,
    rowIndex: form.dataset.rowIndex || "",
    recordId: form.dataset.recordId || ""
  };
  setDashboardMessage("削除中…", false);
  try {
    const res = await callGoogle("deleteMonitoringRecord", payload);
    if (!res || res.status !== "success") {
      throw new Error(res && res.message ? res.message : "削除に失敗しました");
    }
    selectedRecord = null;
    selectedRecordId = "";
    await loadRecords();
    setDashboardMessage("削除しました", false);
  } catch (err) {
    setDashboardMessage("失敗: " + (err && err.message ? err.message : err), true);
  }
}


const shareAudienceInfo = {
  family: {
    label: "家族向け共有",
    description: "日々の様子をわかりやすく伝えるシンプルな表示です。",
    intro: "大切なご家族や関係者の皆さまと状況を共有するためのページです。必要な情報だけをまとめていますので、安心してご覧ください。",
    manualTips: [
      "QRコードをスマートフォンのカメラで読み取るとページが開きます。",
      "閲覧ページでは最新のモニタリング記録を順番に確認できます。"
    ]
  },
  center: {
    label: "地域包括支援センター向け共有",
    description: "日付・種別を含めてモニタリング内容を確認できます。",
    intro: "地域包括支援センターの職員さま向けの共有ページです。必要な記録を簡潔にまとめています。",
    manualTips: [
      "QRコードからアクセスし、閲覧専用のページで記録をご確認ください。",
      "必要に応じてケアマネジャーへフィードバックをお寄せください。"
    ]
  },
  medical: {
    label: "医療連携向け共有",
    description: "医師・看護師が経過を把握しやすいよう種別も表示します。",
    intro: "医療機関の皆さまとの情報連携用ページです。必要事項のみ抜粋しています。",
    manualTips: [
      "QRコードを読み取り、モニタリング記録を時系列で確認できます。",
      "診察や訪問時の参考資料としてご活用ください。"
    ]
  },
  service: {
    label: "サービス事業者向け共有",
    description: "ケア実務者が把握しやすいよう構成しています。",
    intro: "サービス事業者の皆さまとの共有ページです。現場で活用しやすいよう簡潔にまとめています。",
    manualTips: [
      "QRコードでアクセスし、必要な記録をいつでも確認できます。",
      "サービス提供に関する気づきはケアマネジャーまでご連絡ください。"
    ]
  }
};
const shareAudienceDefault = "family";
const shareExpiryPresetDefault = "30";
const shareRangeDefault = "30";

function getAudienceInfo(audience){
  const key = String(audience || "").toLowerCase();
  return shareAudienceInfo[key] || shareAudienceInfo[shareAudienceDefault];
}

const DASHBOARD_OTHER_LABEL = "その他";
const DASHBOARD_DIGIT_LABEL = "0-9";
const DASHBOARD_LEGACY_LABEL_MAP = {
  "あ": "あ行",
  "か": "か行",
  "さ": "さ行",
  "た": "た行",
  "な": "な行",
  "は": "は行",
  "ま": "ま行",
  "や": "や行",
  "ら": "ら行",
  "わ": "わ行",
  "#": DASHBOARD_OTHER_LABEL
};

const DASHBOARD_SMALL_KANA_MAP = {
  "ぁ": "あ",
  "ぃ": "い",
  "ぅ": "う",
  "ぇ": "え",
  "ぉ": "お",
  "っ": "つ",
  "ゃ": "や",
  "ゅ": "ゆ",
  "ょ": "よ",
  "ゎ": "わ",
  "ゕ": "か",
  "ゖ": "け"
};

const DASHBOARD_COLLAPSE_STORAGE_KEY = "monitoringDashboardCollapsed";

function getAvailableStorages() {
  const list = [];
  if (typeof localStorage !== "undefined") list.push(localStorage);
  if (typeof sessionStorage !== "undefined") list.push(sessionStorage);
  return list;
}

function normalizeDashboardCollapsedKeys(map) {
  if (!map || typeof map !== "object" || Array.isArray(map)) return {};
  const normalized = {};
  Object.keys(map).forEach(key => {
    const mapped = DASHBOARD_LEGACY_LABEL_MAP[key] || key;
    normalized[mapped] = map[key];
  });
  return normalized;
}



let input = null;
let listBox = null;
let searchBoxInitialized = false;

function searchUsers(rawQuery) {
  if (!listBox) return;
  const source = rawQuery == null ? "" : String(rawQuery);
  const query = source.trim();
  if (memberListLoading && query) {
    listBox.innerHTML = '<div class="autocomplete-item autocomplete-empty" data-empty="true">読み込み中…</div>';
    listBox.style.display = "block";
    listBox.scrollTop = 0;
    return;
  }
  if (!memberListLoaded && !memberListLoading && query) {
    listBox.innerHTML = '<div class="autocomplete-item autocomplete-empty" data-empty="true">利用者情報が読み込まれていません</div>';
    listBox.style.display = "block";
    listBox.scrollTop = 0;
    return;
  }
  if (!query) {
    listBox.innerHTML = "";
    listBox.style.display = "none";
    listBox.scrollTop = 0;
    memberSearchResults = [];
    return;
  }
  const idDigits = extractMemberIdDigits(query);
  const normalizedId = normalizeMemberIdForLookup(query);
  const normalizedQuery = normalizeMemberSearchText(query);
  const list = Array.isArray(memberList) ? memberList : [];
  const hits = list
    .filter(member => memberMatchesQuery(member, query, idDigits, normalizedQuery, normalizedId))
    .slice(0, 20);
  memberSearchResults = hits;
  if (!hits.length) {
    listBox.innerHTML = '<div class="autocomplete-item autocomplete-empty" data-empty="true">該当者なし</div>';
    listBox.style.display = "block";
    listBox.scrollTop = 0;
    return;
  }
  listBox.innerHTML = hits
    .map(member => {
      const reading = member.yomi || member.kana;
      const yomiLabel = reading ? ` <span class="muted">(${escapeHtml(reading)})</span>` : "";
      return `<div class="autocomplete-item" data-id="${member.id}" data-name="${escapeHtml(member.name)}">${member.id}　${escapeHtml(member.name)}${yomiLabel}</div>`;
    })
    .join("");
  listBox.style.display = "block";
  listBox.scrollTop = 0;
}

function setupSearchBox() {
  if (!input) input = document.getElementById("memberIdInput");
  if (!listBox) listBox = document.getElementById("autocompleteList");
  if (!input || !listBox) return;
  if (searchBoxInitialized) return;
  searchBoxInitialized = true;
  const handleInput = () => searchUsers(input.value);
  input.addEventListener("input", handleInput);
  input.addEventListener("change", resolveInput);
  listBox.addEventListener("click", e => {
    const rawTarget = e.target;
    const target = rawTarget instanceof Element ? rawTarget : rawTarget && rawTarget.parentElement;
    const item = target ? target.closest(".autocomplete-item") : null;
    if (!item || item.dataset.empty === "true") return;
    selectMember(item.dataset.id, item.dataset.name);
  });
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); resolveInput(); }
  });
  input.addEventListener("blur", () => { setTimeout(resolveInput, 100); });
}

function resolveInput() {
  const val = input.value.trim();
  if (!val) return;
  if (Array.isArray(memberSearchResults) && memberSearchResults.length === 1) {
    const only = memberSearchResults[0];
    if (only && only.id) {
      selectMember(only.id, only.name || "");
      return;
    }
  }
  const idDigits = extractMemberIdDigits(val);
  const normalizedId = normalizeMemberIdForLookup(val);
  const normalizedQuery = normalizeMemberSearchText(val);
  let hit = null;
  if (normalizedId) {
    hit = memberList.find(m => {
      const memberId = m.id != null ? String(m.id) : "";
      const memberIdNormalized = m.idNormalized != null ? String(m.idNormalized) : "";
      return memberId === normalizedId || memberIdNormalized === normalizedId;
    });
  }
  if (!hit && idDigits) {
    hit = memberList.find(m => {
      const memberIdNormalized = m.idNormalized != null ? String(m.idNormalized) : "";
      if (!memberIdNormalized) return false;
      if (memberIdNormalized === idDigits) return true;
      return memberIdNormalized === idDigits.padStart(memberIdNormalized.length, "0");
    });
  }
  if (!hit) {
    hit = memberList.find(m => m.name === val);
  }
  if (!hit) {
    hit = memberList.find(m => (m.kana && m.kana === val) || (m.yomi && m.yomi === val));
  }
  if (!hit && normalizedQuery) {
    hit = memberList.find(m => {
      return m.nameNormalized === normalizedQuery ||
        m.kanaNormalized === normalizedQuery ||
        m.yomiNormalized === normalizedQuery;
    });
  }
  if (!hit) {
    hit = memberList.find(m => memberMatchesQuery(m, val, idDigits, normalizedQuery, normalizedId));
  }
  if (hit) { selectMember(hit.id, hit.name); return; }
  if (normalizedId) { selectMember(normalizedId, ""); return; }
  const statusEl = document.getElementById("idStatus");
  if (statusEl) statusEl.textContent = "候補が見つかりません";
}

function selectMember(id, name) {
  console.log("[member] selectMember:start", { id, name });
  const rawId = id != null ? String(id) : "";
  const inputFallback = input && input.value ? input.value : "";
  const safeId = normalizeMemberIdForLookup(rawId || inputFallback);
  if (!safeId) {
    console.warn("[member] selectMember:missing-id", { id, name, inputValue: inputFallback });
    setMemberStatusMessage("利用者IDを取得できませんでした");
    return;
  }
  const safeName = name != null ? String(name).trim() : "";
  memberId = safeId;
  memberName = safeName;
  const label = `${safeId}${safeName ? "　" + safeName : ""}`;
  if (input) input.value = label;
  if (listBox) {
    listBox.style.display = "none";
    listBox.innerHTML = "";
  }
  setMemberStatusMessage(`選択中: ${label}`);
  const filterKindEl = document.getElementById("filterKind");
  if (filterKindEl) filterKindEl.value = "all";
  const fromEl = document.getElementById("filterDateFrom");
  if (fromEl) fromEl.value = "";
  const toEl = document.getElementById("filterDateTo");
  if (toEl) toEl.value = "";
  const textEl = document.getElementById("filterText");
  if (textEl) textEl.value = "";
  const summaryEl = document.getElementById("summaryOutput");
  if (summaryEl) summaryEl.textContent = "ここに要約が表示されます";
  const adviceEl = document.getElementById("adviceOutput");
  if (adviceEl) adviceEl.textContent = "ここに提案が表示されます";
  console.log("[member] selectMember:load", { id: safeId });
  loadMemberData(safeId, { name: memberName, label });
  console.log("[member] selectMember:complete", { id: safeId, name: memberName });
}

function loadMemberData(userId, options = {}) {
  const safeId = String(userId || "").trim();
  const name = options.name != null ? String(options.name) : (memberName || "");
  const label = options.label || `${safeId}${name ? "　" + name : ""}`;
  console.log("[member] loadMemberData:start", { userId: safeId, name });
  if (!safeId) {
    console.warn("[member] loadMemberData:missing-id", { userId });
    return;
  }
  const mainArea = document.getElementById("mainArea");
  if (mainArea) {
    mainArea.style.display = "block";
  } else {
    console.warn("[member] loadMemberData:mainArea-not-found");
  }
  const tagEl = document.getElementById("memberTag");
  if (tagEl) {
    tagEl.textContent = label;
  } else {
    console.warn("[member] loadMemberData:memberTag-not-found");
  }
  updateMediaGallery([]);
  closeShareForm();
  resetShareListPlaceholder();
  renderDashboardPanel();
  loadRecords();
  fetchExternalShareList();
  console.log("[member] loadMemberData:complete", { userId: safeId, name });
}

function setupMemberUi() {
  const btnAddMember = document.getElementById("btnAddMember");
  if (btnAddMember) {
    btnAddMember.onclick = () => {
      const idInput = document.getElementById("newMemberId");
      const nameInput = document.getElementById("newMemberName");
      const id = idInput.value.trim();
      const name = nameInput.value.trim();
      const status = document.getElementById("addMemberStatus");
      if (!id || !name) { status.textContent = "IDと氏名を入力してください"; return; }
      google.script.run.withSuccessHandler(res => {
        if (res.status === "success") {
          status.textContent = `登録しました: ${res.id} ${res.name}`;
          idInput.value = "";
          nameInput.value = "";
          if (res.id) {
            selectMember(res.id, res.name || "");
          }
          refreshMemberList();
                  } else {
          status.textContent = "失敗: " + res.message;
        }
      }).withFailureHandler(err => {
        status.textContent = "エラー: " + (err && err.message ? err.message : err);
      }).addMember(id, name);
    };
  }

  const btnSave = document.getElementById("btnSave");
  if (btnSave) {
    btnSave.addEventListener("click", handleSave);
  }

  const btnSummary = document.getElementById("btnSummary");
  if (btnSummary) {
    btnSummary.onclick = () => {
      if (!memberId) { alert("利用者を選択してください"); return; }
      const fmt = document.getElementById("summaryFormat").value;
      const days = document.getElementById("recordRange").value;
      const out = document.getElementById("summaryOutput");
      out.textContent = "生成中…";
      google.script.run.withSuccessHandler(res => {
        out.textContent = (res.status === "success") ? res.summary : ("失敗:" + res.message);
      }).withFailureHandler(err => {
        out.textContent = "失敗: " + (err && err.message ? err.message : err);
      }).generateAISummaryForDays(memberId, fmt, days);
    };
  }

  const btnAdvice = document.getElementById("btnAdvice");
  if (btnAdvice) {
    btnAdvice.onclick = () => {
      if (!memberId) { alert("利用者を選択してください"); return; }
      const horizon = document.getElementById("adviceHorizonSelect").value;
      const days = document.getElementById("recordRange").value;
      const out = document.getElementById("adviceOutput");
      out.textContent = "生成中…";
      google.script.run.withSuccessHandler(res => {
        out.textContent = (res.status === "success") ? res.advice : ("失敗:" + res.message);
      }).withFailureHandler(err => {
        out.textContent = "失敗: " + (err && err.message ? err.message : err);
      }).generateCareAdviceWithHorizon(memberId, days, horizon);
    };
  }

  const btnReload = document.getElementById("btnReload");
  if (btnReload) {
    btnReload.onclick = () => loadRecords();
  }

  const range = document.getElementById("recordRange");
  if (range) {
    range.addEventListener("change", () => {
      if (memberId) loadRecords();
    });
  }
}

async function handleSave() {
  const text = document.getElementById("inputText").value.trim();
  const files = Array.from(document.getElementById("fileInput").files || []);
  const status = document.getElementById("saveStatus");
  if (!memberId) { alert("利用者を選択してください"); return; }
  if (!text && files.length === 0) { alert("内容または添付を入力してください"); return; }
  status.textContent = "送信中…";
  try {
    const kind = document.getElementById("kindSelect").value;
    const attachmentsMeta = [];
    for (const file of files) {
      const payload = await readFileAsBase64(file);
      const uploadRes = await callGoogle("uploadAttachment_", memberId, payload.name, payload.mimeType, payload.base64);
      if (!uploadRes || uploadRes.status !== "success") {
        throw new Error(uploadRes && uploadRes.message ? uploadRes.message : "添付ファイルのアップロードに失敗しました");
      }
      attachmentsMeta.push({
        fileId: uploadRes.fileId,
        url: uploadRes.url,
        name: uploadRes.name || payload.name,
        mimeType: uploadRes.mimeType || payload.mimeType
      });
    }
    await callGoogle("saveRecordFromBrowser", memberId, text, new Date().toISOString(), JSON.stringify(attachmentsMeta), kind);
    status.textContent = "保存しました";
    document.getElementById("inputText").value = "";
    document.getElementById("fileInput").value = "";
    setTimeout(() => { status.textContent = ""; }, 3000);
    loadRecords();
      } catch (err) {
    status.textContent = "失敗: " + (err && err.message ? err.message : err);
  }
}

function renderAttachment(att, record, index) {
  const url = escapeHtml(buildAttachmentViewUrl(att));
  const label = escapeHtml(att && att.name ? att.name : `添付${index + 1}`);
  return `<a href="${url}" target="_blank" rel="noopener">📎 ${label}</a>`;
}

function filterRecords(records) {
  const kind = document.getElementById("filterKind").value;
  const text = document.getElementById("filterText").value.trim().toLowerCase();
  const fromVal = document.getElementById("filterDateFrom").value;
  const toVal = document.getElementById("filterDateTo").value;
  const fromTime = fromVal ? new Date(fromVal + "T00:00:00").getTime() : null;
  const toTime = toVal ? new Date(toVal + "T23:59:59").getTime() : null;
  return records.filter(r => {
    const ts = getRecordTimestamp(r);
    if (kind && kind !== "all" && String(r.kind) !== kind) return false;
    if (fromTime && (ts === null || ts < fromTime)) return false;
    if (toTime && (ts === null || ts > toTime)) return false;
    if (text) {
      const hay = `${(r.text || "").toLowerCase()} ${(r.kind || "").toLowerCase()}`;
      if (!hay.includes(text)) return false;
    }
    return true;
  }).sort((a, b) => (getRecordTimestamp(b) || 0) - (getRecordTimestamp(a) || 0));
}

function updateMediaGallery(records) {
  const gallery = document.getElementById("mediaGallery");
  if (!gallery) return;
  if (!records || !records.length) {
    gallery.textContent = "添付ファイルはありません";
    return;
  }
  const items = [];
  records.forEach(r => {
    if (Array.isArray(r.attachments)) {
      r.attachments.forEach(att => items.push({ attachment: att, record: r }));
    }
  });
  if (!items.length) {
    gallery.textContent = "添付ファイルはありません";
    return;
  }
  const cards = items.map(item => {
    const att = item.attachment || {};
    const rec = item.record || {};
    const viewUrl = escapeHtml(buildAttachmentViewUrl(att));
    const thumbUrlRaw = buildAttachmentThumbnailUrl(att);
    const thumbUrl = thumbUrlRaw ? escapeHtml(thumbUrlRaw) : "";
    const isImage = att.mimeType && att.mimeType.indexOf("image/") === 0;
    const preview = (isImage && thumbUrl)
      ? `<img src="${thumbUrl}" alt="${escapeHtml(att.name || "添付ファイル")}のサムネイル">`
      : `<div class="media-icon">📎</div>`;
    return `<div class="media-card">
      <a href="${viewUrl}" target="_blank" rel="noopener">
        ${preview}
        <div class="media-meta">
          <div class="name">${escapeHtml(att.name || "添付ファイル")}</div>
          <div>${escapeHtml(rec.dateText || "")}</div>
        </div>
      </a>
    </div>`;
  }).join("");
  gallery.innerHTML = `<div class="media-grid">${cards}</div>`;
}

function toTime(value){
  if(!value) return NaN;
  const d = value instanceof Date ? value : new Date(value);
  const t = d.getTime();
  return Number.isNaN(t) ? NaN : t;
}

function formatDateTime(value){
  const t = toTime(value);
  if(Number.isNaN(t)) return '';
  const d = new Date(t);
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// ===== 過去記録（編集・削除付き） =====

function loadRecords(options = {}) {
  const list = document.getElementById("recordList");
  const gallery = document.getElementById("mediaGallery");
  const rangeEl = document.getElementById("recordRange");
  const days = rangeEl ? rangeEl.value : 'all';
  if (!memberId) {
    if (list) list.textContent = "利用者を選択してください";
    recordsCache = [];
    selectedRecord = null;
    selectedRecordId = "";
    renderDashboardPanel();
    updateMediaGallery([]);
    updateShareAttachmentOptions([]);
    return Promise.resolve();
  }
  if (list) list.textContent = "読込中…";
  if (gallery) gallery.textContent = "添付を読み込んでいます…";
  return callGoogle("getRecordsByMemberId_v3", memberId, days).then(res => {
    if (!res || res.status !== "success") {
      const msg = res && res.message ? res.message : "取得に失敗しました";
      if (list) list.textContent = "エラー:" + msg;
      recordsCache = [];
      selectedRecord = null;
      selectedRecordId = "";
      renderDashboardPanel();
      updateMediaGallery([]);
      updateShareAttachmentOptions([]);
      return;
    }
    recordsCache = (Array.isArray(res.records) ? res.records : []).map(normalizeRecord);
    const keepRowIndex = options.keepRowIndex ? String(options.keepRowIndex) : "";
    const keepRecordId = options.keepRecordId ? String(options.keepRecordId) : "";
    if (keepRowIndex || keepRecordId) {
      const match = recordsCache.find(rec => {
        const id = getRecordIdentifier(rec);
        if (keepRecordId && id === keepRecordId) return true;
        if (keepRowIndex && String(rec.rowIndex || '') === keepRowIndex) return true;
        return false;
      });
      selectedRecord = match || null;
      selectedRecordId = match ? getRecordIdentifier(match) : "";
    } else {
      selectedRecord = null;
      selectedRecordId = "";
    }
    renderRecords();
    updateShareAttachmentOptions(recordsCache);
    updateMediaGallery(recordsCache);
    ensureSelectedRecord();
  }).catch(err => {
    const msg = err && err.message ? err.message : err;
    if (list) list.textContent = "エラー:" + msg;
    recordsCache = [];
    selectedRecord = null;
    selectedRecordId = "";
    renderDashboardPanel();
    updateMediaGallery([]);
    updateShareAttachmentOptions([]);
  });
}

function renderRecords() {
  const list = document.getElementById("recordList");
  if (!list) return;
  if (!memberId) {
    list.textContent = "利用者を選択してください";
    updateMediaGallery([]);
    return;
  }
  if (!recordsCache.length) {
    list.textContent = "記録が存在しません";
    updateMediaGallery([]);
    return;
  }
  const filtered = filterRecords(recordsCache);
  if (!filtered.length) {
    list.textContent = "条件に一致する記録がありません";
    updateMediaGallery([]);
    return;
  }
  const html = filtered.map(record => {
    const safeText = escapeHtml(record.text || "").replace(/\n/g, '<br>');
    const attachmentsHtml = (record.attachments && record.attachments.length)
      ? `<div class="attachments">${record.attachments.map((att, i) => renderAttachment(att, record, i)).join('')}</div>`
      : '';
    const identifier = getRecordIdentifier(record);
    const isSelected = identifier && identifier === selectedRecordId;
    const classes = isSelected ? 'record selected' : 'record';
    const details = [];
    if (record.center) details.push(`地域包括支援センター: ${escapeHtml(record.center)}`);
    if (record.staff) details.push(`担当者名: ${escapeHtml(record.staff)}`);
    return `<div class="${classes}" data-row="${record.rowIndex}" data-record-id="${escapeHtml(identifier)}">
      <div><b>${escapeHtml(record.dateText || '')}</b>【${escapeHtml(record.kind || '')}】</div>
      ${details.length ? `<div class="muted">${details.join(' / ')}</div>` : ''}
      <div class="text">${safeText || '<span class="muted">（本文なし）</span>'}</div>
      ${attachmentsHtml}
      <div class="toolbar">
        <button class="secondary btnEdit">詳細</button>
      </div>
    </div>`;
  }).join('');
  list.innerHTML = html;
  bindRecordActions();
  updateMediaGallery(filtered);
}

function bindRecordActions() {
  document.querySelectorAll(".btnEdit").forEach(btn => {
    btn.onclick = () => {
      const rec = btn.closest(".record");
      if (!rec) return;
      selectRecordByRow(rec.dataset.row, rec.dataset.recordId);
    };
  });
}

function collectAttachmentOptions(records){
  const map=new Map();
  (Array.isArray(records)?records:[]).forEach(record=>{
    if(!record) return;
    const ts=getRecordTimestamp(record);
    const files=Array.isArray(record.attachments)?record.attachments:[];
    files.forEach(att=>{
      if(!att || typeof att!=="object" || Array.isArray(att)) return;
      const fileId=String(att.fileId||att.id||"").trim();
      if(!fileId || map.has(fileId)) return;
      map.set(fileId,{
        fileId,
        name:att.name||att.fileName||att.title||"添付ファイル",
        recordDate:record.dateText||"",
        uploadedAt:att.uploadedAt||att.createdAt||att.timestamp||"",
        mimeType:att.mimeType||"",
        timestamp:ts||toTime(att.uploadedAt||att.createdAt||att.timestamp)
      });
    });
  });
  return Array.from(map.values()).sort((a,b)=>{
    const tb=Number.isFinite(b.timestamp)?b.timestamp:0;
    const ta=Number.isFinite(a.timestamp)?a.timestamp:0;
    if(tb!==ta) return tb-ta;
    return String(a.name||"").localeCompare(String(b.name||""),"ja");
  });
}

function updateShareAttachmentOptions(records){
  const container=document.getElementById("shareAttachments");
  if(!container) return;
  const data=collectAttachmentOptions(typeof records!=='undefined'?records:recordsCache);
  const shareAll=document.getElementById("shareAttachmentAll");
  if(!data.length){
    container.classList.add("muted");
    container.innerHTML='<div class="share-empty">共有できる添付ファイルはまだありません</div>';
    if(shareAll) shareAll.checked=false;
    return;
  }
  container.classList.remove("muted");
  container.innerHTML=data.map(att=>{
    const detailParts=[];
    if(att.recordDate) detailParts.push(`記録日: ${escapeHtml(att.recordDate)}`);
    const uploadedLabel=att.uploadedAt?formatDateTime(att.uploadedAt):"";
    if(uploadedLabel) detailParts.push(`アップロード: ${escapeHtml(uploadedLabel)}`);
    if(att.mimeType) detailParts.push(escapeHtml(att.mimeType));
    const detail=detailParts.length?`<span>${detailParts.join(' ｜ ')}</span>`:"";
    return `<label class="share-attachment"><input type="checkbox" data-file-id="${escapeHtml(att.fileId)}"><div class="share-attachment-info"><strong>${escapeHtml(att.name||'添付ファイル')}</strong>${detail}</div></label>`;
  }).join("\n");
  applyShareAllState();
}

function applyShareAllState(){
  const shareAll=document.getElementById("shareAttachmentAll");
  const container=document.getElementById("shareAttachments");
  if(!container) return;
  const checkboxes=container.querySelectorAll('input[type="checkbox"][data-file-id]');
  const disable=!!(shareAll && shareAll.checked);
  checkboxes.forEach(cb=>{
    cb.disabled=disable;
    if(disable) cb.checked=false;
  });
}

function applyShareExpiryPreset(){
  const preset=document.getElementById("shareExpiryPreset");
  const custom=document.getElementById("shareExpires");
  if(!preset || !custom) return;
  if(preset.value==="custom"){
    custom.style.display="";
    custom.disabled=false;
    if(!custom.value){
      const now=new Date();
      now.setDate(now.getDate()+7);
      custom.value=toLocalDateTimeInputValue(now);
    }
  }else{
    custom.style.display="none";
    custom.value="";
    custom.disabled=true;
  }
}

function setupShareUi(){
  const openBtn=document.getElementById("btnOpenShareForm");
  if(openBtn){
    openBtn.onclick=()=>toggleShareForm(true);
  }
  const cancelBtn=document.getElementById("btnCancelShare");
  if(cancelBtn){
    cancelBtn.onclick=()=>toggleShareForm(false);
  }
  const createBtn=document.getElementById("btnCreateShare");
  if(createBtn){
    createBtn.addEventListener("click",handleCreateShare);
  }
  const shareAll=document.getElementById("shareAttachmentAll");
  if(shareAll){
    shareAll.addEventListener("change",applyShareAllState);
  }
  const expiryPreset=document.getElementById("shareExpiryPreset");
  if(expiryPreset){
    expiryPreset.addEventListener("change",applyShareExpiryPreset);
  }
  const list=document.getElementById("shareList");
  if(list){
    list.addEventListener("click",handleShareListClick);
  }
  applyShareExpiryPreset();
}

function toggleShareForm(open){
  const form=document.getElementById("shareForm");
  if(!form) return;
  shareFormOpen=!!open;
  form.style.display=shareFormOpen?"":"none";
  const status=document.getElementById("shareFormStatus");
  if(status) status.textContent="";
  if(shareFormOpen){
    updateShareAttachmentOptions(recordsCache);
    applyShareExpiryPreset();
  }else{
    const expires=document.getElementById("shareExpires");
    const password=document.getElementById("sharePassword");
    const mask=document.getElementById("shareMaskCheckbox");
    const shareAll=document.getElementById("shareAttachmentAll");
    const audience=document.getElementById("shareAudience");
    const preset=document.getElementById("shareExpiryPreset");
    const rangeSelect=document.getElementById("shareRange");
    if(expires) expires.value="";
    if(password) password.value="";
    if(mask) mask.checked=true;
    if(shareAll) shareAll.checked=false;
    if(audience) audience.value=shareAudienceDefault;
    if(preset) preset.value=shareExpiryPresetDefault;
    if(rangeSelect) rangeSelect.value=shareRangeDefault;
    applyShareAllState();
    applyShareExpiryPreset();
  }
}

function closeShareForm(){ toggleShareForm(false); }

function resetShareListPlaceholder(){
  const list=document.getElementById("shareList");
  if(!list) return;
  list.classList.add("muted");
  list.innerHTML="利用者を選択すると共有リンクが表示されます";
}

function fetchExternalShareList(){
  const list=document.getElementById("shareList");
  if(!memberId){
    externalShares=[];
    resetShareListPlaceholder();
    return;
  }
  if(list){
    list.classList.add("muted");
    list.innerHTML="共有リンクを取得しています…";
  }
  callGoogle("getExternalShares",memberId).then(res=>{
    if(!res || res.status!=="success"){
      if(list){
        const msg=res && res.message ? escapeHtml(res.message) : "取得に失敗しました";
        list.innerHTML=`エラー: ${msg}`;
      }
      return;
    }
    externalShares=Array.isArray(res.shares)?res.shares:[];
    renderShareList();
  }).catch(err=>{
    if(list){
      const msg=err && err.message ? err.message : String(err);
      list.innerHTML=`エラー: ${escapeHtml(msg)}`;
    }
  });
}

function renderShareList(){
  const list=document.getElementById("shareList");
  if(!list) return;
  if(!externalShares.length){
    list.classList.add("muted");
    list.innerHTML="共有リンクはまだありません";
    return;
  }
  list.classList.remove("muted");
  list.innerHTML=externalShares.map(renderShareItem).join("\n");
}

function renderShareItem(share){
  const expired=!!share.expired;
  const itemClass=expired?"share-item expired":"share-item";
  const badgeLabel=expired?"期限切れ":"共有中";
  const info=getAudienceInfo(share.audience);
  const shareUrlRaw=share.url||"";
  const safeUrl=escapeHtml(shareUrlRaw);
  const expiresLabel=share.expiresAtText?`期限: ${escapeHtml(share.expiresAtText)}`:"期限: 設定なし";
  const attachmentsLabel=share.allowAllAttachments?"添付: すべて共有":`添付: ${share.allowedCount||0}件`;
  const passwordLabel=share.passwordProtected?"パスワードあり":"パスワードなし";
  const maskLabel=share.maskMode==='simple'?"本文マスクあり":"本文そのまま";
  const audienceLabel=`共有先: ${escapeHtml(info.label)}`;
  const rangeLabel=share.rangeLabel?`共有範囲: ${escapeHtml(share.rangeLabel)}`:"";
  const lastAccess=share.lastAccessText?`最終閲覧: ${escapeHtml(share.lastAccessText)}`:"";
  const remaining=share.remainingLabel?`有効期間: ${escapeHtml(share.remainingLabel)}`:"";
  const accessLabel=share.accessCount?`閲覧回数: ${share.accessCount}回`:"";
  const metaParts=[audienceLabel,expiresLabel,attachmentsLabel,passwordLabel,maskLabel,rangeLabel,remaining,lastAccess,accessLabel].filter(Boolean);
  const metaHtml=metaParts.map(p=>`<span>${p}</span>`).join("\n");
  const qrSrc=share.qrDataUrl||share.qrUrl||"";
  const fallbackQr=!qrSrc && shareUrlRaw?`https://chart.googleapis.com/chart?cht=qr&chs=220x220&choe=UTF-8&chl=${encodeURIComponent(shareUrlRaw)}`:"";
  const qrUrl=qrSrc||fallbackQr;
  const usingFallback=!qrSrc && !!fallbackQr;
  const fallbackNote=usingFallback?`<div class="share-qr-note">QRコードの生成に失敗したためGoogle Chart APIで代替表示しています。</div>`:"";
  const qrHtml=qrUrl?`<div class="share-qr"><img src="${qrUrl}" alt="共有QRコード"><div class="share-qr-actions"><div class="share-qr-url">${safeUrl}</div>`
    + `<div class="share-qr-buttons"><button class="secondary btn-compact" data-action="print-qr" data-token="${escapeHtml(share.token||'')}">QRコード・案内を印刷</button></div></div>${fallbackNote}</div>`:"";
  const descriptionHtml=info.description?`<div class="share-meta-notes">${escapeHtml(info.description)}</div>`:"";
  return `<div class="${itemClass}">`
    + `<div class="share-item-header"><span class="badge">${badgeLabel}</span>`
    + `<div class="share-url"><input type="text" readonly value="${safeUrl}" onclick="this.select();">`
    + `<button class="secondary btn-compact" data-action="copy-url" data-url="${safeUrl}">URLコピー</button>`
    + `</div></div>`
    + `<div class="tag-group">${metaHtml}</div>`
    + descriptionHtml
    + qrHtml
    + `<div class="share-actions">`
    + `<button class="danger btn-compact" data-action="revoke" data-token="${escapeHtml(share.token||'')}">リンク停止</button>`
    + `</div>`
    + `</div>`;
}

async function handleShareListClick(event){
  const btn=event.target.closest('[data-action]');
  if(!btn) return;
  const action=btn.dataset.action;
  if(action==='copy-url'){
    const url=btn.dataset.url||"";
    if(!url) return;
    const ok=await copyToClipboard(url);
    if(ok){
      const original=btn.textContent;
      btn.textContent="コピーしました";
      setTimeout(()=>{ btn.textContent=original||"URLコピー"; },1800);
    }else{
      alert("コピーできませんでした。手動で選択してください。");
    }
    return;
  }
  if(action==='print-qr'){
    const token=btn.dataset.token||"";
    if(!token) return;
    const share=externalShares.find(s=>s && s.token===token);
    if(!share){
      alert("共有情報が見つかりませんでした");
      return;
    }
    openSharePrintView(share);
    return;
  }
  if(action==='revoke'){
    const token=btn.dataset.token||"";
    if(!token) return;
    if(!confirm("この共有リンクを停止しますか？")) return;
    const status=document.getElementById("shareList");
    if(status) status.classList.add("muted");
    try {
      const res=await callGoogle("revokeExternalShare", token);
      if(!res || res.status!=="success"){
        const msg=res && res.message ? res.message : "停止に失敗しました";
        alert(msg);
      }
    } catch(err){
      alert(err && err.message ? err.message : "共有リンクの停止に失敗しました");
    }
    fetchExternalShareList();
  }
}

function openSharePrintView(share){
  if(!share || !share.url){
    alert("共有URLが見つかりませんでした");
    return;
  }
  const shareUrlRaw=share.url||"";
  const separator=shareUrlRaw.includes("?")?"&":"?";
  const printUrl=`${shareUrlRaw}${separator}print=1`;
  const win=window.open(printUrl,"_blank");
  if(!win){
    alert("ポップアップがブロックされました。ブラウザの設定をご確認ください。");
  }
}
async function handleCreateShare(event){
  if(event) event.preventDefault();
  if(!memberId){ alert("利用者を選択してください"); return; }
  const status=document.getElementById("shareFormStatus");
  if(status) status.textContent="共有リンクを発行しています…";
  try {
    const config=collectShareFormConfig();
    const res=await callGoogle("createExternalShare", memberId, config);
    if(!res || res.status!=="success"){
      const msg=res && res.message ? res.message : "共有リンクの発行に失敗しました";
      throw new Error(msg);
    }
    if(status) status.textContent="共有リンクを発行しました。リストからURLコピーやQR印刷ができます。";
    toggleShareForm(false);
    fetchExternalShareList();
  } catch(err){
    if(status) status.textContent="失敗: " + (err && err.message ? err.message : err);
  }
}

function collectShareFormConfig(){
  const audienceSelect=document.getElementById("shareAudience");
  const presetSelect=document.getElementById("shareExpiryPreset");
  const expires=document.getElementById("shareExpires");
  const password=document.getElementById("sharePassword");
  const mask=document.getElementById("shareMaskCheckbox");
  const shareAll=document.getElementById("shareAttachmentAll");
  const attachmentsContainer=document.getElementById("shareAttachments");
  const rangeSelect=document.getElementById("shareRange");
  const allowed=[];
  if(shareAll && shareAll.checked){
    allowed.push("__ALL__");
  }else if(attachmentsContainer){
    attachmentsContainer.querySelectorAll('input[type="checkbox"][data-file-id]').forEach(cb=>{
      if(cb.checked) allowed.push(cb.dataset.fileId);
    });
  }
  const audience=(audienceSelect && audienceSelect.value) ? audienceSelect.value : shareAudienceDefault;
  const preset=(presetSelect && presetSelect.value) ? presetSelect.value : shareExpiryPresetDefault;
  const rangeValue=(rangeSelect && rangeSelect.value) ? rangeSelect.value : shareRangeDefault;
  const config={
    audience,
    password: password ? password.value.trim() : "",
    maskMode: mask && mask.checked ? "simple" : "none",
    allowedAttachmentIds: allowed,
    range: rangeValue
  };
  if(preset === "custom"){
    if(!expires || !expires.value){
      throw new Error("共有期限の日付を入力してください。");
    }
    const iso=convertLocalDateTimeToIso(expires.value);
    if(!iso){
      throw new Error("共有期限の形式が正しくありません。");
    }
    config.expiresAt=iso;
  }else if(preset === "none"){
    // 無期限の場合はexpiresAt/expiresInDaysを設定しない
  }else{
    const days=Number(preset);
    if(!Number.isFinite(days) || days <= 0){
      throw new Error("共有期限の選択肢が不正です。");
    }
    config.expiresInDays=days;
  }
  return config;
}

function convertLocalDateTimeToIso(value){
  if(!value) return "";
  const m=value.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
  if(!m) return "";
  const date=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), Number(m[4]), Number(m[5]));
  if(Number.isNaN(date.getTime())) return "";
  return date.toISOString();
}

function toLocalDateTimeInputValue(date){
  if(!(date instanceof Date) || Number.isNaN(date.getTime())) return "";
  const pad=n=>String(n).padStart(2,"0");
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

function copyToClipboard(text){
  if(!text) return Promise.resolve(false);
  if(navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text).then(()=>true).catch(()=>fallbackCopy(text));
  }
  return fallbackCopy(text);
}

function fallbackCopy(text){
  try {
    const textarea=document.createElement("textarea");
    textarea.value=text;
    textarea.style.position="fixed";
    textarea.style.opacity="0";
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    const ok=document.execCommand("copy");
    document.body.removeChild(textarea);
    return Promise.resolve(ok);
  } catch(_err){
    return Promise.resolve(false);
  }
}

function initInternalApp(){
  document.body.classList.remove("external-mode");
  setupMemberUi();
  setupFilters();
  setupShareUi();
  resetShareListPlaceholder();
  }

function runAfterDomReady(fn){
  if(document.readyState === "loading"){
    window.addEventListener("DOMContentLoaded", fn);
  }else{
    fn();
  }
}

runAfterDomReady(()=>{
  refreshMemberList();
  setupSearchBox();
  initInternalApp();
});
</script>
</body>
</html>
