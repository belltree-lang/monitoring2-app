<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã‚±ã‚¢ãƒãƒãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</title>
<style>
:root {
  --fg:#222; --bg:#f4f6fa; --card:#fff; --brand:#1976d2;
  --muted:#555; --accent:#e3f2fd;
}
body { font-family:"Noto Sans JP",system-ui,sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--fg);}
h1 { margin:0 0 20px; font-size:1.6rem; color:var(--brand);}
h2 { margin:14px 0 8px; font-size:1.15rem; color:#333;}
.card { background:var(--card); border-radius:10px; padding:16px; margin-bottom:18px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);}
.toolbar { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0;}
input[type=text], select, textarea { font-family:inherit; border:1px solid #ccc; border-radius:6px; padding:8px 10px;}
textarea { width:100%; min-height:120px;}
button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; transition:.2s; font-size:0.85rem;}
button { background:var(--brand); color:#fff;}
button.secondary { background:#eee; color:#333;}
button.danger { background:#d32f2f; color:#fff;}
button:hover { opacity:0.9;}
.btn-compact { padding:4px 8px; font-size:0.8rem; }
.pill { display:inline-block; padding:4px 10px; font-size:.85rem; border-radius:999px; background:var(--accent); color:var(--brand);}
.autocomplete-list { position:absolute; background:#fff; border:1px solid #ccc; border-radius:6px;
  max-height:220px; overflow-y:auto; width:260px; box-shadow:0 2px 6px rgba(0,0,0,.1); z-index:100;}
.autocomplete-item { padding:8px 12px; cursor:pointer; font-size:0.9rem;}
.autocomplete-item:hover { background:var(--accent);}
.layout { display:grid; grid-template-columns:1fr 320px; gap:16px;}
@media(max-width:960px){.layout{grid-template-columns:1fr;}}
.record { margin-bottom:12px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff;}
.record .muted { font-size:0.85rem; color:#666;}
.record .toolbar { margin-top:6px;}

.record .text { margin:6px 0; font-size:0.92rem; white-space:pre-wrap; line-height:1.5; }
.record .attachments { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
.record .attachments a { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; font-size:0.8rem; border-radius:999px; background:#f0f4ff; color:var(--brand); text-decoration:none; }
.record .attachments a:hover { background:#dbe5ff; }
.search-toolbar { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 4px; }
.search-toolbar label { font-size:0.85rem; color:#666; display:flex; align-items:center; gap:6px; }
.search-toolbar input[type=date], .search-toolbar input[type=text] { font-size:0.85rem; }
.media-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); }
.media-card { border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.05); }
.media-card a { display:block; color:inherit; text-decoration:none; }
.media-card img { width:100%; height:100px; object-fit:cover; display:block; background:#f6f8fb; }
.media-card .media-icon { height:100px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; background:#f6f8fb; }
.media-card .media-meta { padding:8px; font-size:0.75rem; color:#555; }
.media-card .media-meta .name { font-weight:600; color:#333; margin-bottom:4px; }
.dashboard-table table { width:100%; border-collapse:collapse; }
.dashboard-table th, .dashboard-table td { text-align:left; padding:6px 4px; font-size:0.82rem; border-bottom:1px solid #eee; }
.dashboard-table tr.status-alert { background:#ffebee; }
.dashboard-table tr.status-ok { background:#f1f8e9; }
.dashboard-table tr.selected { outline:2px solid var(--brand); }
.dashboard-table .status-label { font-weight:600; }
.dashboard-table .status-ok .status-label { color:#2e7d32; }
.dashboard-table .status-alert .status-label { color:#c62828; }
.dashboard-table .actions { text-align:right; }
.dashboard-table a.link-button { display:inline-block; padding:4px 8px; border-radius:6px; background:#eee; color:#333; text-decoration:none; font-size:0.78rem; }
.dashboard-table a.link-button:hover { background:#ddd; }
.dashboard-controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
.dashboard-sort label { display:flex; align-items:center; gap:6px; font-size:0.78rem; color:var(--muted); }
.dashboard-sort select { font-size:0.8rem; padding:4px 6px; border-radius:6px; border:1px solid #ccd5e6; background:#fff; }
.dashboard-index { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
.dashboard-index button { background:#e9f0fb; color:#1c3a6b; border:none; border-radius:999px; padding:4px 10px; font-size:0.75rem; cursor:pointer; transition:.2s; }
.dashboard-index button:hover { opacity:0.85; }
.dashboard-index button.active { background:var(--brand); color:#fff; }
.dashboard-pagination { margin-top:10px; display:flex; align-items:center; gap:8px; justify-content:flex-end; font-size:0.78rem; color:var(--muted); }
.dashboard-pagination button { background:#e1e9fa; color:#1c3a6b; }
.dashboard-pagination button:disabled { background:#f3f6fc; color:#9aa4b5; cursor:not-allowed; opacity:0.65; }
.dashboard-pagination select { font-size:0.8rem; padding:4px 6px; border-radius:6px; border:1px solid #ccd5e6; background:#fff; }
.muted { color:#666; font-size:0.8rem; }
  
#mediaGallery { min-height:80px; }
.media-grid { display:flex; flex-direction:column; gap:8px; }
.media-item { background:#f7f9ff; border:1px solid #dbe6f6; border-radius:8px; padding:8px 10px; }
.media-item a { color:var(--brand); font-weight:600; text-decoration:none; word-break:break-all; }
.media-item a:hover { text-decoration:underline; }
.media-missing { color:#777; font-weight:600; word-break:break-all; }
.media-meta { margin-top:4px; font-size:0.78rem; color:var(--muted); display:flex; gap:6px; flex-wrap:wrap; }
</style>
</head>
<body>
<h1>ã‚±ã‚¢ãƒãƒãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° 
  <span class="pill" id="memberTag">æœªé¸æŠ</span>
</h1>

<!-- åˆ©ç”¨è€…é¸æŠ -->
<div class="card">
  <h2>åˆ©ç”¨è€…ã‚’é¸æŠ</h2>
  <div class="toolbar" style="position:relative;">
    <input type="text" id="memberIdInput" placeholder="IDã¾ãŸã¯æ°åã§æ¤œç´¢" autocomplete="off" style="min-width:260px;">
    <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
    <select id="recordRange">
      <option value="all">å…¨ä»¶</option>
      <option value="90">ç›´è¿‘90æ—¥</option>
      <option value="30" selected>ç›´è¿‘30æ—¥</option>
      <option value="7">ç›´è¿‘7æ—¥</option>
    </select>
    <button id="btnReload" class="secondary">æ›´æ–°</button>
  </div>
  <div id="idStatus" class="muted"></div>
</div>

<!-- æ–°è¦åˆ©ç”¨è€…ç™»éŒ² -->
<div class="card">
  <h2>æ–°è¦åˆ©ç”¨è€…ç™»éŒ²</h2>
  <div class="toolbar">
    <input type="text" id="newMemberId" placeholder="ID (4æ¡)" maxlength="4" style="width:100px;">
    <input type="text" id="newMemberName" placeholder="æ°åï¼ˆä¾‹: å±±ç”°ã€€å¤ªéƒï¼‰" style="flex:1;">
    <button id="btnAddMember">ç™»éŒ²</button>
  </div>
  <div id="addMemberStatus" class="muted"></div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³UI -->
<div id="mainArea" style="display:none;">
  <div class="layout">
    <div class="left">
      <!-- æ–°è¦è¨˜éŒ² -->
      <div class="card">
        <h2>æ–°è¦ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨˜éŒ²</h2>
        <div class="toolbar">
          <label for="kindSelect">ç¨®åˆ¥:</label>
          <select id="kindSelect">
            <option value="è¨ªå•">è¨ªå•</option>
            <option value="é›»è©±">é›»è©±</option>
            <option value="æ–½è¨­é¢è«‡">æ–½è¨­é¢è«‡</option>
            <option value="é€šæ‰€è¦³å¯Ÿ">é€šæ‰€è¦³å¯Ÿ</option>
            <option value="ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°">ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°</option>
            <option value="ãã®ä»–" selected>ãã®ä»–</option>
          </select>
        </div>
        <textarea id="inputText" placeholder="è¨˜éŒ²ã‚’å…¥åŠ›..."></textarea>
        <div class="toolbar">
          <input id="fileInput" type="file" multiple />
          <button id="btnSave">ä¿å­˜</button>
          <span id="saveStatus" class="muted"></span>
        </div>
      </div>
      <!-- AIè¦ç´„ -->
      <div class="card">
        <h2>AIè¦ç´„</h2>
        <div class="toolbar">
          <select id="summaryFormat">
            <option value="normal">æ¨™æº–</option>
            <option value="icf">ICFå½¢å¼</option>
            <option value="soap">SOAPå½¢å¼</option>
            <option value="doctor">åŒ»ç™‚é€£æº</option>
            <option value="family">å®¶æ—å‘ã‘</option>
          </select>
          <button id="btnSummary">è¦ç´„ç”Ÿæˆ</button>
        </div>
        <div id="summaryOutput" class="muted">ã“ã“ã«è¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
      <!-- ææ¡ˆ -->
      <div class="card">
        <h2>ã‚±ã‚¢ãƒãƒã‹ã‚‰ã®ææ¡ˆ</h2>
        <div class="toolbar">
          <select id="adviceHorizonSelect">
            <option value="now">ã™ãã«å¯¾å¿œ</option>
            <option value="2w">2é€±é–“</option>
            <option value="1m">1ã‹æœˆ</option>
            <option value="3m" selected>3ã‹æœˆ</option>
          </select>
          <button id="btnAdvice">ææ¡ˆç”Ÿæˆ</button>
        </div>
        <div id="adviceOutput" class="muted">ã“ã“ã«ææ¡ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
      <!-- éå»ã®è¨˜éŒ² -->
      <div class="card">
        <h2>éå»ã®è¨˜éŒ²</h2>
        <div class="search-toolbar">
          <label>ç¨®åˆ¥
            <select id="filterKind">
              <option value="all">ã™ã¹ã¦</option>
              <option value="è¨ªå•">è¨ªå•</option>
              <option value="é›»è©±">é›»è©±</option>
              <option value="æ–½è¨­é¢è«‡">æ–½è¨­é¢è«‡</option>
              <option value="é€šæ‰€è¦³å¯Ÿ">é€šæ‰€è¦³å¯Ÿ</option>
              <option value="ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°">ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </label>
          <label>é–‹å§‹
            <input type="date" id="filterDateFrom">
          </label>
          <label>çµ‚äº†
            <input type="date" id="filterDateTo">
          </label>
          <input type="text" id="filterText" placeholder="æœ¬æ–‡æ¤œç´¢ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰" style="flex:1; min-width:160px;">
          <button id="btnClearFilters" class="secondary btn-compact">ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="recordList" class="muted">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
    </div>
    <aside class="right">
      <div class="card">
        <h2>æ·»ä»˜ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
        <div id="mediaGallery" class="muted">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
      <div class="card">
        <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
        <div id="dashboardStatus" class="muted">èª­è¾¼ä¸­â€¦</div>
        <div id="dashboardTable" class="dashboard-table"></div>
      </div>
    </aside>
  </div>
</div>

<script>
let memberId = null, memberName = "";
let memberList = [];
let recordsCache = [];
let dashboardState = {
  data: [],
  monthLabel: "",
  sortKey: "name",
  sortDir: "asc",
  page: 1,
  pageSize: 50,
  activeInitial: null
};

const DASHBOARD_KANA_GROUPS = [
  { label: "ã‚", members: ["ã‚¢", "ã‚¤", "ã‚¦", "ã‚¨", "ã‚ª", "ã‚¡", "ã‚£", "ã‚¥", "ã‚§", "ã‚©"] },
  { label: "ã‹", members: ["ã‚«", "ã‚­", "ã‚¯", "ã‚±", "ã‚³", "ã‚¬", "ã‚®", "ã‚°", "ã‚²", "ã‚´"] },
  { label: "ã•", members: ["ã‚µ", "ã‚·", "ã‚¹", "ã‚»", "ã‚½", "ã‚¶", "ã‚¸", "ã‚º", "ã‚¼", "ã‚¾"] },
  { label: "ãŸ", members: ["ã‚¿", "ãƒ", "ãƒ„", "ãƒ†", "ãƒˆ", "ãƒ€", "ãƒ‚", "ãƒ…", "ãƒ‡", "ãƒ‰", "ãƒƒ"] },
  { label: "ãª", members: ["ãƒŠ", "ãƒ‹", "ãƒŒ", "ãƒ", "ãƒ"] },
  { label: "ã¯", members: ["ãƒ", "ãƒ’", "ãƒ•", "ãƒ˜", "ãƒ›", "ãƒ", "ãƒ“", "ãƒ–", "ãƒ™", "ãƒœ", "ãƒ‘", "ãƒ”", "ãƒ—", "ãƒš", "ãƒ"] },
  { label: "ã¾", members: ["ãƒ", "ãƒŸ", "ãƒ ", "ãƒ¡", "ãƒ¢"] },
  { label: "ã‚„", members: ["ãƒ¤", "ãƒ¦", "ãƒ¨", "ãƒ£", "ãƒ¥", "ãƒ§"] },
  { label: "ã‚‰", members: ["ãƒ©", "ãƒª", "ãƒ«", "ãƒ¬", "ãƒ­"] },
  { label: "ã‚", members: ["ãƒ¯", "ãƒ²", "ãƒ³"] }
];
const DASHBOARD_ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const DASHBOARD_COLLATOR = new Intl.Collator(["ja", "en"], { sensitivity: "base", numeric: true, caseFirst: "false" });

function toKatakanaChar(ch) {
  if (!ch) return "";
  const code = ch.charCodeAt(0);
  if (code >= 0x3041 && code <= 0x3096) {
    return String.fromCharCode(code + 0x60);
  }
  return ch;
}

function getInitialGroupFromName(name) {
  const base = String(name || "").trim();
  if (!base) return "#";
  const firstChar = base[0].normalize("NFKC");
  if (!firstChar) return "#";
  const katakana = toKatakanaChar(firstChar);
  for (const group of DASHBOARD_KANA_GROUPS) {
    if (group.members.includes(katakana)) {
      return group.label;
    }
  }
  const upper = firstChar.toUpperCase();
  if (DASHBOARD_ALPHABET.includes(upper)) {
    return upper;
  }
  if (/\d/.test(firstChar)) {
    return "0-9";
  }
  return "#";
}

function getDashboardIndexGroups(sortedData) {
  const exists = new Set();
  (Array.isArray(sortedData) ? sortedData : []).forEach(entry => {
    const label = getInitialGroupFromName(entry && (entry.name || entry.id));
    exists.add(label);
  });
  const order = [
    ...DASHBOARD_KANA_GROUPS.map(g => g.label),
    ...DASHBOARD_ALPHABET,
    "0-9",
    "#"
  ];
  return order.filter(label => exists.has(label));
}

function getEntryLatestTimestamp(entry) {
  if (!entry) return NaN;
  const candidates = [
    entry.latestTimestamp,
    entry.latestDate,
    entry.latestDateValue,
    entry.latestDateText
  ];
  for (const value of candidates) {
    if (typeof value === "number" && isFinite(value)) return value;
    if (value instanceof Date && isFinite(value.getTime())) return value.getTime();
    if (typeof value === "string" && value) {
      const parsed = Date.parse(value);
      if (!isNaN(parsed)) return parsed;
    }
  }
  return NaN;
}

function getSortedDashboardData() {
  const data = Array.isArray(dashboardState.data) ? dashboardState.data.slice() : [];
  const dir = dashboardState.sortDir === "desc" ? -1 : 1;
  const sortKey = dashboardState.sortKey || "name";
  data.sort((a, b) => {
    const nameA = String(a && a.name || "").trim();
    const nameB = String(b && b.name || "").trim();
    const idA = String(a && a.id || "").trim();
    const idB = String(b && b.id || "").trim();
    if (sortKey === "latest") {
      const tsA = getEntryLatestTimestamp(a);
      const tsB = getEntryLatestTimestamp(b);
      const safeA = Number.isFinite(tsA) ? tsA : (dir === -1 ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY);
      const safeB = Number.isFinite(tsB) ? tsB : (dir === -1 ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY);
      if (safeA !== safeB) {
        return (safeA - safeB) * dir;
      }
      const cmpName = DASHBOARD_COLLATOR.compare(nameA, nameB);
      if (cmpName !== 0) return cmpName;
      return DASHBOARD_COLLATOR.compare(idA, idB);
    }
    if (sortKey === "id") {
      const cmpId = DASHBOARD_COLLATOR.compare(idA, idB);
      if (cmpId !== 0) return cmpId * dir;
      return DASHBOARD_COLLATOR.compare(nameA, nameB);
    }
    const cmpName = DASHBOARD_COLLATOR.compare(nameA, nameB);
    if (cmpName !== 0) return cmpName * dir;
    const cmpId = DASHBOARD_COLLATOR.compare(idA, idB);
    if (cmpId !== 0) return cmpId * dir;
    return 0;
  });
  return data;
}

function jumpToDashboardInitial(label) {
  if (!label || dashboardState.sortKey !== "name") return;
  const sorted = getSortedDashboardData();
  const index = sorted.findIndex(entry => getInitialGroupFromName(entry && (entry.name || entry.id)) === label);
  if (index < 0) return;
  const pageSize = dashboardState.pageSize || 50;
  dashboardState.page = Math.floor(index / pageSize) + 1;
  dashboardState.activeInitial = label;
  renderDashboard();
}

function toHalfDigits(s) {
  return String(s || "").replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));
}

const queryParams = new URLSearchParams(window.location.search);
let initialMemberId = (() => {
  const raw = queryParams.get("id") || "";
  if (!raw) return "";
  const half = toHalfDigits(raw.trim());
  if (!half) return "";
  if (/^\d{1,4}$/.test(half)) return ("0000" + half).slice(-4);
  return "";
})();

function escapeHtml(value) {
  const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };
  return String(value ?? "").replace(/[&<>"']/g, ch => map[ch]);
}

function callGoogle(functionName, ...args) {
  return new Promise((resolve, reject) => {
    try {
      const runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(err => reject(err));
      runner[functionName](...args);
    } catch (e) {
      reject(e);
    }
  });
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = String(reader.result || "");
      const base64 = result.includes(",") ? result.split(",")[1] : result;
      resolve({
        base64,
        mimeType: file.type || "application/octet-stream",
        name: file.name || "attachment"
      });
    };
    reader.onerror = () => reject(reader.error || new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    reader.readAsDataURL(file);
  });
}

function getRecordTimestamp(record) {
  if (record && typeof record.timestamp === "number" && !isNaN(record.timestamp)) {
    return record.timestamp;
  }
  if (record && record.date instanceof Date && !isNaN(record.date.getTime())) {
    return record.date.getTime();
  }
  const raw = record && (record.dateValue || record.dateText || record.date);
  const parsed = raw ? Date.parse(raw) : NaN;
  return isNaN(parsed) ? null : parsed;
}

function normalizeRecord(record) {
  const attachments = Array.isArray(record.attachments) ? record.attachments : [];
  return {
    ...record,
    attachments,
    timestamp: getRecordTimestamp(record)
  };
}

function buildAttachmentViewUrl(att) {
  if (!att) return "#";
  if (att.url) return att.url;
  if (att.fileId) return "https://drive.google.com/file/d/" + att.fileId + "/view";
  return "#";
}

function buildAttachmentThumbnailUrl(att) {
  if (!att) return "";
  if (att.fileId) {
    return "https://drive.google.com/thumbnail?id=" + att.fileId + "&sz=w200";
  }
  return "";
}

function refreshMemberList() {
  google.script.run.withSuccessHandler(list => {
    memberList = Array.isArray(list) ? list : [];
    if (initialMemberId && !memberId) {
      const hit = memberList.find(m => m.id === initialMemberId);
      if (hit) {
        selectMember(hit.id, hit.name);
        initialMemberId = "";
      } else if (/^\d{4}$/.test(initialMemberId)) {
        selectMember(initialMemberId, "");
        initialMemberId = "";
      }
    }
  }).withFailureHandler(err => {
    console.error("member list error", err);
  }).getMemberList();
}

function loadDashboard() {
  const statusEl = document.getElementById("dashboardStatus");
  const container = document.getElementById("dashboardTable");
  statusEl.textContent = "èª­è¾¼ä¸­â€¦";
  container.innerHTML = "";
  callGoogle("getDashboardSummary").then(res => {
    if (!res || res.status !== "success") {
      statusEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + (res && res.message ? res.message : "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      dashboardState.data = [];
      dashboardState.monthLabel = "";
      dashboardState.page = 1;
      dashboardState.activeInitial = null;
      container.innerHTML = "";
      return;
    }
    dashboardState.data = Array.isArray(res.data) ? res.data : [];
    dashboardState.monthLabel = res.monthLabel || "";
    dashboardState.page = 1;
    dashboardState.activeInitial = null;
    statusEl.textContent = dashboardState.monthLabel ? "å¯¾è±¡æœˆï¼š" + dashboardState.monthLabel : "";
    renderDashboard();
  }).catch(err => {
    console.error("dashboard error", err);
    statusEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + (err && err.message ? err.message : err);
    dashboardState.data = [];
    dashboardState.monthLabel = "";
    dashboardState.page = 1;
    dashboardState.activeInitial = null;
  });
}

function renderDashboard() {
  const container = document.getElementById("dashboardTable");
  if (!container) return;
  const sortedData = getSortedDashboardData();
  if (!sortedData.length) {
    container.innerHTML = "<div class=\"muted\">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>";
    return;
  }
  const pageSize = dashboardState.pageSize || 50;
  const total = sortedData.length;
  const pageCount = Math.max(1, Math.ceil(total / pageSize));
  if (!Number.isFinite(dashboardState.page) || dashboardState.page < 1) {
    dashboardState.page = 1;
  }
  if (dashboardState.page > pageCount) {
    dashboardState.page = pageCount;
  }
  const page = dashboardState.page;
  const offset = (page - 1) * pageSize;
  const currentItems = sortedData.slice(offset, offset + pageSize);
  const rangeStart = offset + 1;
  const rangeEnd = offset + currentItems.length;
  const showIndex = dashboardState.sortKey === "name";
  let activeInitial = showIndex ? (dashboardState.activeInitial || "") : "";
  if (showIndex) {
    if (!activeInitial && currentItems.length) {
      activeInitial = getInitialGroupFromName(currentItems[0] && (currentItems[0].name || currentItems[0].id));
    }
    dashboardState.activeInitial = activeInitial || null;
  } else {
    dashboardState.activeInitial = null;
    activeInitial = "";
  }
  const indexGroups = showIndex ? getDashboardIndexGroups(sortedData) : [];
  const rows = currentItems.map(entry => {
    const statusOk = Number(entry.countThisMonth || 0) > 0;
    const rowClass = statusOk ? "status-ok" : "status-alert";
    const selected = memberId && entry.id === memberId ? " selected" : "";
    const statusLabel = statusOk ? "âœ… ä»Šæœˆå…¥åŠ›ã‚ã‚Š" : "âš ï¸ ä»Šæœˆæœªå…¥åŠ›";
    const latest = entry.latestDateText ? escapeHtml(entry.latestDateText) : "---";
    const safeId = escapeHtml(entry.id || "");
    const safeName = escapeHtml(entry.name || "");
    const link = "?id=" + encodeURIComponent(entry.id || "");
    return [
      "<tr class=\"" + rowClass + selected + "\">",
      "<td>" + safeId + "</td>",
      "<td>" + safeName + "</td>",
      "<td>" + (entry.countThisMonth || 0) + "</td>",
      "<td>" + latest + "</td>",
      "<td><span class=\"status-label\">" + statusLabel + "</span></td>",
      "<td class=\"actions\">",
      "<button class=\"secondary btn-compact dashboard-select\" data-id=\"" + safeId + "\" data-name=\"" + safeName + "\">è¡¨ç¤º</button>",
      " <a class=\"link-button\" href=\"" + link + "\">è©³ç´°</a>",
      "</td>",
      "</tr>"
    ].join("");
  }).join("");
  const sortOptions = [
    { value: "name:asc", label: "æ°åï¼ˆã‚â†’ã‚“é †ï¼‰" },
    { value: "name:desc", label: "æ°åï¼ˆã‚“â†’ã‚é †ï¼‰" },
    { value: "latest:desc", label: "æœ€æ–°è¨˜éŒ²æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰" },
    { value: "latest:asc", label: "æœ€æ–°è¨˜éŒ²æ—¥ï¼ˆå¤ã„é †ï¼‰" },
    { value: "id:asc", label: "IDï¼ˆæ˜‡é †ï¼‰" },
    { value: "id:desc", label: "IDï¼ˆé™é †ï¼‰" }
  ];
  const sortValue = `${dashboardState.sortKey}:${dashboardState.sortDir}`;
  const sortHtml = sortOptions.map(opt => `<option value="${opt.value}"${opt.value === sortValue ? " selected" : ""}>${opt.label}</option>`).join("");
  let indexSection = "";
  if (showIndex && indexGroups.length) {
    const buttons = indexGroups.map(label => `<button type="button" class="dashboard-index-btn${label === activeInitial ? " active" : ""}" data-index="${label}">${label}</button>`).join("");
    indexSection = `<div class="dashboard-index" role="navigation" aria-label="ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ã‚¸ãƒ£ãƒ³ãƒ—">${buttons}</div>`;
  } else if (!showIndex) {
    indexSection = `<div class="dashboard-index muted">æ°åé †ã‚½ãƒ¼ãƒˆæ™‚ã«ã‚¸ãƒ£ãƒ³ãƒ—ãŒåˆ©ç”¨ã§ãã¾ã™</div>`;
  }
  const paginationHtml = (() => {
    if (pageCount <= 1) {
      return `<div class="dashboard-pagination"><span>${rangeStart}ã€œ${rangeEnd}ä»¶ / å…¨${total}ä»¶</span></div>`;
    }
    const options = Array.from({ length: pageCount }, (_, i) => `<option value="${i + 1}"${i + 1 === page ? " selected" : ""}>${i + 1}</option>`).join("");
    return `
      <div class="dashboard-pagination">
        <button type="button" class="btn-compact dashboard-page-prev"${page <= 1 ? " disabled" : ""}>å‰ã¸</button>
        <span>ãƒšãƒ¼ã‚¸</span>
        <select id="dashboardPageSelect">${options}</select>
        <span>/ ${pageCount}</span>
        <button type="button" class="btn-compact dashboard-page-next"${page >= pageCount ? " disabled" : ""}>æ¬¡ã¸</button>
        <span>${rangeStart}ã€œ${rangeEnd}ä»¶ / å…¨${total}ä»¶</span>
      </div>
    `;
  })();
  container.innerHTML = `
    <div class="dashboard-controls">
      <div class="dashboard-sort">
        <label>ä¸¦ã³æ›¿ãˆ
          <select id="dashboardSort">${sortHtml}</select>
        </label>
      </div>
      ${indexSection || ""}
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>æ°å</th>
          <th>ä»Šæœˆã®è¨˜éŒ²ä»¶æ•°</th>
          <th>æœ€æ–°è¨˜éŒ²æ—¥</th>
          <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th class="actions">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    ${paginationHtml}
  `;
  bindDashboardActions();
  bindDashboardControlEvents(pageCount);
}

function bindDashboardControlEvents(pageCount) {
  const container = document.getElementById("dashboardTable");
  if (!container) return;
  const sortSelect = container.querySelector("#dashboardSort");
  if (sortSelect) {
    sortSelect.onchange = (event) => {
      const raw = String(event.target.value || "");
      const [key, dir] = raw.split(":");
      dashboardState.sortKey = key || "name";
      dashboardState.sortDir = dir === "desc" ? "desc" : "asc";
      dashboardState.page = 1;
      dashboardState.activeInitial = null;
      renderDashboard();
    };
  }
  container.querySelectorAll(".dashboard-index-btn").forEach(btn => {
    const label = btn.dataset.index || "";
    btn.onclick = () => { jumpToDashboardInitial(label); };
  });
  const prevBtn = container.querySelector(".dashboard-page-prev");
  if (prevBtn) {
    prevBtn.onclick = () => {
      if (dashboardState.page <= 1) return;
      dashboardState.page -= 1;
      dashboardState.activeInitial = null;
      renderDashboard();
    };
  }
  const nextBtn = container.querySelector(".dashboard-page-next");
  if (nextBtn) {
    nextBtn.onclick = () => {
      if (dashboardState.page >= pageCount) return;
      dashboardState.page += 1;
      dashboardState.activeInitial = null;
      renderDashboard();
    };
  }
  const pageSelect = container.querySelector("#dashboardPageSelect");
  if (pageSelect) {
    pageSelect.value = String(dashboardState.page || 1);
    pageSelect.onchange = (event) => {
      const value = Number(event.target.value || 1);
      const clamped = Math.min(Math.max(Math.round(value) || 1, 1), pageCount);
      dashboardState.page = clamped;
      dashboardState.activeInitial = null;
      renderDashboard();
    };
  }
}

function bindDashboardActions() {
  document.querySelectorAll(".dashboard-select").forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.id || "";
      const name = btn.dataset.name || "";
      selectMember(toHalfDigits(id), name);
    };
  });
}

const input = document.getElementById("memberIdInput");
const listBox = document.getElementById("autocompleteList");

input.addEventListener("input", () => {
  const qRaw = input.value.trim();
  if (!qRaw) { listBox.style.display = "none"; return; }
  const q = toHalfDigits(qRaw);
  const hits = memberList.filter(m => m.id.includes(q) || m.name.includes(qRaw));
  if (!hits.length) { listBox.style.display = "none"; return; }
  listBox.innerHTML = hits.map(m => `<div class="autocomplete-item" data-id="${m.id}" data-name="${escapeHtml(m.name)}">${m.id}ã€€${escapeHtml(m.name)}</div>`).join("");
  listBox.style.display = "block";
});
listBox.addEventListener("click", e => {
  const item = e.target.closest(".autocomplete-item");
  if (!item) return;
  selectMember(item.dataset.id, item.dataset.name);
});
input.addEventListener("keydown", e => {
  if (e.key === "Enter") { e.preventDefault(); resolveInput(); }
});
input.addEventListener("blur", () => { setTimeout(resolveInput, 100); });

function resolveInput() {
  const val = input.value.trim();
  if (!val) return;
  const half = toHalfDigits(val);
  const hit = memberList.find(m => m.id === half || m.name === val);
  if (hit) { selectMember(hit.id, hit.name); return; }
  if (/^\d{4}$/.test(half)) { selectMember(half, ""); return; }
  document.getElementById("idStatus").textContent = "å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
}

function selectMember(id, name) {
  memberId = id;
  memberName = name || "";
  input.value = `${id}${memberName ? "ã€€" + memberName : ""}`;
  listBox.style.display = "none";
  document.getElementById("idStatus").textContent = `é¸æŠä¸­: ${id}${memberName ? "ã€€" + memberName : ""}`;
  document.getElementById("memberTag").textContent = `${id}${memberName ? "ã€€" + memberName : ""}`;
  document.getElementById("mainArea").style.display = "";
  document.getElementById("filterKind").value = "all";
  document.getElementById("filterDateFrom").value = "";
  document.getElementById("filterDateTo").value = "";
  document.getElementById("filterText").value = "";
  document.getElementById("summaryOutput").textContent = "ã“ã“ã«è¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
  document.getElementById("adviceOutput").textContent = "ã“ã“ã«ææ¡ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
  updateMediaGallery([]);
  renderDashboard();
  loadRecords();
}

document.getElementById("btnAddMember").onclick = () => {
  const idInput = document.getElementById("newMemberId");
  const nameInput = document.getElementById("newMemberName");
  const id = idInput.value.trim();
  const name = nameInput.value.trim();
  const status = document.getElementById("addMemberStatus");
  if (!id || !name) { status.textContent = "IDã¨æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
  google.script.run.withSuccessHandler(res => {
    if (res.status === "success") {
      status.textContent = `ç™»éŒ²ã—ã¾ã—ãŸ: ${res.id} ${res.name}`;
      idInput.value = "";
      nameInput.value = "";
      refreshMemberList();
      loadDashboard();
    } else {
      status.textContent = "å¤±æ•—: " + res.message;
    }
  }).withFailureHandler(err => {
    status.textContent = "ã‚¨ãƒ©ãƒ¼: " + (err && err.message ? err.message : err);
  }).addMember(id, name);
};

document.getElementById("btnSave").addEventListener("click", handleSave);

async function handleSave() {
  const text = document.getElementById("inputText").value.trim();
  const files = Array.from(document.getElementById("fileInput").files || []);
  const status = document.getElementById("saveStatus");
  if (!memberId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  if (!text && files.length === 0) { alert("å†…å®¹ã¾ãŸã¯æ·»ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  status.textContent = "é€ä¿¡ä¸­â€¦";
  try {
    const kind = document.getElementById("kindSelect").value;
    const attachmentsMeta = [];
    for (const file of files) {
      const payload = await readFileAsBase64(file);
      const uploadRes = await callGoogle("uploadAttachment_", memberId, payload.name, payload.mimeType, payload.base64);
      if (!uploadRes || uploadRes.status !== "success") {
        throw new Error(uploadRes && uploadRes.message ? uploadRes.message : "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      attachmentsMeta.push({
        fileId: uploadRes.fileId,
        url: uploadRes.url,
        name: uploadRes.name || payload.name,
        mimeType: uploadRes.mimeType || payload.mimeType
      });
    }
    await callGoogle("saveRecordFromBrowser", memberId, text, new Date().toISOString(), JSON.stringify(attachmentsMeta), kind);
    status.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
    document.getElementById("inputText").value = "";
    document.getElementById("fileInput").value = "";
    setTimeout(() => { status.textContent = ""; }, 3000);
    loadRecords();
    loadDashboard();
  } catch (err) {
    status.textContent = "å¤±æ•—: " + (err && err.message ? err.message : err);
  }
}

document.getElementById("btnSummary").onclick = () => {
  if (!memberId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  const fmt = document.getElementById("summaryFormat").value;
  const days = document.getElementById("recordRange").value;
  const out = document.getElementById("summaryOutput");
  out.textContent = "ç”Ÿæˆä¸­â€¦";
  google.script.run.withSuccessHandler(res => {
    out.textContent = (res.status === "success") ? res.summary : ("å¤±æ•—:" + res.message);
  }).withFailureHandler(err => {
    out.textContent = "å¤±æ•—: " + (err && err.message ? err.message : err);
  }).generateAISummaryForDays(memberId, fmt, days);
};

document.getElementById("btnAdvice").onclick = () => {
  if (!memberId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  const horizon = document.getElementById("adviceHorizonSelect").value;
  const days = document.getElementById("recordRange").value;
  const out = document.getElementById("adviceOutput");
  out.textContent = "ç”Ÿæˆä¸­â€¦";
  google.script.run.withSuccessHandler(res => {
    out.textContent = (res.status === "success") ? res.advice : ("å¤±æ•—:" + res.message);
  }).withFailureHandler(err => {
    out.textContent = "å¤±æ•—: " + (err && err.message ? err.message : err);
  }).generateCareAdviceWithHorizon(memberId, days, horizon);
};


function loadRecords() {
  const days = document.getElementById("recordRange").value;
  const list = document.getElementById("recordList");
  if (!memberId) {
    list.textContent = "åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„";
    recordsCache = [];
    updateMediaGallery([]);
    return;
  }
  list.textContent = "èª­è¾¼ä¸­â€¦";
  google.script.run.withSuccessHandler(res => {
    if (!res || res.status !== "success") {
      list.textContent = "ã‚¨ãƒ©ãƒ¼:" + (res && res.message ? res.message : "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      recordsCache = [];
      updateMediaGallery([]);
      return;
    }
    recordsCache = (res.records || []).map(normalizeRecord);
    renderRecords();
  }).withFailureHandler(err => {
    list.textContent = "ã‚¨ãƒ©ãƒ¼: " + (err && err.message ? err.message : err);
    recordsCache = [];
    updateMediaGallery([]);
  }).getRecordsByMemberId_v3(memberId, days);
}

document.getElementById("btnReload").onclick = () => loadRecords();
document.getElementById("recordRange").addEventListener("change", () => {
  if (memberId) loadRecords();
});

function renderRecords() {
  const list = document.getElementById("recordList");
  if (!memberId) {
    list.textContent = "åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„";
    updateMediaGallery([]);
    return;
  }
  if (!recordsCache.length) {
    list.textContent = "è¨˜éŒ²ãªã—";
    updateMediaGallery([]);
    return;
  }
  const filtered = filterRecords(recordsCache);
  if (!filtered.length) {
    list.textContent = "æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
    updateMediaGallery([]);
    return;
  }
  const html = filtered.map((r, idx) => {
    const text = escapeHtml(r.text || "").replace(/\n/g, "<br>");
    const attachmentsHtml = (r.attachments && r.attachments.length)
      ? `<div class="attachments">${r.attachments.map((att, i) => renderAttachment(att, r, i)).join("")}</div>`
      : "";
    return `<div class="record" data-row="${r.rowIndex}">
      <div><b>${escapeHtml(r.dateText || "")}</b>ã€${escapeHtml(r.kind || "")}ã€‘</div>
      <div class="text">${text || '<span class="muted">ï¼ˆæœ¬æ–‡ãªã—ï¼‰</span>'}</div>
      ${attachmentsHtml}
      <div class="toolbar">
        <button class="secondary btnEdit">ç·¨é›†</button>
        <button class="danger btnDelete">å‰Šé™¤</button>
      </div>
    </div>`;
  }).join("");
  list.innerHTML = html;
  bindRecordActions();
  updateMediaGallery(filtered);
}

function renderAttachment(att, record, index) {
  const url = escapeHtml(buildAttachmentViewUrl(att));
  const label = escapeHtml(att && att.name ? att.name : `æ·»ä»˜${index + 1}`);
  return `<a href="${url}" target="_blank" rel="noopener">ğŸ“ ${label}</a>`;
}

function filterRecords(records) {
  const kind = document.getElementById("filterKind").value;
  const text = document.getElementById("filterText").value.trim().toLowerCase();
  const fromVal = document.getElementById("filterDateFrom").value;
  const toVal = document.getElementById("filterDateTo").value;
  const fromTime = fromVal ? new Date(fromVal + "T00:00:00").getTime() : null;
  const toTime = toVal ? new Date(toVal + "T23:59:59").getTime() : null;
  return records.filter(r => {
    const ts = getRecordTimestamp(r);
    if (kind && kind !== "all" && String(r.kind) !== kind) return false;
    if (fromTime && (ts === null || ts < fromTime)) return false;
    if (toTime && (ts === null || ts > toTime)) return false;
    if (text) {
      const hay = `${(r.text || "").toLowerCase()} ${(r.kind || "").toLowerCase()}`;
      if (!hay.includes(text)) return false;
    }
    return true;
  }).sort((a, b) => (getRecordTimestamp(b) || 0) - (getRecordTimestamp(a) || 0));
}

function updateMediaGallery(records) {
  const gallery = document.getElementById("mediaGallery");
  if (!records || !records.length) {
    gallery.textContent = "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“";
    return;
  }
  const items = [];
  records.forEach(r => {
    if (Array.isArray(r.attachments)) {
      r.attachments.forEach(att => items.push({ attachment: att, record: r }));
    }
  });
  if (!items.length) {
    gallery.textContent = "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“";
    return;
  }
  const cards = items.map(item => {
    const att = item.attachment || {};
    const rec = item.record || {};
    const viewUrl = escapeHtml(buildAttachmentViewUrl(att));
    const thumbUrlRaw = buildAttachmentThumbnailUrl(att);
    const thumbUrl = thumbUrlRaw ? escapeHtml(thumbUrlRaw) : "";
    const isImage = att.mimeType && att.mimeType.indexOf("image/") === 0;
    const preview = (isImage && thumbUrl)
      ? `<img src="${thumbUrl}" alt="${escapeHtml(att.name || "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«")}ã®ã‚µãƒ ãƒã‚¤ãƒ«">`
      : `<div class="media-icon">ğŸ“</div>`;
    return `<div class="media-card">
      <a href="${viewUrl}" target="_blank" rel="noopener">
        ${preview}
        <div class="media-meta">
          <div class="name">${escapeHtml(att.name || "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«")}</div>
          <div>${escapeHtml(rec.dateText || "")}</div>
        </div>
      </a>
    </div>`;
  }).join("");
  gallery.innerHTML = `<div class="media-grid">${cards}</div>`;
}

// ===== éå»è¨˜éŒ²ï¼ˆç·¨é›†ãƒ»å‰Šé™¤ä»˜ãï¼‰ =====
function loadRecords(){
  const days=document.getElementById("recordRange").value;
  const list=document.getElementById("recordList");
  if(!memberId){
    list.textContent="åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„";
    setGalleryMessage("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }
  list.textContent="èª­è¾¼ä¸­â€¦";
  setGalleryMessage("æ·»ä»˜ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦");
  google.script.run.withSuccessHandler(res=>{
    if(res.status!=="success"){
      list.textContent="ã‚¨ãƒ©ãƒ¼:"+(res.message||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
      setGalleryMessage("æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
      return;
    }
    const records=Array.isArray(res.records)?res.records:[];
    renderMediaGallery(records);
    if(!records.length){
      list.textContent="è¨˜éŒ²ãªã—";
      return;
    }
    list.innerHTML=records.map(r=>
      `<div class="record" data-row="${r.rowIndex}">
        <div><b>${r.dateText}</b>ã€${r.kind}ã€‘</div>
        <div class="text">${r.text}</div>
        <div class="toolbar">
          <button class="secondary btnEdit">ç·¨é›†</button>
          <button class="danger btnDelete">å‰Šé™¤</button>
        </div>
      </div>`
    ).join("");
    bindRecordActions();
  }).withFailureHandler(err=>{
    const msg=(err&&err.message)||err||"ä¸æ˜ãªã‚¨ãƒ©ãƒ¼";
    list.textContent="ã‚¨ãƒ©ãƒ¼:"+msg;
    setGalleryMessage("æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
  }).getRecordsByMemberId_v3(memberId,days);
}

function bindRecordActions() {
  document.querySelectorAll(".btnEdit").forEach(btn => {
    btn.onclick = () => {
      const rec = btn.closest(".record");
      if (!rec) return;
      const row = rec.dataset.row;
      const textEl = rec.querySelector(".text");
      const oldText = textEl ? textEl.textContent : "";
      const nv = prompt("å†…å®¹ã‚’ä¿®æ­£:", oldText);
      if (nv === null) return;
      google.script.run.withSuccessHandler(() => {
        loadRecords();
      }).withFailureHandler(err => {
        alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err && err.message ? err.message : err));
      }).updateRecord(row, nv);
    };
  });
  document.querySelectorAll(".btnDelete").forEach(btn => {
    btn.onclick = () => {
      const rec = btn.closest(".record");
      if (!rec) return;
      const row = rec.dataset.row;
      if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      google.script.run.withSuccessHandler(() => {
        loadRecords();
        loadDashboard();
      }).withFailureHandler(err => {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err && err.message ? err.message : err));
      }).deleteRecord(row);
    };
  });
}


["filterKind", "filterDateFrom", "filterDateTo"].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener("change", () => { renderRecords(); });
  }
});
document.getElementById("filterText").addEventListener("input", () => { renderRecords(); });
document.getElementById("btnClearFilters").addEventListener("click", () => {
  document.getElementById("filterKind").value = "all";
  document.getElementById("filterDateFrom").value = "";
  document.getElementById("filterDateTo").value = "";
  document.getElementById("filterText").value = "";
  renderRecords();
});

refreshMemberList();
loadDashboard();

function setGalleryMessage(message){
  const gallery=document.getElementById("mediaGallery");
  if(!gallery) return;
  gallery.classList.add("muted");
  gallery.innerHTML="";
  gallery.textContent=message;
}

function renderMediaGallery(records){
  const gallery=document.getElementById("mediaGallery");
  if(!gallery) return;
  gallery.innerHTML="";
  const attachments=[];
  (Array.isArray(records)?records:[]).forEach(record=>{
    if(!record) return;
    const files=Array.isArray(record.attachments)?record.attachments:[];
    files.forEach(att=>{
      if(att==null) return;
      const normalized=(typeof att==="object" && !Array.isArray(att))?{...att}:{ name:String(att)};
      normalized.recordDate=record.dateText;
      attachments.push(normalized);
    });
  });
  if(!attachments.length){
    setGalleryMessage("æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  gallery.classList.remove("muted");
  const container=document.createElement("div");
  container.className="media-grid";
  attachments.sort((a,b)=>{
    const tb=getAttachmentTime(b);
    const ta=getAttachmentTime(a);
    if(isNaN(ta) && isNaN(tb)) return 0;
    if(isNaN(ta)) return 1;
    if(isNaN(tb)) return -1;
    return tb-ta;
  });
  attachments.forEach(att=>{
    const item=document.createElement("div");
    item.className="media-item";
    const label=att.name||att.fileName||att.title||att.displayName||"åç§°æœªè¨­å®šã®ãƒ•ã‚¡ã‚¤ãƒ«";
    if(att.url){
      const link=document.createElement("a");
      link.href=att.url;
      link.target="_blank";
      link.rel="noopener noreferrer";
      link.textContent=label;
      item.appendChild(link);
    }else{
      const span=document.createElement("span");
      span.className="media-missing";
      span.textContent=label;
      item.appendChild(span);
    }
    const metaParts=[];
    const uploadedLabel=formatDateTime(att.uploadedAt||att.createdAt||att.timestamp);
    if(uploadedLabel){
      metaParts.push(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ${uploadedLabel}`);
    }else if(att.recordDate){
      metaParts.push(`è¨˜éŒ²æ—¥: ${att.recordDate}`);
    }
    if(att.mimeType) metaParts.push(att.mimeType);
    if(!att.url) metaParts.push("ãƒªãƒ³ã‚¯æƒ…å ±ãªã—");
    if(metaParts.length){
      const meta=document.createElement("div");
      meta.className="media-meta";
      meta.textContent=metaParts.join(" ï½œ ");
      item.appendChild(meta);
    }
    container.appendChild(item);
  });
  gallery.appendChild(container);
}

function getAttachmentTime(att){
  if(!att) return NaN;
  const candidate=att.uploadedAt||att.createdAt||att.timestamp||att.recordDate;
  return toTime(candidate);
}

function toTime(value){
  if(!value) return NaN;
  const d=new Date(value);
  const t=d.getTime();
  return Number.isNaN(t)?NaN:t;
}

function formatDateTime(value){
  const t=toTime(value);
  if(Number.isNaN(t)) return "";
  const d=new Date(t);
  const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
</script>
</body>
</html>