<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã‚±ã‚¢ãƒãƒãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</title>
<style>
:root {
  --fg:#222; --bg:#f4f6fa; --card:#fff; --brand:#1976d2;
  --muted:#555; --accent:#e3f2fd;
}
body { font-family:"Noto Sans JP",system-ui,sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--fg);}
h1 { margin:0 0 20px; font-size:1.6rem; color:var(--brand);}
h2 { margin:14px 0 8px; font-size:1.15rem; color:#333;}
.card { background:var(--card); border-radius:10px; padding:16px; margin-bottom:18px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);}
.card-row { display:grid; gap:16px; margin-bottom:18px; }
.card-row>.card { margin-bottom:0; display:flex; flex-direction:column; }
.card-row--member { grid-template-columns:minmax(320px,1.6fr) minmax(260px,1fr); align-items:stretch; }
.card-row--insights { grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); align-items:stretch; }
.card-row--records { grid-template-columns:minmax(360px,1.8fr) minmax(280px,1.2fr); align-items:stretch; }
.toolbar { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0;}
input[type=text], select, textarea { font-family:inherit; border:1px solid #ccc; border-radius:6px; padding:8px 10px;}
textarea { width:100%; min-height:120px;}
button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; transition:.2s; font-size:0.85rem;}
button { background:var(--brand); color:#fff;}
button.secondary { background:#eee; color:#333;}
button.danger { background:#d32f2f; color:#fff;}
button:hover { opacity:0.9;}
.btn-compact { padding:4px 8px; font-size:0.8rem; }
.pill { display:inline-block; padding:4px 10px; font-size:.85rem; border-radius:999px; background:var(--accent); color:var(--brand);}
.autocomplete-list { position:absolute; background:#fff; border:1px solid #ccc; border-radius:6px;
  max-height:220px; overflow-y:auto; width:260px; box-shadow:0 2px 6px rgba(0,0,0,.1); z-index:100;}
.autocomplete-item { padding:8px 12px; cursor:pointer; font-size:0.9rem;}
.autocomplete-item:hover { background:var(--accent);}
.autocomplete-item.autocomplete-empty { color:var(--muted); cursor:default; pointer-events:none; }
.layout { display:grid; grid-template-columns:1fr 320px; gap:16px;}
@media(max-width:960px){.layout{grid-template-columns:1fr;}}
@media(max-width:960px){
  .card-row { grid-template-columns:1fr; }
}
.record { margin-bottom:12px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff;}
.record .muted { font-size:0.85rem; color:#666;}
.record .toolbar { margin-top:6px;}

.record .text { margin:6px 0; font-size:0.92rem; white-space:pre-wrap; line-height:1.5; }
.record .attachments { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
.record .attachments a { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; font-size:0.8rem; border-radius:999px; background:#f0f4ff; color:var(--brand); text-decoration:none; }
.record .attachments a:hover { background:#dbe5ff; }
.search-toolbar { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 4px; }
.search-toolbar label { font-size:0.85rem; color:#666; display:flex; align-items:center; gap:6px; }
.search-toolbar input[type=date], .search-toolbar input[type=text] { font-size:0.85rem; }
.media-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(120px,1fr)); }
.media-card { border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.05); }
.media-card a { display:block; color:inherit; text-decoration:none; }
.media-card img { width:100%; height:100px; object-fit:cover; display:block; background:#f6f8fb; }
.media-card .media-icon { height:100px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; background:#f6f8fb; }
.media-card .media-meta { padding:8px; font-size:0.75rem; color:#555; }
.media-card .media-meta .name { font-weight:600; color:#333; margin-bottom:4px; }
.dashboard-card h2 { display:flex; align-items:center; justify-content:space-between; gap:8px; }
.dashboard-wrapper { display:flex; gap:14px; align-items:flex-start; margin-top:8px; }
.dashboard-sidebar { width:48px; display:flex; flex-direction:column; gap:6px; position:sticky; top:12px; }
.dashboard-sidebar .dashboard-index-btn { background:#e9f0fb; color:#1c3a6b; border:none; border-radius:12px; padding:8px 0; font-size:0.75rem; cursor:pointer; transition:.2s; width:100%; min-height:32px; }
.dashboard-sidebar .dashboard-index-btn.active { background:var(--brand); color:#fff; box-shadow:0 2px 8px rgba(25,118,210,0.25); }
.dashboard-sidebar .dashboard-index-btn:hover { opacity:0.85; }
.dashboard-sidebar .dashboard-index-empty { font-size:0.75rem; color:#718096; writing-mode:vertical-rl; text-orientation:mixed; padding:8px 0; }
.dashboard-main { flex:1; display:flex; flex-direction:column; gap:12px; }
.dashboard-filters { background:#f5f8ff; border:1px solid #d3e0f6; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; }
.dashboard-filter-row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.dashboard-filter { display:flex; flex-direction:column; gap:6px; font-size:0.8rem; color:#4a5a75; min-width:160px; }
.dashboard-filter label { font-weight:600; }
.dashboard-filter-label { font-weight:600; }
.dashboard-filter select { font-size:0.85rem; padding:6px 8px; border-radius:6px; border:1px solid #ccd5e6; background:#fff; }
.dashboard-care-chips { display:flex; flex-wrap:wrap; gap:6px; }
.dashboard-chip { border:1px solid #b8c7e6; background:#fff; color:#2b3d6d; border-radius:999px; padding:6px 12px; font-size:0.78rem; cursor:pointer; transition:.2s; }
.dashboard-chip.active { background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 2px 8px rgba(25,118,210,0.25); }
.dashboard-filter-summary { font-size:0.78rem; color:#5a6a85; }
.dashboard-sections { display:flex; flex-direction:column; gap:12px; }
.dashboard-section { border:1px solid #dbe6f6; border-radius:12px; background:#fff; overflow:hidden; }
.dashboard-section-toggle { width:100%; background:#f1f6ff; border:none; display:flex; align-items:center; gap:10px; padding:12px 14px; font-size:0.95rem; color:#1f3763; font-weight:600; cursor:pointer; transition:.2s; text-align:left; }
.dashboard-section-toggle::after { content:'â–¸'; margin-left:auto; font-size:1rem; color:#4a5a75; transition:transform .2s; }
.dashboard-section-toggle.is-open { background:#e4efff; }
.dashboard-section-toggle.is-open::after { content:'â–¾'; }
.dashboard-section-count { font-size:0.78rem; color:#5a6a85; font-weight:500; }
.dashboard-section-body { display:none; }
.dashboard-section-body.is-open { display:block; }
.dashboard-entry { display:flex; flex-wrap:wrap; align-items:flex-start; gap:12px; padding:12px 16px; border-top:1px solid #e3ebf8; }
.dashboard-entry:first-of-type { border-top:none; }
.dashboard-entry.status-active { background:#f5faf4; }
.dashboard-entry.status-pause { background:#fff8e6; }
.dashboard-entry.status-stop { background:#fff0f0; }
.dashboard-entry.status-fit { background:#f5f3ff; }
.dashboard-entry.selected { box-shadow:0 0 0 2px rgba(25,118,210,0.2); border-radius:10px; }
.dashboard-entry-main { flex:1; min-width:220px; }
.dashboard-entry-name { font-weight:600; font-size:0.95rem; color:#1f2f4b; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.dashboard-entry-id { font-size:0.8rem; color:#5a6a85; background:#eef3ff; border-radius:6px; padding:2px 6px; }
.dashboard-entry-meta { margin-top:6px; display:flex; flex-wrap:wrap; gap:8px 14px; font-size:0.8rem; color:#5a6a85; }
.dashboard-entry-status-row { margin-top:10px; display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; justify-content:space-between; }
.dashboard-monitoring { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
.dashboard-monitoring-label { font-size:0.74rem; color:#5a6a85; font-weight:600; }
.dashboard-monitoring-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:0.74rem; font-weight:600; }
.dashboard-monitoring-badge.completed { background:#e4f3e8; color:#2e7d32; }
.dashboard-monitoring-badge.pending { background:#fff1d6; color:#c77800; }
.dashboard-status-indicator { display:flex; align-items:center; }
.dashboard-entry-actions { display:flex; flex-direction:column; gap:8px; align-items:flex-end; min-width:160px; }
.dashboard-status-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.78rem; font-weight:600; }
.dashboard-status-badge.active { background:#e4f3e8; color:#2e7d32; }
.dashboard-status-badge.pause { background:#ffecc7; color:#c77800; }
.dashboard-status-badge.stop { background:#ffd6d9; color:#c62828; }
.dashboard-status-badge.fit { background:#e8e4ff; color:#5b3cc4; }
.dashboard-status-buttons { display:flex; flex-wrap:wrap; gap:4px; justify-content:flex-end; }
.dashboard-status-btn { border:1px solid #b8c7e6; background:#fff; color:#2b3d6d; border-radius:999px; padding:3px 8px; font-size:0.7rem; cursor:pointer; transition:.2s; line-height:1.2; min-width:0; }
.dashboard-status-btn.active { background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 2px 8px rgba(25,118,210,0.25); }
.dashboard-status-btn[disabled] { opacity:0.6; cursor:wait; }
.dashboard-status-controls { display:flex; flex-direction:column; gap:6px; align-items:flex-end; width:100%; }
.dashboard-status-controls .dashboard-status-buttons { justify-content:flex-end; }
.dashboard-index-note { font-size:0.75rem; color:#5a6a85; }
@media(max-width:960px){
  .dashboard-wrapper{flex-direction:column;}
  .dashboard-sidebar{width:100%; position:static; flex-direction:row; flex-wrap:wrap; justify-content:flex-start; }
  .dashboard-sidebar .dashboard-index-btn{flex:0 0 auto; padding:6px 10px; min-width:36px; }
  .dashboard-sidebar .dashboard-index-empty{writing-mode:initial; text-align:center; width:100%; }
  .dashboard-entry-actions{flex-direction:row; align-items:center; justify-content:flex-end; }
}
.muted { color:#666; font-size:0.8rem; }
  
#mediaGallery { min-height:80px; }
.media-grid { display:flex; flex-direction:column; gap:8px; }
.media-item { background:#f7f9ff; border:1px solid #dbe6f6; border-radius:8px; padding:8px 10px; }
.media-item a { color:var(--brand); font-weight:600; text-decoration:none; word-break:break-all; }
.media-item a:hover { text-decoration:underline; }
.media-missing { color:#777; font-weight:600; word-break:break-all; }
.media-meta { margin-top:4px; font-size:0.78rem; color:var(--muted); display:flex; gap:6px; flex-wrap:wrap; }
.share-card .toolbar { justify-content:flex-start; }
.share-list { display:flex; flex-direction:column; gap:10px; }
.share-item { border:1px solid #dbe6f6; border-radius:8px; padding:10px; background:#f8fbff; position:relative; }
.share-item.expired { background:#fff3f3; border-color:#f5c2c2; }
.share-item .share-item-header { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
.share-item .share-url { flex:1; display:flex; gap:6px; align-items:center; }
.share-item .share-url input { flex:1; font-size:0.78rem; padding:4px 6px; border-radius:6px; border:1px solid #c7d7ef; background:#fff; }
.share-item .share-meta { display:flex; flex-wrap:wrap; gap:10px; font-size:0.75rem; color:#546079; margin-top:6px; }
.share-item .share-actions { display:flex; gap:6px; margin-top:8px; }
.share-item .share-actions .btn-compact { white-space:nowrap; }
.share-qr { margin-top:10px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.share-qr img { width:110px; height:110px; border:1px solid #d0ddf4; border-radius:12px; background:#fff; padding:6px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
.share-meta-notes { font-size:0.72rem; color:#60708f; margin-top:6px; }
.share-form { border-top:1px dashed #c7d7ef; padding-top:10px; margin-top:10px; }
.share-form .share-field { margin-bottom:10px; }
.share-form label { font-size:0.82rem; color:#445; display:flex; flex-direction:column; gap:4px; }
.share-form input[type="text"], .share-form input[type="datetime-local"] { font-size:0.85rem; padding:6px 8px; border:1px solid #c7d7ef; border-radius:6px; }
.share-form select { font-size:0.85rem; padding:6px 8px; border:1px solid #c7d7ef; border-radius:6px; }
.share-attachments { display:flex; flex-direction:column; gap:6px; max-height:180px; overflow-y:auto; padding:6px; background:#f2f7ff; border-radius:6px; border:1px solid #d2def5; }
.share-attachments .share-attachment { display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#334; }
.share-attachments .share-attachment .muted { margin-left:auto; }
.share-attachments .share-attachment-info { display:flex; flex-direction:column; }
.share-attachments .share-attachment-info span { font-size:0.76rem; color:#667; }
.share-empty { font-size:0.8rem; color:#666; padding:6px 4px; }
.share-helper { font-size:0.75rem; color:#6a7a93; margin-top:4px; }
.share-item .badge { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; border-radius:999px; background:#e3f2fd; color:#1957a3; font-size:0.7rem; }
.share-item.expired .badge { background:#ffe6e6; color:#b71c1c; }
.share-item .tag-group { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.share-form .toolbar { gap:8px; }
.share-attachments-all { font-size:0.82rem; display:flex; align-items:center; gap:6px; margin-bottom:6px; }
.share-form .share-qr-preview { margin-top:10px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.share-form .share-qr-preview img { width:110px; height:110px; border:1px solid #d0ddf4; border-radius:12px; background:#fff; padding:6px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
.share-form .share-qr-preview-info { display:flex; flex-direction:column; gap:4px; font-size:0.78rem; color:#445; }
.share-form .share-qr-preview-url { font-weight:600; word-break:break-all; color:#1957a3; }
</style>
</head>
<body>
<div id="internalApp">
<h1>ã‚±ã‚¢ãƒãƒãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
  <span class="pill" id="memberTag">æœªé¸æŠ</span>
</h1>

<!-- åˆ©ç”¨è€…é¸æŠ & æ–°è¦åˆ©ç”¨è€…ç™»éŒ² -->
<div class="card-row card-row--member">
  <div class="card">
    <h2>åˆ©ç”¨è€…ã‚’é¸æŠ</h2>
    <div class="toolbar" style="position:relative;">
      <input type="text" id="memberIdInput" placeholder="IDã¾ãŸã¯æ°åã§æ¤œç´¢" autocomplete="off" style="min-width:260px;">
      <div id="autocompleteList" class="autocomplete-list" style="display:none;"></div>
      <select id="centerSelect">
        <option value="">ï¼ˆæœªå…¥åŠ›ï¼‰</option>
        <option value="ç”ºç”°ç¬¬ï¼‘é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">ç”ºç”°ç¬¬ï¼‘é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
        <option value="ç”ºç”°ç¬¬ï¼’é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">ç”ºç”°ç¬¬ï¼’é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
        <option value="ç”ºç”°ç¬¬ï¼“é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">ç”ºç”°ç¬¬ï¼“é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
        <option value="å¿ ç”Ÿç¬¬ï¼‘é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">å¿ ç”Ÿç¬¬ï¼‘é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
        <option value="å¿ ç”Ÿç¬¬ï¼’é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">å¿ ç”Ÿç¬¬ï¼’é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
        <option value="é¶´å·ç¬¬ï¼‘é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">é¶´å·ç¬¬ï¼‘é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
        <option value="é¶´å·ç¬¬ï¼’é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">é¶´å·ç¬¬ï¼’é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
        <option value="å…‰ãŒä¸˜åœ°åŸŸåŒ…æ‹¬é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">å…‰ãŒä¸˜åœ°åŸŸåŒ…æ‹¬é«˜é½¢è€…æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
      </select>

      <!-- æ‹…å½“è€…å…¥åŠ› -->
      <input type="text" id="staffInput" placeholder="æ‹…å½“è€…åã‚’å…¥åŠ›" list="staffHistory" style="min-width:180px;">
      <datalist id="staffHistory"></datalist>

      <button id="btnSaveCenter" class="secondary">ä¿å­˜</button>
      <button id="btnClearCenter" class="warn">å‰Šé™¤</button>
    </div>
    <div id="idStatus" class="muted"></div>
  </div>

  <div class="card">
    <h2>æ–°è¦åˆ©ç”¨è€…ç™»éŒ²</h2>
    <div class="toolbar">
      <input type="text" id="newMemberId" placeholder="ID (4æ¡)" maxlength="4" inputmode="numeric" style="width:96px;">
      <input type="text" id="newMemberName" placeholder="æ°åï¼ˆä¾‹: å±±ç”°ã€€å¤ªéƒï¼‰" style="flex:1; min-width:160px;">
      <input type="text" id="newMemberKana" placeholder="ãƒ•ãƒªã‚¬ãƒŠï¼ˆä¾‹: ãƒ¤ãƒãƒ€ã€€ã‚¿ãƒ­ã‚¦ï¼‰" style="flex:1; min-width:160px;">
      <button id="btnAddMember">ç™»éŒ²</button>
    </div>
    <div class="muted" style="margin-top:6px;">IDï¼ˆ4æ¡ï¼‰ãƒ»æ°åãƒ»ãƒ•ãƒªã‚¬ãƒŠã¯ã™ã¹ã¦å¿…é ˆã§ã™ã€‚</div>
    <div id="addMemberStatus" class="muted" style="margin-top:4px;"></div>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³UI -->
<div id="mainArea" style="display:none;">
  <div class="layout">
    <div class="left">
      <!-- æ–°è¦è¨˜éŒ² -->
      <div class="card">
        <h2>æ–°è¦ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨˜éŒ²</h2>
        <div class="toolbar">
          <label for="kindSelect">ç¨®åˆ¥:</label>
          <select id="kindSelect">
            <option value="é›»è©±" selected>é›»è©±</option>
            <option value="è¨ªå•">è¨ªå•</option>
            <option value="é€šæ‰€å…ˆ">é€šæ‰€å…ˆ</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <textarea id="inputText" placeholder="è¨˜éŒ²ã‚’å…¥åŠ›..."></textarea>
        <div class="toolbar">
          <input id="fileInput" type="file" multiple />
          <button id="btnSave">ä¿å­˜</button>
          <span id="saveStatus" class="muted"></span>
        </div>
      </div>

      <!-- AIè¦ç´„ & ã‚±ã‚¢ãƒãƒææ¡ˆ -->
      <div class="card-row card-row--insights">
        <div class="card">
          <h2>AIè¦ç´„</h2>
          <div class="toolbar">
            <select id="summaryFormat">
              <option value="normal">æ¨™æº–</option>
              <option value="icf">ICFå½¢å¼</option>
              <option value="soap">SOAPå½¢å¼</option>
              <option value="doctor">åŒ»ç™‚é€£æº</option>
              <option value="family">å®¶æ—å‘ã‘</option>
            </select>
            <button id="btnSummary">è¦ç´„ç”Ÿæˆ</button>
          </div>
          <div id="summaryOutput" class="muted">ã“ã“ã«è¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>

        <div class="card">
          <h2>ã‚±ã‚¢ãƒãƒã‹ã‚‰ã®ææ¡ˆ</h2>
          <div class="toolbar">
            <select id="adviceHorizonSelect">
              <option value="now">ã™ãã«å¯¾å¿œ</option>
              <option value="2w">2é€±é–“</option>
              <option value="1m">1ã‹æœˆ</option>
              <option value="3m" selected>3ã‹æœˆ</option>
            </select>
            <button id="btnAdvice">ææ¡ˆç”Ÿæˆ</button>
          </div>
          <div id="adviceOutput" class="muted">ã“ã“ã«ææ¡ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>

      <!-- éå»ã®è¨˜éŒ² & å¤–éƒ¨å…±æœ‰ -->
      <div class="card-row card-row--records">
        <div class="card">
          <h2>éå»ã®è¨˜éŒ²</h2>
          <div class="search-toolbar">
            <label>ç¨®åˆ¥
              <select id="filterKind">
                <option value="all">ã™ã¹ã¦</option>
                <option value="è¨ªå•">è¨ªå•</option>
                <option value="é›»è©±">é›»è©±</option>
                <option value="æ–½è¨­é¢è«‡">æ–½è¨­é¢è«‡</option>
                <option value="é€šæ‰€å…ˆ">é€šæ‰€å…ˆ</option>
                <option value="ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°">ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
            </label>
            <label>é–‹å§‹
              <input type="date" id="filterDateFrom">
            </label>
            <label>çµ‚äº†
              <input type="date" id="filterDateTo">
            </label>
            <input type="text" id="filterText" placeholder="æœ¬æ–‡æ¤œç´¢ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰" style="flex:1; min-width:160px;">
            <button id="btnClearFilters" class="secondary btn-compact">ã‚¯ãƒªã‚¢</button>
          </div>
          <div id="recordList" class="muted">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>

        <div class="card share-card">
          <h2>å¤–éƒ¨å…±æœ‰</h2>
          <div id="shareList" class="share-list muted">åˆ©ç”¨è€…ã‚’é¸æŠã™ã‚‹ã¨å…±æœ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          <div class="toolbar">
            <button id="btnOpenShareForm" class="secondary btn-compact">å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</button>
          </div>
          <div id="shareForm" class="share-form" style="display:none;">
            <div class="share-field">
              <label>å…±æœ‰å…ˆã‚’é¸æŠ
                <select id="shareAudience">
                  <option value="family">å®¶æ—ï¼šç”Ÿæ´»ã®æ§˜å­ã‚’å…±æœ‰</option>
                  <option value="center" selected>åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼ï¼šå®šæœŸç¢ºèª</option>
                  <option value="medical">åŒ»ç™‚æ©Ÿé–¢ï¼šåŒ»å¸«ãƒ»çœ‹è­·å¸«ã¨ã®é€£æº</option>
                  <option value="service">ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­è€…ï¼šã‚±ã‚¢å®Ÿå‹™è€…ã¨å…±æœ‰</option>
                </select>
              </label>
              <div class="share-helper">å…±æœ‰å…ˆã«å¿œã˜ã¦è¡¨ç¤ºå†…å®¹ã‚„æ¡ˆå†…æ–‡ãŒè‡ªå‹•ã§åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</div>
            </div>

            <div class="share-field">
              <label>é–²è¦§æœŸé™
                <select id="shareExpiryPreset">
                  <option value="10" selected>10æ—¥é–“ï¼ˆçŸ­æœŸå…±æœ‰ï¼‰</option>
                  <option value="30">30æ—¥é–“ï¼ˆæ¨™æº–ï¼‰</option>
                  <option value="none">æœŸé™ãªã—</option>
                  <option value="custom">æ—¥ä»˜ã‚’æŒ‡å®šã™ã‚‹</option>
                </select>
              </label>
              <input type="datetime-local" id="shareExpires" style="display:none; margin-top:6px;">
              <div class="share-helper">ã€Œæ—¥ä»˜ã‚’æŒ‡å®šã™ã‚‹ã€ã‚’é¸ã¶ã¨ä»»æ„ã®æœŸé™ã‚’è¨­å®šã§ãã¾ã™ã€‚</div>
            </div>

            <div class="share-field">
              <label>å…±æœ‰ã™ã‚‹æœŸé–“
                <select id="shareRange">
                  <option value="30">ç›´è¿‘30æ—¥</option>
                  <option value="90" selected>ç›´è¿‘90æ—¥</option>
                  <option value="all">å…¨æœŸé–“</option>
                </select>
              </label>
              <div class="share-helper">é–²è¦§è€…å´ã§ã¯æœŸé–“ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚å¿…è¦æœ€å°é™ã®æœŸé–“ã«çµã£ã¦å…±æœ‰ã§ãã¾ã™ã€‚</div>
            </div>

            <div class="share-field">
              <div class="share-attachments-all">
                <label><input type="checkbox" id="shareAttachmentAll"> ã™ã¹ã¦ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±æœ‰ã™ã‚‹</label>
              </div>
              <div id="shareAttachments" class="share-attachments muted">è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</div>
            </div>

            <div class="toolbar">
              <button id="btnCreateShare">å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œ</button>
              <button type="button" id="btnCancelShare" class="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div id="shareFormStatus" class="muted"></div>
          </div>
        </div>
      </div>
    </div>

    <aside class="right">
      <div class="card">
        <h2>æ·»ä»˜ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
        <div id="mediaGallery" class="muted">åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
      <div class="card dashboard-card">
        <h2>åˆ©ç”¨è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
        <div id="dashboardStatus" class="muted">èª­è¾¼ä¸­â€¦</div>
        <div class="dashboard-wrapper">
          <nav id="dashboardIndex" class="dashboard-sidebar" aria-label="äº”åéŸ³ãƒŠãƒ“"></nav>
          <div class="dashboard-main">
            <div id="dashboardFilters" class="dashboard-filters"></div>
            <div id="dashboardTable" class="dashboard-sections"></div>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
let memberId = null, memberName = "";
let memberList = [];
let memberSearchResults = [];
let memberListLoading = false;
let memberListLoaded = false;
let recordsCache = [];
const queryParams = new URLSearchParams(window.location.search);
const shareAudienceInfo = {
  family: {
    label: "å®¶æ—å‘ã‘å…±æœ‰",
    description: "æ—¥ã€…ã®æ§˜å­ã‚’ã‚ã‹ã‚Šã‚„ã™ãä¼ãˆã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ç¤ºã§ã™ã€‚",
    intro: "å¤§åˆ‡ãªã”å®¶æ—ã‚„é–¢ä¿‚è€…ã®çš†ã•ã¾ã¨çŠ¶æ³ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸ã§ã™ã€‚å¿…è¦ãªæƒ…å ±ã ã‘ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã®ã§ã€å®‰å¿ƒã—ã¦ã”è¦§ãã ã•ã„ã€‚",
    manualTips: [
      "QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚‹ã¨ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚",
      "é–²è¦§ãƒšãƒ¼ã‚¸ã§ã¯æœ€æ–°ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨˜éŒ²ã‚’é †ç•ªã«ç¢ºèªã§ãã¾ã™ã€‚"
    ]
  },
  center: {
    label: "åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼å‘ã‘å…±æœ‰",
    description: "æ—¥ä»˜ãƒ»ç¨®åˆ¥ã‚’å«ã‚ã¦ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚",
    intro: "åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼ã®è·å“¡ã•ã¾å‘ã‘ã®å…±æœ‰ãƒšãƒ¼ã‚¸ã§ã™ã€‚å¿…è¦ãªè¨˜éŒ²ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚",
    manualTips: [
      "QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã€é–²è¦§å°‚ç”¨ã®ãƒšãƒ¼ã‚¸ã§è¨˜éŒ²ã‚’ã”ç¢ºèªãã ã•ã„ã€‚",
      "å¿…è¦ã«å¿œã˜ã¦ã‚±ã‚¢ãƒãƒã‚¸ãƒ£ãƒ¼ã¸ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¯„ã›ãã ã•ã„ã€‚"
    ]
  },
  caremanager: {
    label: "ã‚±ã‚¢ãƒãƒã‚¸ãƒ£ãƒ¼å‘ã‘å…±æœ‰",
    description: "æœˆæ¬¡å ±å‘Šæ›¸ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨˜éŒ²ã‚’ã¾ã¨ã‚ã¦å…±æœ‰ã—ã¾ã™ã€‚",
    intro: "ã‚±ã‚¢ãƒãƒã‚¸ãƒ£ãƒ¼ã•ã¾å°‚ç”¨ã®å…±æœ‰ãƒªãƒ³ã‚¯ã§ã™ã€‚æœˆæ¬¡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å ±å‘Šæ›¸ã¨æœ€æ–°ã®è¨˜éŒ²ã‚’ç¢ºèªã§ãã¾ã™ã€‚",
    manualTips: [
      "æœˆæ¬¡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å ±å‘Šæ›¸ã‚’PDFã¨ã—ã¦å°åˆ·ã—ã€é–¢ä¿‚è€…ã¨å…±æœ‰ã§ãã¾ã™ã€‚",
      "å¿…è¦ã«å¿œã˜ã¦å…±æœ‰æœŸé™ã‚’å»¶é•·ã—ã¦ãã ã•ã„ã€‚"
    ]
  },
  medical: {
    label: "åŒ»ç™‚é€£æºå‘ã‘å…±æœ‰",
    description: "åŒ»å¸«ãƒ»çœ‹è­·å¸«ãŒçµŒéã‚’æŠŠæ¡ã—ã‚„ã™ã„ã‚ˆã†ç¨®åˆ¥ã‚‚è¡¨ç¤ºã—ã¾ã™ã€‚",
    intro: "åŒ»ç™‚æ©Ÿé–¢ã®çš†ã•ã¾ã¨ã®æƒ…å ±é€£æºç”¨ãƒšãƒ¼ã‚¸ã§ã™ã€‚å¿…è¦äº‹é …ã®ã¿æŠœç²‹ã—ã¦ã„ã¾ã™ã€‚",
    manualTips: [
      "QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨˜éŒ²ã‚’æ™‚ç³»åˆ—ã§ç¢ºèªã§ãã¾ã™ã€‚",
      "è¨ºå¯Ÿã‚„è¨ªå•æ™‚ã®å‚è€ƒè³‡æ–™ã¨ã—ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚"
    ]
  },
  service: {
    label: "ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­è€…å‘ã‘å…±æœ‰",
    description: "ã‚±ã‚¢å®Ÿå‹™è€…ãŒæŠŠæ¡ã—ã‚„ã™ã„ã‚ˆã†æ§‹æˆã—ã¦ã„ã¾ã™ã€‚",
    intro: "ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­è€…ã®çš†ã•ã¾ã¨ã®å…±æœ‰ãƒšãƒ¼ã‚¸ã§ã™ã€‚ç¾å ´ã§æ´»ç”¨ã—ã‚„ã™ã„ã‚ˆã†ç°¡æ½”ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚",
    manualTips: [
      "QRã‚³ãƒ¼ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã€å¿…è¦ãªè¨˜éŒ²ã‚’ã„ã¤ã§ã‚‚ç¢ºèªã§ãã¾ã™ã€‚",
      "ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã«é–¢ã™ã‚‹æ°—ã¥ãã¯ã‚±ã‚¢ãƒãƒã‚¸ãƒ£ãƒ¼ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚"
    ]
  }
};
const shareAudienceDefault = "family";
const shareExpiryPresetDefault = "30";
const shareRangeDefault = "30";

const MEMBER_STATUS_ORDER = ["active", "pause", "stop", "fit"];
const MEMBER_STATUS_FILTER_VALUES = ["all", ...MEMBER_STATUS_ORDER];
const MEMBER_STATUS_DEFAULT = "active";
const MEMBER_STATUS_META = {
  active: { label: "ç¨¼åƒä¸­", icon: "ğŸŸ¢" },
  pause: { label: "ä¼‘æ­¢", icon: "â¸" },
  stop: { label: "ä¸­æ­¢", icon: "â›”" },
  fit: { label: "ã¹ã‚‹ãƒ•ã‚£ãƒƒãƒˆ", icon: "ğŸ’ª" }
};

const DASHBOARD_SPECIAL_STATUS_SECTIONS = [
  { key: "pause", label: "ä¼‘æ­¢ä¸­ã®åˆ©ç”¨è€…" },
  { key: "stop", label: "ä¸­æ­¢ã—ãŸåˆ©ç”¨è€…" },
  { key: "fit", label: "ã¹ã‚‹ãƒ•ã‚£ãƒƒãƒˆä¼šå“¡" }
];
const DASHBOARD_SPECIAL_STATUS_KEY_SET = new Set(DASHBOARD_SPECIAL_STATUS_SECTIONS.map(info => info.key));

function normalizeMemberStatusValue(status) {
  const normalized = String(status == null ? "" : status)
    .normalize("NFKC")
    .trim();
  if (!normalized) return "";
  const simple = normalized.replace(/[\sã€€]+/g, "").toLowerCase();
  if (MEMBER_STATUS_META[simple]) return simple;
  if (MEMBER_STATUS_META[normalized.toLowerCase()]) return normalized.toLowerCase();
  const aliases = {
    "ç¨¼åƒä¸­": "active",
    "ã‹ã©ã†ã¡ã‚…ã†": "active",
    "ç¨¼åƒ": "active",
    "ä¼‘æ­¢": "pause",
    "ä¼‘ä¼š": "pause",
    "ãã‚…ã†ã—": "pause",
    "ä¸­æ­¢": "stop",
    "ã¡ã‚…ã†ã—": "stop",
    "åœæ­¢": "stop",
    "çµ‚äº†": "stop",
    "ã¹ã‚‹ãµãƒã£ã¨": "fit",
    "ã¹ã‚‹ãƒ•ã‚£ãƒƒãƒˆ": "fit",
    "ãƒ™ãƒ«ãƒ•ã‚£ãƒƒãƒˆ": "fit",
    "fit": "fit"
  };
  if (aliases[simple]) return aliases[simple];
  if (aliases[normalized]) return aliases[normalized];
  return "";
}

function getMemberStatusValue(status) {
  const value = normalizeMemberStatusValue(status);
  return value || MEMBER_STATUS_DEFAULT;
}

function getMemberStatusMeta(status) {
  const key = getMemberStatusValue(status);
  return MEMBER_STATUS_META[key] || { label: key, icon: "" };
}

function getAudienceInfo(audience){
  const key = String(audience || "").toLowerCase();
  return shareAudienceInfo[key] || shareAudienceInfo[shareAudienceDefault];
}

const DASHBOARD_OTHER_LABEL = "ãã®ä»–";
const DASHBOARD_DIGIT_LABEL = "0-9";
const DASHBOARD_LEGACY_LABEL_MAP = {
  "ã‚": "ã‚è¡Œ",
  "ã‹": "ã‹è¡Œ",
  "ã•": "ã•è¡Œ",
  "ãŸ": "ãŸè¡Œ",
  "ãª": "ãªè¡Œ",
  "ã¯": "ã¯è¡Œ",
  "ã¾": "ã¾è¡Œ",
  "ã‚„": "ã‚„è¡Œ",
  "ã‚‰": "ã‚‰è¡Œ",
  "ã‚": "ã‚è¡Œ",
  "#": DASHBOARD_OTHER_LABEL
};

const DASHBOARD_SMALL_KANA_MAP = {
  "ã": "ã‚",
  "ãƒ": "ã„",
  "ã…": "ã†",
  "ã‡": "ãˆ",
  "ã‰": "ãŠ",
  "ã£": "ã¤",
  "ã‚ƒ": "ã‚„",
  "ã‚…": "ã‚†",
  "ã‚‡": "ã‚ˆ",
  "ã‚": "ã‚",
  "ã‚•": "ã‹",
  "ã‚–": "ã‘"
};

const DASHBOARD_COLLAPSE_STORAGE_KEY = "monitoringDashboardCollapsed";

function getAvailableStorages() {
  const list = [];
  if (typeof localStorage !== "undefined") list.push(localStorage);
  if (typeof sessionStorage !== "undefined") list.push(sessionStorage);
  return list;
}

function normalizeDashboardCollapsedKeys(map) {
  if (!map || typeof map !== "object" || Array.isArray(map)) return {};
  const normalized = {};
  Object.keys(map).forEach(key => {
    const mapped = DASHBOARD_LEGACY_LABEL_MAP[key] || key;
    normalized[mapped] = map[key];
  });
  return normalized;
}

function loadDashboardCollapsedSections() {
  const storages = getAvailableStorages();
  for (const storage of storages) {
    try {
      const raw = storage.getItem(DASHBOARD_COLLAPSE_STORAGE_KEY);
      if (!raw) continue;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object" && !Array.isArray(parsed)) {
        return normalizeDashboardCollapsedKeys(parsed);
      }
    } catch (err) {
      console.warn("collapse-state-load", err);
    }
  }
  return {};
}

function saveDashboardCollapsedSections() {
  const storages = getAvailableStorages();
  const snapshot = dashboardState && dashboardState.collapsedSections ? dashboardState.collapsedSections : {};
  const json = JSON.stringify(snapshot);
  for (const storage of storages) {
    try {
      storage.setItem(DASHBOARD_COLLAPSE_STORAGE_KEY, json);
      return;
    } catch (err) {
      console.warn("collapse-state-save", err);
    }
  }
}

function getInitialDashboardFiltersFromQuery() {
  let statusParam = String(queryParams.get("memberStatus") || "").toLowerCase();
  if (!statusParam) {
    statusParam = String(queryParams.get("monitoringStatus") || "").toLowerCase();
  }
  const status = MEMBER_STATUS_FILTER_VALUES.includes(statusParam) ? statusParam : "all";
  const careManagers = queryParams.getAll("careManager").map(v => String(v || "").trim()).filter(Boolean);
  return {
    status,
    careManagers
  };
}

let dashboardState = {
  data: [],
  monthLabel: "",
  monthBadgeLabel: "",
  previousMonthLabel: "",
  previousMonthBadgeLabel: "",
  activeInitial: null,
  filters: getInitialDashboardFiltersFromQuery(),
  collapsedSections: loadDashboardCollapsedSections(),
  pendingScrollLabel: null
};
let externalShares = [];
let shareFormOpen = false;

const DASHBOARD_KANA_GROUPS = [
  { label: "ã‚è¡Œ", chars: ["ã‚", "ã„", "ã†", "ãˆ", "ãŠ"] },
  { label: "ã‹è¡Œ", chars: ["ã‹", "ã", "ã", "ã‘", "ã“"] },
  { label: "ã•è¡Œ", chars: ["ã•", "ã—", "ã™", "ã›", "ã"] },
  { label: "ãŸè¡Œ", chars: ["ãŸ", "ã¡", "ã¤", "ã¦", "ã¨"] },
  { label: "ãªè¡Œ", chars: ["ãª", "ã«", "ã¬", "ã­", "ã®"] },
  { label: "ã¯è¡Œ", chars: ["ã¯", "ã²", "ãµ", "ã¸", "ã»"] },
  { label: "ã¾è¡Œ", chars: ["ã¾", "ã¿", "ã‚€", "ã‚", "ã‚‚"] },
  { label: "ã‚„è¡Œ", chars: ["ã‚„", "ã‚†", "ã‚ˆ"] },
  { label: "ã‚‰è¡Œ", chars: ["ã‚‰", "ã‚Š", "ã‚‹", "ã‚Œ", "ã‚"] },
  { label: "ã‚è¡Œ", chars: ["ã‚", "ã‚", "ã‚‘", "ã‚’", "ã‚“", "ã‚"] }
];
const DASHBOARD_ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const DASHBOARD_KANA_CHAR_TO_LABEL = (() => {
  const map = new Map();
  DASHBOARD_KANA_GROUPS.forEach(group => {
    group.chars.forEach(ch => {
      map.set(ch, group.label);
    });
  });
  return map;
})();
const DASHBOARD_GROUP_ORDER = [
  ...DASHBOARD_KANA_GROUPS.map(g => g.label),
  ...DASHBOARD_ALPHABET,
  DASHBOARD_DIGIT_LABEL,
  DASHBOARD_OTHER_LABEL
];
const DASHBOARD_COLLATOR = new Intl.Collator(["ja", "en"], { sensitivity: "base", numeric: true, caseFirst: "false" });

function toHiragana(value = "") {
  return String(value)
    .normalize("NFKC")
    .replace(/[ã‚¡-ãƒ³]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
}

function normalizeMemberSearchText(value) {
  if (value == null) return "";
  return toHiragana(String(value))
    .toLowerCase()
    .replace(/[\sã€€]+/g, "");
}

function includesMemberSearchTarget(rawValue, normalizedValue, rawQuery, normalizedQuery) {
  if (!rawValue) return false;
  const text = String(rawValue);
  if (rawQuery && text.includes(rawQuery)) return true;
  const normalized = normalizedValue ? String(normalizedValue) : normalizeMemberSearchText(text);
  const normalizedQueryText = normalizedQuery != null ? String(normalizedQuery) : "";
  if (!normalizedQueryText) return false;
  return normalized.includes(normalizedQueryText);
}

function memberMatchesQuery(member, rawQuery, idDigits, normalizedQuery, normalizedIdQuery = "") {
  if (!member) return false;
  const safeRawQuery = rawQuery != null ? String(rawQuery) : "";
  const hasText = !!safeRawQuery;
  const idCandidate = idDigits != null ? String(idDigits) : "";
  const normalizedIdCandidate = normalizedIdQuery != null ? String(normalizedIdQuery) : "";
  const normalizedQueryText = normalizedQuery != null ? String(normalizedQuery) : "";
  const memberId = member.id != null ? String(member.id) : "";
  const memberIdNormalized = member.idNormalized != null ? String(member.idNormalized) : "";
  if (idCandidate) {
    if (memberId && memberId.includes(idCandidate)) return true;
    if (memberIdNormalized && memberIdNormalized.includes(idCandidate)) return true;
    if (memberIdNormalized && idCandidate.length < memberIdNormalized.length) {
      const padded = idCandidate.padStart(memberIdNormalized.length, "0");
      if (memberIdNormalized.includes(padded)) return true;
    }
  }
  if (normalizedIdCandidate && memberIdNormalized) {
    if (memberIdNormalized === normalizedIdCandidate) return true;
  }
  if (!hasText) return false;
  if (includesMemberSearchTarget(member.name, member.nameNormalized, safeRawQuery, normalizedQueryText)) return true;
  if (includesMemberSearchTarget(member.kana, member.kanaNormalized, safeRawQuery, normalizedQueryText)) return true;
  if (includesMemberSearchTarget(member.yomi, member.yomiNormalized, safeRawQuery, normalizedQueryText)) return true;
  return false;
}

function normalizeHiraganaBaseChar(ch) {
  if (!ch) return "";
  const base = ch.normalize("NFD")[0] || "";
  return DASHBOARD_SMALL_KANA_MAP[base] || base;
}

function extractHeadChar(value) {
  const text = String(value || "").trim();
  if (!text) return "";
  const normalized = text.normalize("NFKC");
  for (const ch of normalized) {
    if (!ch) continue;
    if (/[ã-ã‚“ã‚¡-ãƒ³]/.test(ch)) {
      const hira = toHiragana(ch);
      return normalizeHiraganaBaseChar(hira);
    }
    if (/[A-Za-z]/.test(ch)) {
      return ch.toUpperCase();
    }
    if (/\d/.test(ch)) {
      return ch;
    }
  }
  return "";
}

function getEntryReadingCandidates(entry) {
  if (!entry || typeof entry !== "object") return [];
  const candidates = [
    entry.yomi,
    entry.reading,
    entry.furigana,
    entry.kana,
    entry.nameKana,
    entry.name
  ];
  return candidates.filter(value => typeof value === "string" && value.trim());
}

function getDashboardGroupLabel(entry) {
  const candidates = [...getEntryReadingCandidates(entry), entry && entry.id];
  for (const candidate of candidates) {
    if (!candidate) continue;
    const head = extractHeadChar(candidate);
    if (!head) continue;
    if (/[ã-ã‚“]/.test(head)) {
      const label = DASHBOARD_KANA_CHAR_TO_LABEL.get(head) || DASHBOARD_KANA_CHAR_TO_LABEL.get(normalizeHiraganaBaseChar(head));
      return label || DASHBOARD_OTHER_LABEL;
    }
    if (/[A-Z]/.test(head)) {
      return head;
    }
    if (/\d/.test(head)) {
      return DASHBOARD_DIGIT_LABEL;
    }
  }
  return DASHBOARD_OTHER_LABEL;
}

function getEntryPreferredReading(entry) {
  const candidates = getEntryReadingCandidates(entry);
  if (candidates.length) {
    return candidates[0];
  }
  return entry && entry.id ? String(entry.id) : "";
}

function entryHasFurigana(entry) {
  if (!entry || typeof entry !== "object") return false;
  const yomi = typeof entry.yomi === "string" ? entry.yomi.trim() : "";
  return yomi !== "";
}

function getEntrySortKey(entry) {
  const reading = getEntryPreferredReading(entry);
  if (reading) {
    return toHiragana(reading).replace(/[\sã€€]+/g, "");
  }
  return String(entry && entry.id || "").trim();
}

function compareEntriesByFurigana(a, b) {
  const aHas = entryHasFurigana(a);
  const bHas = entryHasFurigana(b);
  if (aHas !== bHas) return aHas ? -1 : 1;
  const keyA = getEntrySortKey(a);
  const keyB = getEntrySortKey(b);
  const cmpKey = DASHBOARD_COLLATOR.compare(keyA, keyB);
  if (cmpKey !== 0) return cmpKey;
  const nameA = String(a && a.name || "").trim();
  const nameB = String(b && b.name || "").trim();
  const cmpName = DASHBOARD_COLLATOR.compare(nameA, nameB);
  if (cmpName !== 0) return cmpName;
  const idA = String(a && a.id || "").trim();
  const idB = String(b && b.id || "").trim();
  return DASHBOARD_COLLATOR.compare(idA, idB);
}

function getDashboardIndexGroups(sortedData) {
  const exists = new Set();
  const specialExists = new Set();
  (Array.isArray(sortedData) ? sortedData : []).forEach(entry => {
    if (!entry) return;
    const statusKey = getMemberStatusValue(entry.memberStatus);
    if (DASHBOARD_SPECIAL_STATUS_KEY_SET.has(statusKey)) {
      specialExists.add(statusKey);
      return;
    }
    const label = getDashboardGroupLabel(entry);
    exists.add(label);
  });
  const ordered = DASHBOARD_GROUP_ORDER.filter(label => exists.has(label));
  DASHBOARD_SPECIAL_STATUS_SECTIONS.forEach(info => {
    if (specialExists.has(info.key)) {
      ordered.push(info.label);
    }
  });
  return ordered;
}

function parseCareManagerList(value) {
  const raw = String(value || "").trim();
  if (!raw) return [];
  return raw
    .split(/[ã€,ï¼Œ;ï¼›\/ï¼\|ï½œ\n]+/)
    .map(part => part.trim())
    .filter(Boolean);
}

function getDashboardCareManagerOptions(data) {
  const set = new Set();
  (Array.isArray(data) ? data : []).forEach(entry => {
    parseCareManagerList(entry && entry.careManager).forEach(name => set.add(name));
  });
  const list = Array.from(set);
  list.sort((a, b) => DASHBOARD_COLLATOR.compare(a, b));
  return list;
}

function applyDashboardFilters(data) {
  const filters = dashboardState && dashboardState.filters ? dashboardState.filters : {};
  const status = MEMBER_STATUS_FILTER_VALUES.includes(filters.status) ? filters.status : "all";
  const careManagers = Array.isArray(filters.careManagers) ? filters.careManagers : [];
  return (Array.isArray(data) ? data : []).filter(entry => {
    if (!entry) return false;
    const statusKey = getMemberStatusValue(entry.memberStatus);
    if (status !== "all" && statusKey !== status) return false;
    if (careManagers.length) {
      const entryManagers = parseCareManagerList(entry.careManager);
      if (!entryManagers.some(name => careManagers.includes(name))) {
        return false;
      }
    }
    return true;
  });
}

function buildDashboardSections(data) {
  const sections = [];
  const groups = new Map();
  const specialBuckets = new Map();
  const normalEntries = [];
  DASHBOARD_SPECIAL_STATUS_SECTIONS.forEach(info => {
    specialBuckets.set(info.key, []);
  });
  (Array.isArray(data) ? data : []).forEach(entry => {
    const statusKey = getMemberStatusValue(entry && entry.memberStatus);
    if (specialBuckets.has(statusKey)) {
      specialBuckets.get(statusKey).push(entry);
      return;
    }
    normalEntries.push(entry);
    const label = getDashboardGroupLabel(entry);
    if (!groups.has(label)) {
      groups.set(label, []);
    }
    groups.get(label).push(entry);
  });
  const order = getDashboardIndexGroups(normalEntries);
  order.forEach(label => {
    sections.push({ label, entries: groups.get(label) || [] });
  });
  DASHBOARD_SPECIAL_STATUS_SECTIONS.forEach(info => {
    const list = specialBuckets.get(info.key) || [];
    if (list.length) {
      sections.push({ label: info.label, entries: list });
    }
  });
  return sections;
}

function deriveMonthBadgeLabel(rawLabel) {
  const raw = String(rawLabel || "").trim();
  if (!raw) return "";
  const match = raw.match(/\d{4}\/(\d{1,2})/);
  if (match) {
    return `${Number(match[1])}æœˆ`;
  }
  return raw;
}

function getMonitoringStatusKey(value) {
  return value === "completed" ? "completed" : "pending";
}

function buildMonitoringBadge(monthLabel, status) {
  const safeLabel = String(monthLabel || "").trim();
  if (!safeLabel) return "";
  const statusKey = getMonitoringStatusKey(status);
  const icon = statusKey === "completed" ? "âœ…" : "âš ï¸";
  const statusText = statusKey === "completed" ? "ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿" : "ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æœªå®Ÿæ–½";
  const label = `${safeLabel}åˆ† ${statusText}`;
  return `<span class="dashboard-monitoring-badge ${statusKey}">${icon} ${escapeHtml(label)}</span>`;
}

function buildMonitoringSectionHtml(entry) {
  if (!entry) return "";
  const badges = [];
  const currentLabel = dashboardState.monthBadgeLabel || deriveMonthBadgeLabel(dashboardState.monthLabel);
  const previousLabel = dashboardState.previousMonthBadgeLabel || deriveMonthBadgeLabel(dashboardState.previousMonthLabel);
  const currentBadge = buildMonitoringBadge(currentLabel, entry.monitoringStatusCurrent || entry.monitoringStatus);
  if (currentBadge) badges.push(currentBadge);
  const previousBadge = buildMonitoringBadge(previousLabel, entry.monitoringStatusPrevious);
  if (previousBadge) badges.push(previousBadge);
  if (!badges.length) return "";
  return `<div class="dashboard-monitoring"><span class="dashboard-monitoring-label">ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°çŠ¶æ³</span>${badges.join("")}</div>`;
}

function getDashboardSectionDomId(label) {
  const base = String(label || "").trim();
  const safe = base.replace(/[^0-9A-Za-z\u3040-\u30FF\u3400-\u9FFF]/g, "").toLowerCase();
  return `dashboard-section-${safe || "misc"}`;
}

function updateDashboardFilterQueryParams() {
  try {
    const params = new URLSearchParams(window.location.search);
    const filters = dashboardState && dashboardState.filters ? dashboardState.filters : {};
    const status = MEMBER_STATUS_FILTER_VALUES.includes(filters.status) ? filters.status : "all";
    if (status && status !== "all") {
      params.set("memberStatus", status);
    } else {
      params.delete("memberStatus");
    }
    params.delete("monitoringStatus");
    params.delete("careManager");
    const careManagers = Array.isArray(filters.careManagers) ? filters.careManagers : [];
    careManagers.forEach(name => params.append("careManager", name));
    const query = params.toString();
    const newUrl = `${window.location.pathname}${query ? `?${query}` : ""}${window.location.hash}`;
    window.history.replaceState(null, "", newUrl);
  } catch (err) {
    console.warn("filter-query-update", err);
  }
}

function getEntryLatestTimestamp(entry) {
  if (!entry) return NaN;
  const candidates = [
    entry.latestTimestamp,
    entry.latestDate,
    entry.latestDateValue,
    entry.latestDateText
  ];
  for (const value of candidates) {
    if (typeof value === "number" && isFinite(value)) return value;
    if (value instanceof Date && isFinite(value.getTime())) return value.getTime();
    if (typeof value === "string" && value) {
      const parsed = Date.parse(value);
      if (!isNaN(parsed)) return parsed;
    }
  }
  return NaN;
}

function getSortedDashboardData() {
  const data = Array.isArray(dashboardState.data) ? dashboardState.data.slice() : [];
  data.sort(compareEntriesByFurigana);
  return data;
}

function jumpToDashboardInitial(label) {
  const safeLabel = String(label || "").trim();
  if (!safeLabel) return;
  dashboardState.activeInitial = safeLabel;
  if (!dashboardState.collapsedSections || typeof dashboardState.collapsedSections !== "object") {
    dashboardState.collapsedSections = {};
  }
  dashboardState.collapsedSections[safeLabel] = false;
  dashboardState.pendingScrollLabel = safeLabel;
  saveDashboardCollapsedSections();
  renderDashboard();
}

function toHalfDigits(s) {
  return String(s || "").replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));
}

function extractMemberIdDigits(value) {
  if (value == null) return "";
  return toHalfDigits(String(value)).replace(/[^0-9]/g, "");
}

function normalizeMemberIdForLookup(value) {
  const digits = extractMemberIdDigits(value);
  if (!digits) return "";
  if (digits.length >= 4) return digits;
  return digits.padStart(4, "0");
}

function getCurrentMemberIdForCenter() {
  if (memberId) return memberId;
  const inputEl = document.getElementById("memberIdInput");
  if (!inputEl) return "";
  return normalizeMemberIdForLookup(inputEl.value || "");
}

function updateCenterFormValues(centerValue, staffValue) {
  const centerEl = document.getElementById("centerSelect");
  const staffEl = document.getElementById("staffInput");
  if (centerEl) centerEl.value = centerValue ?? "";
  if (staffEl) staffEl.value = staffValue ?? "";
}

let initialMemberId = (() => {
  const raw = queryParams.get("id") || "";
  if (!raw) return "";
  return normalizeMemberIdForLookup(raw.trim());
})();

function escapeHtml(value) {
  const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };
  return String(value ?? "").replace(/[&<>"']/g, ch => map[ch]);
}

function callGoogle(fnName, ...args) {
  console.log("ğŸ” callGoogle invoked", fnName, args);  // â† è¿½åŠ 
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(res => {
        console.log("âœ… callGoogle success", res);
        resolve(res);
      })
      .withFailureHandler(err => {
        console.error("âŒ callGoogle error", err);
        reject(err);
      })[fnName](...args);
  });
}



function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = String(reader.result || "");
      const base64 = result.includes(",") ? result.split(",")[1] : result;
      resolve({
        base64,
        mimeType: file.type || "application/octet-stream",
        name: file.name || "attachment"
      });
    };
    reader.onerror = () => reject(reader.error || new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    reader.readAsDataURL(file);
  });
}

function getRecordTimestamp(record) {
  if (record && typeof record.timestamp === "number" && !isNaN(record.timestamp)) {
    return record.timestamp;
  }
  if (record && record.date instanceof Date && !isNaN(record.date.getTime())) {
    return record.date.getTime();
  }
  const raw = record && (record.dateValue || record.dateText || record.date);
  const parsed = raw ? Date.parse(raw) : NaN;
  return isNaN(parsed) ? null : parsed;
}

function normalizeRecord(record) {
  const attachments = Array.isArray(record.attachments) ? record.attachments : [];
  return {
    ...record,
    attachments,
    timestamp: getRecordTimestamp(record)
  };
}

function buildAttachmentViewUrl(att) {
  if (!att) return "#";
  if (att.url) return att.url;
  if (att.fileId) return "https://drive.google.com/file/d/" + att.fileId + "/view";
  return "#";
}

function buildAttachmentThumbnailUrl(att) {
  if (!att) return "";
  if (att.fileId) {
    return "https://drive.google.com/thumbnail?id=" + att.fileId + "&sz=w200";
  }
  return "";
}

function setMemberStatusMessage(text) {
  const statusEl = document.getElementById("idStatus");
  if (statusEl) {
    statusEl.textContent = text || "";
  }
}

function refreshMemberList() {
  memberListLoading = true;
  memberListLoaded = false;
  memberSearchResults = [];
  setMemberStatusMessage("èª­ã¿è¾¼ã¿ä¸­â€¦");
  google.script.run.withSuccessHandler(list => {
    const mapped = Array.isArray(list)
      ? list.map(item => {
          const entry = item && typeof item === "object" ? item : {};
          const id = String(entry.id || "").trim();
          const idNormalized = normalizeMemberIdForLookup(id);
          const name = entry.name != null ? String(entry.name).trim() : "";
          const rawYomi = entry.yomi != null ? String(entry.yomi).trim() : "";
          const rawKana = entry.kana != null ? String(entry.kana).trim() : "";
          const yomi = rawYomi || rawKana;
          const kana = rawKana || rawYomi;
          const careManager = entry.careManager != null ? String(entry.careManager).trim() : "";
          const nameNormalized = normalizeMemberSearchText(name);
          const kanaNormalized = normalizeMemberSearchText(kana);
          const yomiNormalized = normalizeMemberSearchText(yomi);
          return {
            id,
            idNormalized,
            name,
            nameNormalized,
            yomi,
            kana,
            careManager,
            kanaNormalized,
            yomiNormalized
          };
        })
      : [];
    memberList = mapped;
    memberListLoading = false;
    memberListLoaded = true;
    setMemberStatusMessage(memberList.length ? `${memberList.length}åã®åˆ©ç”¨è€…ã‚’å–å¾—ã—ã¾ã—ãŸ` : "åˆ©ç”¨è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    memberList.sort(compareEntriesByFurigana);
    if (input) {
      const currentValue = input.value || "";
      if (currentValue.trim()) {
        searchUsers(currentValue);
      } else if (listBox) {
        listBox.innerHTML = "";
        listBox.style.display = "none";
      }
    }
    if (initialMemberId && !memberId) {
      const hit = memberList.find(m => m.id === initialMemberId);
      if (hit) {
        selectMember(hit.id, hit.name);
        initialMemberId = "";
      } else if (initialMemberId) {
        selectMember(initialMemberId, "");
        initialMemberId = "";
      }
    }
  }).withFailureHandler(err => {
    console.error("member list error", err);
    memberListLoading = false;
    setMemberStatusMessage("åˆ©ç”¨è€…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }).getMemberList();
}

function loadDashboard() {
  const statusEl = document.getElementById("dashboardStatus");
  const container = document.getElementById("dashboardTable");
  if (statusEl) statusEl.textContent = "èª­è¾¼ä¸­â€¦";
  if (container) container.innerHTML = "";
  callGoogle("getDashboardSummary").then(res => {
    if (!res || res.status !== "success") {
      if (statusEl) statusEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + (res && res.message ? res.message : "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      dashboardState.data = [];
      dashboardState.monthLabel = "";
      dashboardState.monthBadgeLabel = "";
      dashboardState.previousMonthLabel = "";
      dashboardState.previousMonthBadgeLabel = "";
      dashboardState.activeInitial = null;
      if (container) container.innerHTML = "";
      return;
    }
    dashboardState.data = Array.isArray(res.data) ? res.data : [];
    dashboardState.monthLabel = res.monthLabel || "";
    dashboardState.monthBadgeLabel = res.monthBadgeLabel || "";
    dashboardState.previousMonthLabel = res.previousMonthLabel || "";
    dashboardState.previousMonthBadgeLabel = res.previousMonthBadgeLabel || "";
    dashboardState.activeInitial = null;
    renderDashboard();
  }).catch(err => {
    console.error("dashboard error", err);
    if (statusEl) statusEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + (err && err.message ? err.message : err);
    dashboardState.data = [];
    dashboardState.monthLabel = "";
    dashboardState.monthBadgeLabel = "";
    dashboardState.previousMonthLabel = "";
    dashboardState.previousMonthBadgeLabel = "";
    dashboardState.activeInitial = null;
  });
}

function renderDashboard() {
  const container = document.getElementById("dashboardTable");
  const filterContainer = document.getElementById("dashboardFilters");
  const indexContainer = document.getElementById("dashboardIndex");
  const statusEl = document.getElementById("dashboardStatus");
  if (!container) return;

  const sortedData = getSortedDashboardData();
  const careManagerOptions = getDashboardCareManagerOptions(sortedData);
  if (!dashboardState.filters || typeof dashboardState.filters !== "object") {
    dashboardState.filters = { status: "all", careManagers: [] };
  }
  const validStatus = MEMBER_STATUS_FILTER_VALUES;
  if (!validStatus.includes(dashboardState.filters.status)) {
    dashboardState.filters.status = "all";
  }
  if (!Array.isArray(dashboardState.filters.careManagers)) {
    dashboardState.filters.careManagers = [];
  }
  const normalizedCare = dashboardState.filters.careManagers.filter(name => careManagerOptions.includes(name));
  if (normalizedCare.length !== dashboardState.filters.careManagers.length) {
    dashboardState.filters.careManagers = normalizedCare;
  }

  const filteredData = applyDashboardFilters(sortedData);
  const indexGroups = getDashboardIndexGroups(filteredData);
  const sections = buildDashboardSections(filteredData);

  if (!dashboardState.collapsedSections || typeof dashboardState.collapsedSections !== "object") {
    dashboardState.collapsedSections = {};
  }
  let collapseChanged = false;
  sections.forEach(section => {
    if (!(section.label in dashboardState.collapsedSections)) {
      dashboardState.collapsedSections[section.label] = true;
      collapseChanged = true;
    }
  });
  Object.keys(dashboardState.collapsedSections).forEach(label => {
    if (!sections.some(section => section.label === label)) {
      delete dashboardState.collapsedSections[label];
      collapseChanged = true;
    }
  });
  if (memberId) {
    const targetSection = sections.find(section => section.entries.some(entry => entry && entry.id === memberId));
    if (targetSection) {
      if (dashboardState.collapsedSections[targetSection.label] !== false) {
        dashboardState.collapsedSections[targetSection.label] = false;
        collapseChanged = true;
      }
      if (!dashboardState.pendingScrollLabel && dashboardState.activeInitial !== targetSection.label) {
        dashboardState.activeInitial = targetSection.label;
      }
    }
  }
  if (collapseChanged) {
    saveDashboardCollapsedSections();
  }

  if (!dashboardState.activeInitial || !sections.some(section => section.label === dashboardState.activeInitial)) {
    dashboardState.activeInitial = sections.length ? sections[0].label : null;
  }

  if (statusEl) {
    const monthParts = [];
    if (dashboardState.monthLabel) {
      monthParts.push(`å¯¾è±¡æœˆï¼š${dashboardState.monthLabel}`);
    }
    if (dashboardState.previousMonthLabel) {
      monthParts.push(`å‰æœˆï¼š${dashboardState.previousMonthLabel}`);
    }
    const monthLabel = monthParts.join(" ï¼ ");
    const countLabel = `${filteredData.length}å / å…¨${sortedData.length}å`;
    statusEl.textContent = monthLabel ? `${monthLabel}ï¼ˆ${countLabel}ï¼‰` : countLabel;
  }

  if (filterContainer) {
    const currentStatus = dashboardState.filters.status;
    const statusOptions = [
      { value: "all", label: "ã™ã¹ã¦", icon: "ğŸŒ" },
      ...MEMBER_STATUS_ORDER.map(value => {
        const meta = getMemberStatusMeta(value);
        return { value, label: meta.label, icon: meta.icon };
      })
    ];
    const statusButtonsHtml = statusOptions.map(opt => {
      const active = opt.value === currentStatus;
      const label = opt.icon ? `${opt.icon} ${opt.label}` : opt.label;
      return `<button type="button" class="dashboard-status-btn${active ? " active" : ""}" data-status="${opt.value}" aria-pressed="${active}">${escapeHtml(label)}</button>`;
    }).join("");

    const chipsHtml = careManagerOptions.length
      ? careManagerOptions.map(name => {
          const active = dashboardState.filters.careManagers.includes(name);
          return `<button type="button" class="dashboard-chip${active ? " active" : ""}" data-care="${escapeHtml(name)}" aria-pressed="${active}">${escapeHtml(name)}</button>`;
        }).join("")
      : `<div class="dashboard-index-note">æ‹…å½“è€…æƒ…å ±ãŒæœªç™»éŒ²ã§ã™</div>`;

    filterContainer.innerHTML = `
      <div class="dashboard-filter-row">
        <div class="dashboard-filter">
          <span class="dashboard-filter-label">åˆ©ç”¨è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
          <div class="dashboard-status-buttons" id="dashboardStatusButtons">${statusButtonsHtml}</div>
        </div>
        <div class="dashboard-filter">
          <label>æ‹…å½“ã‚±ã‚¢ãƒãƒ</label>
          <div class="dashboard-care-chips">
            ${chipsHtml}
          </div>
        </div>
        <button type="button" id="dashboardClearFilters" class="secondary btn-compact">ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="dashboard-filter-summary">çµã‚Šè¾¼ã¿ï¼š${filteredData.length}å / å…¨${sortedData.length}å</div>
    `;
  }

  if (!filteredData.length) {
    container.innerHTML = '<div class="muted">è©²å½“ã™ã‚‹åˆ©ç”¨è€…ãŒã„ã¾ã›ã‚“ã€‚</div>';
  } else {
    container.innerHTML = sections.map(section => {
      const sectionId = getDashboardSectionDomId(section.label);
      const collapsed = dashboardState.collapsedSections[section.label] !== false;
      const isOpen = !collapsed;
      const headerHtml = `
        <button type="button" class="dashboard-section-toggle${isOpen ? " is-open" : ""}" data-section="${escapeHtml(section.label)}" aria-expanded="${isOpen}" aria-controls="${sectionId}-body">
          <span>${escapeHtml(section.label)}</span>
          <span class="dashboard-section-count">${section.entries.length}å</span>
        </button>
      `;
      const rows = section.entries.map(entry => {
        const statusKey = getMemberStatusValue(entry && entry.memberStatus);
        const statusMeta = getMemberStatusMeta(statusKey);
        const statusLabel = statusMeta.icon ? `${statusMeta.icon} ${statusMeta.label}` : statusMeta.label;
        const safeId = escapeHtml(entry.id || "");
        const statusButtons = MEMBER_STATUS_ORDER.map(value => {
          const meta = getMemberStatusMeta(value);
          const active = value === statusKey;
          const label = meta.icon ? `${meta.icon} ${meta.label}` : meta.label;
          return `<button type="button" class="dashboard-status-btn${active ? " active" : ""}" data-status="${value}" data-member="${safeId}" aria-pressed="${active}">${escapeHtml(label)}</button>`;
        }).join("");
        const safeNameAttr = escapeHtml(entry.name || "");
        const displayName = entry.name ? escapeHtml(entry.name) : "ï¼ˆæ°åæœªç™»éŒ²ï¼‰";
        const latest = entry.latestDateText ? escapeHtml(entry.latestDateText) : "---";
        const careRaw = String(entry.careManager || "").trim();
        const careParts = parseCareManagerList(careRaw);
        const careLabel = careParts.length
          ? careParts.map(part => escapeHtml(part)).join('ï¼')
          : '<span class="muted">æ‹…å½“æœªè¨­å®š</span>';
        const count = Number(entry.countThisMonth || 0);
        const selected = memberId && entry.id === memberId ? " selected" : "";
        const monitoringSection = buildMonitoringSectionHtml(entry);
        const statusBadgeHtml = `<span class="dashboard-status-badge ${statusKey}">${escapeHtml(statusLabel)}</span>`;
        const statusRowParts = [];
        if (monitoringSection) {
          statusRowParts.push(monitoringSection);
        }
        statusRowParts.push(`<div class="dashboard-status-indicator">${statusBadgeHtml}</div>`);
        const statusRowHtml = `<div class="dashboard-entry-status-row">${statusRowParts.join("")}</div>`;
        return `
          <div class="dashboard-entry status-${statusKey}${selected}">
            <div class="dashboard-entry-main">
              <div class="dashboard-entry-name">
                <span>${displayName}</span>
                <span class="dashboard-entry-id">${safeId}</span>
              </div>
              <div class="dashboard-entry-meta">
                <span>æ‹…å½“ï¼š${careLabel}</span>
                <span>æœ€æ–°è¨˜éŒ²ï¼š${latest}</span>
                <span>ä»Šæœˆï¼š${count}ä»¶</span>
              </div>
              ${statusRowHtml}
            </div>
            <div class="dashboard-entry-actions">
              <div class="dashboard-status-controls" data-member="${safeId}">
                <div class="dashboard-status-buttons">${statusButtons}</div>
              </div>
              <button class="secondary btn-compact dashboard-select" data-id="${safeId}" data-name="${safeNameAttr}">è¡¨ç¤º</button>
            </div>
          </div>
        `;
      }).join("");
      return `
        <section class="dashboard-section" id="${sectionId}" data-section-label="${escapeHtml(section.label)}">
          ${headerHtml}
          <div class="dashboard-section-body${isOpen ? " is-open" : ""}" id="${sectionId}-body">
            ${rows}
          </div>
        </section>
      `;
    }).join("");
  }

  if (indexContainer) {
    if (!indexGroups.length) {
      indexContainer.innerHTML = `<div class="dashboard-index-empty">è©²å½“ãªã—</div>`;
    } else {
      indexContainer.innerHTML = indexGroups.map(label => {
        const sectionId = getDashboardSectionDomId(label);
        const active = dashboardState.activeInitial === label ? " active" : "";
        return `<button type="button" class="dashboard-index-btn${active}" data-index="${escapeHtml(label)}" data-target="${sectionId}">${escapeHtml(label)}</button>`;
      }).join("");
    }
  }

  bindDashboardActions();
  bindDashboardUi();
  updateDashboardFilterQueryParams();

  if (dashboardState.pendingScrollLabel) {
    const scrollId = getDashboardSectionDomId(dashboardState.pendingScrollLabel);
    requestAnimationFrame(() => {
      const target = document.getElementById(scrollId);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
    dashboardState.pendingScrollLabel = null;
  }
}

function bindDashboardUi() {
  const filterContainer = document.getElementById("dashboardFilters");
  if (filterContainer) {
    if (!dashboardState.filters || typeof dashboardState.filters !== "object") {
      dashboardState.filters = { status: "all", careManagers: [] };
    }
    const validStatus = MEMBER_STATUS_FILTER_VALUES;
    const statusButtons = filterContainer.querySelectorAll("#dashboardStatusButtons .dashboard-status-btn");
    statusButtons.forEach(btn => {
      const value = btn.dataset.status || "all";
      btn.onclick = () => {
        dashboardState.filters.status = validStatus.includes(value) ? value : "all";
        renderDashboard();
      };
    });
    filterContainer.querySelectorAll(".dashboard-chip").forEach(btn => {
      const name = btn.dataset.care || "";
      btn.onclick = () => {
        if (!name) return;
        const current = Array.isArray(dashboardState.filters.careManagers) ? dashboardState.filters.careManagers.slice() : [];
        const idx = current.indexOf(name);
        if (idx >= 0) {
          current.splice(idx, 1);
        } else {
          current.push(name);
        }
        dashboardState.filters.careManagers = current;
        renderDashboard();
      };
    });
    const clearBtn = filterContainer.querySelector("#dashboardClearFilters");
    if (clearBtn) {
      clearBtn.onclick = () => {
        dashboardState.filters = { status: "all", careManagers: [] };
        renderDashboard();
      };
    }
  }

  const container = document.getElementById("dashboardTable");
  if (container) {
    container.querySelectorAll(".dashboard-section-toggle").forEach(btn => {
      const label = btn.dataset.section || "";
      btn.onclick = () => {
        if (!label) return;
        if (!dashboardState.collapsedSections || typeof dashboardState.collapsedSections !== "object") {
          dashboardState.collapsedSections = {};
        }
        const collapsed = dashboardState.collapsedSections[label] !== false;
        if (collapsed) {
          dashboardState.collapsedSections[label] = false;
          dashboardState.activeInitial = label;
        } else {
          dashboardState.collapsedSections[label] = true;
        }
        saveDashboardCollapsedSections();
        renderDashboard();
      };
    });
  }

  const nav = document.getElementById("dashboardIndex");
  if (nav) {
    nav.querySelectorAll(".dashboard-index-btn").forEach(btn => {
      const label = btn.dataset.index || "";
      btn.onclick = () => { jumpToDashboardInitial(label); };
    });
  }
}

function bindDashboardActions() {
  const container = document.getElementById("dashboardTable");
  if (!container) return;
  container.querySelectorAll(".dashboard-select").forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.id || "";
      const name = btn.dataset.name || "";
      selectMember(toHalfDigits(id), name);
    };
  });
  container.querySelectorAll(".dashboard-status-controls .dashboard-status-btn").forEach(btn => {
    const member = btn.dataset.member || "";
    const status = btn.dataset.status || "";
    btn.onclick = () => {
      updateDashboardMemberStatus(member, status);
    };
  });
}

async function updateDashboardMemberStatus(memberId, status) {
  const member = String(memberId || "").trim();
  const normalizedStatus = normalizeMemberStatusValue(status);
  if (!member || !normalizedStatus) return;
  const currentEntry = (Array.isArray(dashboardState.data) ? dashboardState.data : []).find(entry => entry && entry.id === member);
  if (currentEntry && getMemberStatusValue(currentEntry.memberStatus) === normalizedStatus) {
    return;
  }
  const relatedButtons = Array.from(document.querySelectorAll(`.dashboard-status-controls[data-member="${member}"] .dashboard-status-btn`));
  relatedButtons.forEach(btn => { btn.disabled = true; });
  try {
    const res = await callGoogle("updateMemberStatus", member, normalizedStatus);
    if (!res || res.status !== "success") {
      const msg = res && res.message ? res.message : "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ";
      throw new Error(msg);
    }
    dashboardState.data = (Array.isArray(dashboardState.data) ? dashboardState.data : []).map(entry => {
      if (entry && entry.id === member) {
        return { ...entry, memberStatus: normalizedStatus };
      }
      return entry;
    });
    renderDashboard();
  } catch (err) {
    console.error("updateMemberStatus", err);
    const message = err && err.message ? err.message : err;
    window.alert(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${message}`);
  } finally {
    relatedButtons.forEach(btn => { btn.disabled = false; });
  }
}

let input = null;
let listBox = null;
let searchBoxInitialized = false;

function searchUsers(rawQuery) {
  if (!listBox) return;
  const source = rawQuery == null ? "" : String(rawQuery);
  const query = source.trim();
  if (memberListLoading && query) {
    listBox.innerHTML = '<div class="autocomplete-item autocomplete-empty" data-empty="true">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
    listBox.style.display = "block";
    listBox.scrollTop = 0;
    return;
  }
  if (!memberListLoaded && !memberListLoading && query) {
    listBox.innerHTML = '<div class="autocomplete-item autocomplete-empty" data-empty="true">åˆ©ç”¨è€…æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    listBox.style.display = "block";
    listBox.scrollTop = 0;
    return;
  }
  if (!query) {
    listBox.innerHTML = "";
    listBox.style.display = "none";
    listBox.scrollTop = 0;
    memberSearchResults = [];
    return;
  }
  const idDigits = extractMemberIdDigits(query);
  const normalizedId = normalizeMemberIdForLookup(query);
  const normalizedQuery = normalizeMemberSearchText(query);
  const list = Array.isArray(memberList) ? memberList : [];
  const hits = list
    .filter(member => memberMatchesQuery(member, query, idDigits, normalizedQuery, normalizedId))
    .slice(0, 20);
  memberSearchResults = hits;
  if (!hits.length) {
    listBox.innerHTML = '<div class="autocomplete-item autocomplete-empty" data-empty="true">è©²å½“è€…ãªã—</div>';
    listBox.style.display = "block";
    listBox.scrollTop = 0;
    return;
  }
  listBox.innerHTML = hits
    .map(member => {
      const reading = member.yomi || member.kana;
      const yomiLabel = reading ? ` <span class="muted">(${escapeHtml(reading)})</span>` : "";
      return `<div class="autocomplete-item" data-id="${member.id}" data-name="${escapeHtml(member.name)}">${member.id}ã€€${escapeHtml(member.name)}${yomiLabel}</div>`;
    })
    .join("");
  listBox.style.display = "block";
  listBox.scrollTop = 0;
}

function setupSearchBox() {
  if (!input) input = document.getElementById("memberIdInput");
  if (!listBox) listBox = document.getElementById("autocompleteList");
  if (!input || !listBox) return;
  if (searchBoxInitialized) return;
  searchBoxInitialized = true;
  const handleInput = () => searchUsers(input.value);
  input.addEventListener("input", handleInput);
  input.addEventListener("change", resolveInput);
  listBox.addEventListener("click", e => {
    const rawTarget = e.target;
    const target = rawTarget instanceof Element ? rawTarget : rawTarget && rawTarget.parentElement;
    const item = target ? target.closest(".autocomplete-item") : null;
    if (!item || item.dataset.empty === "true") return;
    selectMember(item.dataset.id, item.dataset.name);
  });
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); resolveInput(); }
  });
  input.addEventListener("blur", () => { setTimeout(resolveInput, 100); });
}

function resolveInput() {
  const val = input.value.trim();
  if (!val) return;
  if (Array.isArray(memberSearchResults) && memberSearchResults.length === 1) {
    const only = memberSearchResults[0];
    if (only && only.id) {
      selectMember(only.id, only.name || "");
      return;
    }
  }
  const idDigits = extractMemberIdDigits(val);
  const normalizedId = normalizeMemberIdForLookup(val);
  const normalizedQuery = normalizeMemberSearchText(val);
  let hit = null;
  if (normalizedId) {
    hit = memberList.find(m => {
      const memberId = m.id != null ? String(m.id) : "";
      const memberIdNormalized = m.idNormalized != null ? String(m.idNormalized) : "";
      return memberId === normalizedId || memberIdNormalized === normalizedId;
    });
  }
  if (!hit && idDigits) {
    hit = memberList.find(m => {
      const memberIdNormalized = m.idNormalized != null ? String(m.idNormalized) : "";
      if (!memberIdNormalized) return false;
      if (memberIdNormalized === idDigits) return true;
      return memberIdNormalized === idDigits.padStart(memberIdNormalized.length, "0");
    });
  }
  if (!hit) {
    hit = memberList.find(m => m.name === val);
  }
  if (!hit) {
    hit = memberList.find(m => (m.kana && m.kana === val) || (m.yomi && m.yomi === val));
  }
  if (!hit && normalizedQuery) {
    hit = memberList.find(m => {
      return m.nameNormalized === normalizedQuery ||
        m.kanaNormalized === normalizedQuery ||
        m.yomiNormalized === normalizedQuery;
    });
  }
  if (!hit) {
    hit = memberList.find(m => memberMatchesQuery(m, val, idDigits, normalizedQuery, normalizedId));
  }
  if (hit) { selectMember(hit.id, hit.name); return; }
  if (normalizedId) { selectMember(normalizedId, ""); return; }
  const statusEl = document.getElementById("idStatus");
  if (statusEl) statusEl.textContent = "å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
}

function selectMember(id, name) {
  console.log("[member] selectMember:start", { id, name });
  const rawId = id != null ? String(id) : "";
  const inputFallback = input && input.value ? input.value : "";
  const safeId = normalizeMemberIdForLookup(rawId || inputFallback);
  if (!safeId) {
    console.warn("[member] selectMember:missing-id", { id, name, inputValue: inputFallback });
    setMemberStatusMessage("åˆ©ç”¨è€…IDã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
    return;
  }
  const safeName = name != null ? String(name).trim() : "";
  memberId = safeId;
  memberName = safeName;
  const label = `${safeId}${safeName ? "ã€€" + safeName : ""}`;
  if (input) input.value = label;
  if (listBox) {
    listBox.style.display = "none";
    listBox.innerHTML = "";
  }
  setMemberStatusMessage(`é¸æŠä¸­: ${label}`);
  const filterKindEl = document.getElementById("filterKind");
  if (filterKindEl) filterKindEl.value = "all";
  const fromEl = document.getElementById("filterDateFrom");
  if (fromEl) fromEl.value = "";
  const toEl = document.getElementById("filterDateTo");
  if (toEl) toEl.value = "";
  const textEl = document.getElementById("filterText");
  if (textEl) textEl.value = "";
  const summaryEl = document.getElementById("summaryOutput");
  if (summaryEl) summaryEl.textContent = "ã“ã“ã«è¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
  const adviceEl = document.getElementById("adviceOutput");
  if (adviceEl) adviceEl.textContent = "ã“ã“ã«ææ¡ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
  console.log("[member] selectMember:load", { id: safeId });
  loadMemberData(safeId, { name: memberName, label });
  loadMemberCenterInfo(safeId);
  console.log("[member] selectMember:complete", { id: safeId, name: memberName });
}

function loadMemberData(userId, options = {}) {
  const safeId = String(userId || "").trim();
  const name = options.name != null ? String(options.name) : (memberName || "");
  const label = options.label || `${safeId}${name ? "ã€€" + name : ""}`;
  console.log("[member] loadMemberData:start", { userId: safeId, name });
  if (!safeId) {
    console.warn("[member] loadMemberData:missing-id", { userId });
    return;
  }
  const mainArea = document.getElementById("mainArea");
  if (mainArea) {
    mainArea.style.display = "block";
  } else {
    console.warn("[member] loadMemberData:mainArea-not-found");
  }
  const tagEl = document.getElementById("memberTag");
  if (tagEl) {
    tagEl.textContent = label;
  } else {
    console.warn("[member] loadMemberData:memberTag-not-found");
  }
  updateMediaGallery([]);
  closeShareForm();
  resetShareListPlaceholder();
  renderDashboard();
  loadRecords();
  fetchExternalShareList();
  console.log("[member] loadMemberData:complete", { userId: safeId, name });
}

function setupMemberUi() {
  const btnAddMember = document.getElementById("btnAddMember");
  if (btnAddMember) {
    btnAddMember.onclick = () => {
      const idInput = document.getElementById("newMemberId");
      const nameInput = document.getElementById("newMemberName");
      const kanaInput = document.getElementById("newMemberKana");
      const status = document.getElementById("addMemberStatus");
      if (status) { status.textContent = ""; }

      const rawId = (idInput.value || "").replace(/[^0-9]/g, "");
      const name = (nameInput.value || "").trim();
      const rawKana = (kanaInput && kanaInput.value ? kanaInput.value : "").trim();

      if (!rawId) {
        if (status) status.textContent = "IDï¼ˆ4æ¡ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        idInput.focus();
        return;
      }

      if (rawId.length > 4) {
        if (status) status.textContent = "IDã¯4æ¡ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„";
        idInput.focus();
        return;
      }

      const id = rawId.padStart(4, "0");
      if (!name) {
        if (status) status.textContent = "æ°åï¼ˆæ¼¢å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        nameInput.focus();
        return;
      }

      const kanaSource = (typeof rawKana.normalize === 'function') ? rawKana.normalize('NFKC') : rawKana;
      const kanaNormalized = kanaSource
        .replace(/[\s\u3000]+/g, " ")
        .replace(/[ï½°ï¼â€”â€“]/g, "ãƒ¼")
        .trim();

      if (!kanaNormalized) {
        if (status) status.textContent = "ãƒ•ãƒªã‚¬ãƒŠï¼ˆã‚«ãƒŠï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        if (kanaInput) kanaInput.focus();
        return;
      }

      if (!/^[\u30A0-\u30FFãƒ¼\sï¾ï¾Ÿï½¥ãƒ»]+$/.test(kanaNormalized)) {
        if (status) status.textContent = "ãƒ•ãƒªã‚¬ãƒŠã¯ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„";
        if (kanaInput) kanaInput.focus();
        return;
      }

      if (status) status.textContent = "ç™»éŒ²ä¸­â€¦";
      google.script.run.withSuccessHandler(res => {
        if (res.status === "success") {
          if (status) status.textContent = `ç™»éŒ²ã—ã¾ã—ãŸ: ${res.id} ${res.name}${res.kana ? `ï¼ˆ${res.kana}ï¼‰` : ""}`;
          idInput.value = "";
          nameInput.value = "";
          if (kanaInput) kanaInput.value = "";
          if (res.id) {
            selectMember(res.id, res.name || "");
          }
          refreshMemberList();
          loadDashboard();
        } else {
          if (status) status.textContent = "å¤±æ•—: " + res.message;
        }
      }).withFailureHandler(err => {
        if (status) status.textContent = "ã‚¨ãƒ©ãƒ¼: " + (err && err.message ? err.message : err);
      }).addMember(id, name, kanaNormalized);
    };
  }

  const btnSave = document.getElementById("btnSave");
  if (btnSave) {
    btnSave.addEventListener("click", handleSave);
  }

  const btnSummary = document.getElementById("btnSummary");
  if (btnSummary) {
    btnSummary.onclick = () => {
      if (!memberId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const fmt = document.getElementById("summaryFormat").value;
      const days = document.getElementById("recordRange").value;
      const out = document.getElementById("summaryOutput");
      out.textContent = "ç”Ÿæˆä¸­â€¦";
      google.script.run.withSuccessHandler(res => {
        out.textContent = (res.status === "success") ? res.summary : ("å¤±æ•—:" + res.message);
      }).withFailureHandler(err => {
        out.textContent = "å¤±æ•—: " + (err && err.message ? err.message : err);
      }).generateAISummaryForDays(memberId, fmt, days);
    };
  }

  const btnAdvice = document.getElementById("btnAdvice");
  if (btnAdvice) {
    btnAdvice.onclick = () => {
      if (!memberId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const horizon = document.getElementById("adviceHorizonSelect").value;
      const days = document.getElementById("recordRange").value;
      const out = document.getElementById("adviceOutput");
      out.textContent = "ç”Ÿæˆä¸­â€¦";
      google.script.run.withSuccessHandler(res => {
        out.textContent = (res.status === "success") ? res.advice : ("å¤±æ•—:" + res.message);
      }).withFailureHandler(err => {
        out.textContent = "å¤±æ•—: " + (err && err.message ? err.message : err);
      }).generateCareAdviceWithHorizon(memberId, days, horizon);
    };
  }

  const btnReload = document.getElementById("btnReload");
  if (btnReload) {
    btnReload.onclick = () => {
      loadRecords();
      const currentId = getCurrentMemberIdForCenter();
      if (currentId) {
        loadMemberCenterInfo(currentId);
      }
    };
  }

  const btnSaveCenter = document.getElementById("btnSaveCenter");
  if (btnSaveCenter) {
    btnSaveCenter.onclick = () => {
      const targetId = getCurrentMemberIdForCenter();
      if (!targetId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const centerValue = document.getElementById("centerSelect")?.value || "";
      const staffValue = document.getElementById("staffInput")?.value || "";
      google.script.run
        .withSuccessHandler(res => {
          if (res && res.ok) {
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            loadMemberCenterInfo(targetId);
          } else {
            const msg = res && res.message ? res.message : "";
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + msg);
          }
        })
        .withFailureHandler(err => {
          const msg = err && err.message ? err.message : String(err);
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + msg);
        })
        .saveMemberCenterInfo(targetId, centerValue, staffValue);
    };
  }

  const btnClearCenter = document.getElementById("btnClearCenter");
  if (btnClearCenter) {
    btnClearCenter.onclick = () => {
      const targetId = getCurrentMemberIdForCenter();
      if (!targetId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      google.script.run
        .withSuccessHandler(res => {
          if (res && res.ok) {
            alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            updateCenterFormValues("", "");
          } else {
            const msg = res && res.message ? res.message : "";
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + msg);
          }
        })
        .withFailureHandler(err => {
          const msg = err && err.message ? err.message : String(err);
          alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + msg);
        })
        .clearMemberCenterInfo(targetId);
    };
  }

  const range = document.getElementById("recordRange");
  if (range) {
    range.addEventListener("change", () => {
      if (memberId) loadRecords();
    });
  }
}






async function handleSave() {
  const text = document.getElementById("inputText").value.trim();
  const files = Array.from(document.getElementById("fileInput").files || []);
  const status = document.getElementById("saveStatus");
  if (!memberId) { alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  if (!text && files.length === 0) { alert("å†…å®¹ã¾ãŸã¯æ·»ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  status.textContent = "é€ä¿¡ä¸­â€¦";
  try {
    const kind = document.getElementById("kindSelect").value;
    const attachmentsMeta = [];
    for (const file of files) {
      const payload = await readFileAsBase64(file);
      const uploadRes = await callGoogle("uploadAttachment_", memberId, payload.name, payload.mimeType, payload.base64);
      if (!uploadRes || uploadRes.status !== "success") {
        throw new Error(uploadRes && uploadRes.message ? uploadRes.message : "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      attachmentsMeta.push({
        fileId: uploadRes.fileId,
        url: uploadRes.url,
        name: uploadRes.name || payload.name,
        mimeType: uploadRes.mimeType || payload.mimeType
      });
    }
    await callGoogle("saveRecordFromBrowser", memberId, text, new Date().toISOString(), JSON.stringify(attachmentsMeta), kind);
    status.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
    document.getElementById("inputText").value = "";
    document.getElementById("fileInput").value = "";
    setTimeout(() => { status.textContent = ""; }, 3000);
    loadRecords();
    loadDashboard();
  } catch (err) {
    status.textContent = "å¤±æ•—: " + (err && err.message ? err.message : err);
  }
}

function fetchShareMeta(token, recordId) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .getExternalShareMeta(token, recordId);
  });
}

async function initShareView() {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("shareId");
  const recordId = urlParams.get("recordId");

  try {
    const meta = await fetchShareMeta(token, recordId);
    console.log("âœ… fetchShareMeta result:", meta);
    // ã“ã“ã§ UI ã«åæ˜ ã™ã‚‹å‡¦ç†ã‚’æ›¸ã
  } catch (err) {
    console.error("âŒ fetchShareMeta failed:", err);
  }
}

window.addEventListener("DOMContentLoaded", initShareView);


function renderAttachment(att, record, index) {
  const url = escapeHtml(buildAttachmentViewUrl(att));
  const label = escapeHtml(att && att.name ? att.name : `æ·»ä»˜${index + 1}`);
  return `<a href="${url}" target="_blank" rel="noopener">ğŸ“ ${label}</a>`;
}

function filterRecords(records) {
  const kind = document.getElementById("filterKind").value;
  const text = document.getElementById("filterText").value.trim().toLowerCase();
  const fromVal = document.getElementById("filterDateFrom").value;
  const toVal = document.getElementById("filterDateTo").value;
  const fromTime = fromVal ? new Date(fromVal + "T00:00:00").getTime() : null;
  const toTime = toVal ? new Date(toVal + "T23:59:59").getTime() : null;
  return records.filter(r => {
    const ts = getRecordTimestamp(r);
    if (kind && kind !== "all" && String(r.kind) !== kind) return false;
    if (fromTime && (ts === null || ts < fromTime)) return false;
    if (toTime && (ts === null || ts > toTime)) return false;
    if (text) {
      const hay = `${(r.text || "").toLowerCase()} ${(r.kind || "").toLowerCase()}`;
      if (!hay.includes(text)) return false;
    }
    return true;
  }).sort((a, b) => (getRecordTimestamp(b) || 0) - (getRecordTimestamp(a) || 0));
}

function updateMediaGallery(records) {
  const gallery = document.getElementById("mediaGallery");
  if (!gallery) return;
  if (!records || !records.length) {
    gallery.textContent = "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“";
    return;
  }
  const items = [];
  records.forEach(r => {
    if (Array.isArray(r.attachments)) {
      r.attachments.forEach(att => items.push({ attachment: att, record: r }));
    }
  });
  if (!items.length) {
    gallery.textContent = "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“";
    return;
  }
  const cards = items.map(item => {
    const att = item.attachment || {};
    const rec = item.record || {};
    const viewUrl = escapeHtml(buildAttachmentViewUrl(att));
    const thumbUrlRaw = buildAttachmentThumbnailUrl(att);
    const thumbUrl = thumbUrlRaw ? escapeHtml(thumbUrlRaw) : "";
    const isImage = att.mimeType && att.mimeType.indexOf("image/") === 0;
    const preview = (isImage && thumbUrl)
      ? `<img src="${thumbUrl}" alt="${escapeHtml(att.name || "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«")}ã®ã‚µãƒ ãƒã‚¤ãƒ«">`
      : `<div class="media-icon">ğŸ“</div>`;
    return `<div class="media-card">
      <a href="${viewUrl}" target="_blank" rel="noopener">
        ${preview}
        <div class="media-meta">
          <div class="name">${escapeHtml(att.name || "æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«")}</div>
          <div>${escapeHtml(rec.dateText || "")}</div>
        </div>
      </a>
    </div>`;
  }).join("");
  gallery.innerHTML = `<div class="media-grid">${cards}</div>`;
}

function toTime(value){
  if(!value) return NaN;
  const d = value instanceof Date ? value : new Date(value);
  const t = d.getTime();
  return Number.isNaN(t) ? NaN : t;
}

function formatDateTime(value){
  const t = toTime(value);
  if(Number.isNaN(t)) return '';
  const d = new Date(t);
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// ===== éå»è¨˜éŒ²ï¼ˆç·¨é›†ãƒ»å‰Šé™¤ä»˜ãï¼‰ =====
function loadRecords(){
  const list = document.getElementById("recordList");
  const rangeEl = document.getElementById("recordRange");
  const gallery = document.getElementById("mediaGallery");
  const days = rangeEl ? rangeEl.value : 'all';
  if(!memberId){
    if(list) list.textContent = "åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„";
    recordsCache = [];
    updateMediaGallery([]);
    updateShareAttachmentOptions([]);
    return;
  }
  if(list) list.textContent = "èª­è¾¼ä¸­â€¦";
  if(gallery) gallery.textContent = "æ·»ä»˜ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦";
  google.script.run.withSuccessHandler(res=>{
    if(!res || res.status!=="success"){
      if(list) list.textContent = "ã‚¨ãƒ©ãƒ¼:" + (res && res.message ? res.message : "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      recordsCache = [];
      updateMediaGallery([]);
      updateShareAttachmentOptions([]);
      return;
    }
    recordsCache = (Array.isArray(res.records)?res.records:[]).map(normalizeRecord);
    renderRecords();
    updateShareAttachmentOptions(recordsCache);
  }).withFailureHandler(err=>{
    const msg = err && err.message ? err.message : err;
    if(list) list.textContent = "ã‚¨ãƒ©ãƒ¼:" + msg;
    recordsCache = [];
    updateMediaGallery([]);
    updateShareAttachmentOptions([]);
  }).getRecordsByMemberId_v3(memberId, days);
}



function renderRecords(){
  const list = document.getElementById("recordList");
  if(!list) return;
  if(!memberId){
    list.textContent = "åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„";
    updateMediaGallery([]);
    return;
  }
  if(!recordsCache.length){
    list.textContent = "è¨˜éŒ²ãªã—";
    updateMediaGallery([]);
    return;
  }
  const filtered = filterRecords(recordsCache);
  if(!filtered.length){
    list.textContent = "æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
    updateMediaGallery([]);
    return;
  }
  const html = filtered.map(record => {
    const safeText = escapeHtml(record.text || '').replace(/\n/g, '<br>');
    const attachmentsHtml = (record.attachments && record.attachments.length)
      ? `<div class="attachments">${record.attachments.map((att, i) => renderAttachment(att, record, i)).join('')}</div>`
      : '';
    return `<div class="record" data-row="${record.rowIndex}">
      <div><b>${escapeHtml(record.dateText || '')}</b>ã€${escapeHtml(record.kind || '')}ã€‘</div>
      <div class="text">${safeText || '<span class="muted">ï¼ˆæœ¬æ–‡ãªã—ï¼‰</span>'}</div>
      ${attachmentsHtml}
      <div class="toolbar">
        <button class="secondary btnEdit">ç·¨é›†</button>
        <button class="danger btnDelete">å‰Šé™¤</button>
      </div>
    </div>`;
  }).join('');
  list.innerHTML = html;
  bindRecordActions();
  updateMediaGallery(filtered);
}

function bindRecordActions() {
  document.querySelectorAll(".btnEdit").forEach(btn => {
    btn.onclick = () => {
      const rec = btn.closest(".record");
      if (!rec) return;
      const row = rec.dataset.row;
      const textEl = rec.querySelector(".text");
      const oldText = textEl ? textEl.textContent : "";
      const nv = prompt("å†…å®¹ã‚’ä¿®æ­£:", oldText);
      if (nv === null) return;
      google.script.run.withSuccessHandler(() => {
        loadRecords();
      }).withFailureHandler(err => {
        alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err && err.message ? err.message : err));
      }).updateRecord(row, nv);
    };
  });
  document.querySelectorAll(".btnDelete").forEach(btn => {
    btn.onclick = () => {
      const rec = btn.closest(".record");
      if (!rec) return;
      const row = rec.dataset.row;
      if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      google.script.run.withSuccessHandler(() => {
        loadRecords();
        loadDashboard();
      }).withFailureHandler(err => {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err && err.message ? err.message : err));
      }).deleteRecord(row);
    };
  });
}


  function setupFilters() {
    ["filterKind", "filterDateFrom", "filterDateTo"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", () => { renderRecords(); });
      }
    });
    const text = document.getElementById("filterText");
    if (text) {
      text.addEventListener("input", () => { renderRecords(); });
    }
    const clear = document.getElementById("btnClearFilters");
    if (clear) {
      clear.addEventListener("click", () => {
        const kindEl = document.getElementById("filterKind");
        const fromEl = document.getElementById("filterDateFrom");
        const toEl = document.getElementById("filterDateTo");
        const textEl = document.getElementById("filterText");
        if (kindEl) kindEl.value = "all";
        if (fromEl) fromEl.value = "";
        if (toEl) toEl.value = "";
        if (textEl) textEl.value = "";
        renderRecords();
      });
    }
  }

function collectAttachmentOptions(records){
  const map=new Map();
  (Array.isArray(records)?records:[]).forEach(record=>{
    if(!record) return;
    const ts=getRecordTimestamp(record);
    const files=Array.isArray(record.attachments)?record.attachments:[];
    files.forEach(att=>{
      if(!att || typeof att!=="object" || Array.isArray(att)) return;
      const fileId=String(att.fileId||att.id||"").trim();
      if(!fileId || map.has(fileId)) return;
      map.set(fileId,{
        fileId,
        name:att.name||att.fileName||att.title||"æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«",
        recordDate:record.dateText||"",
        uploadedAt:att.uploadedAt||att.createdAt||att.timestamp||"",
        mimeType:att.mimeType||"",
        timestamp:ts||toTime(att.uploadedAt||att.createdAt||att.timestamp)
      });
    });
  });
  return Array.from(map.values()).sort((a,b)=>{
    const tb=Number.isFinite(b.timestamp)?b.timestamp:0;
    const ta=Number.isFinite(a.timestamp)?a.timestamp:0;
    if(tb!==ta) return tb-ta;
    return String(a.name||"").localeCompare(String(b.name||""),"ja");
  });
}

function updateShareAttachmentOptions(records){
  const container=document.getElementById("shareAttachments");
  if(!container) return;
  const data=collectAttachmentOptions(typeof records!=='undefined'?records:recordsCache);
  const shareAll=document.getElementById("shareAttachmentAll");
  if(!data.length){
    container.classList.add("muted");
    container.innerHTML='<div class="share-empty">å…±æœ‰ã§ãã‚‹æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
    if(shareAll) shareAll.checked=false;
    return;
  }
  container.classList.remove("muted");
  container.innerHTML=data.map(att=>{
    const detailParts=[];
    if(att.recordDate) detailParts.push(`è¨˜éŒ²æ—¥: ${escapeHtml(att.recordDate)}`);
    const uploadedLabel=att.uploadedAt?formatDateTime(att.uploadedAt):"";
    if(uploadedLabel) detailParts.push(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ${escapeHtml(uploadedLabel)}`);
    if(att.mimeType) detailParts.push(escapeHtml(att.mimeType));
    const detail=detailParts.length?`<span>${detailParts.join(' ï½œ ')}</span>`:"";
    return `<label class="share-attachment"><input type="checkbox" data-file-id="${escapeHtml(att.fileId)}"><div class="share-attachment-info"><strong>${escapeHtml(att.name||'æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«')}</strong>${detail}</div></label>`;
  }).join("\n");
  applyShareAllState();
}

function applyShareAllState(){
  const shareAll=document.getElementById("shareAttachmentAll");
  const container=document.getElementById("shareAttachments");
  if(!container) return;
  const checkboxes=container.querySelectorAll('input[type="checkbox"][data-file-id]');
  const disable=!!(shareAll && shareAll.checked);
  checkboxes.forEach(cb=>{
    cb.disabled=disable;
    if(disable) cb.checked=false;
  });
}

function applyShareExpiryPreset(){
  const preset=document.getElementById("shareExpiryPreset");
  const custom=document.getElementById("shareExpires");
  if(!preset || !custom) return;
  if(preset.value==="custom"){
    custom.style.display="";
    custom.disabled=false;
    if(!custom.value){
      const now=new Date();
      now.setDate(now.getDate()+7);
      custom.value=toLocalDateTimeInputValue(now);
    }
  }else{
    custom.style.display="none";
    custom.value="";
    custom.disabled=true;
  }
}

function setupShareUi(){
  const openBtn=document.getElementById("btnOpenShareForm");
  if(openBtn){
    openBtn.onclick=()=>toggleShareForm(true);
  }
  const cancelBtn=document.getElementById("btnCancelShare");
  if(cancelBtn){
    cancelBtn.onclick=()=>toggleShareForm(false);
  }
  const createBtn=document.getElementById("btnCreateShare");
  if(createBtn){
    createBtn.addEventListener("click",handleCreateShare);
  }
  const shareAll=document.getElementById("shareAttachmentAll");
  if(shareAll){
    shareAll.addEventListener("change",applyShareAllState);
  }
  const expiryPreset=document.getElementById("shareExpiryPreset");
  if(expiryPreset){
    expiryPreset.addEventListener("change",applyShareExpiryPreset);
  }
  const list=document.getElementById("shareList");
  if(list){
    list.addEventListener("click",handleShareListClick);
  }
  applyShareExpiryPreset();
}

function toggleShareForm(open){
  const form=document.getElementById("shareForm");
  if(!form) return;
  shareFormOpen=!!open;
  form.style.display=shareFormOpen?"":"none";
  const status=document.getElementById("shareFormStatus");
  if(status){
    status.textContent="";
    status.classList.add("muted");
  }
  if(shareFormOpen){
    updateShareAttachmentOptions(recordsCache);
    applyShareExpiryPreset();
  }else{
    const expires=document.getElementById("shareExpires");
    const password=document.getElementById("sharePassword");
    const mask=document.getElementById("shareMaskCheckbox");
    const shareAll=document.getElementById("shareAttachmentAll");
    const audience=document.getElementById("shareAudience");
    const preset=document.getElementById("shareExpiryPreset");
    const rangeSelect=document.getElementById("shareRange");
    if(expires) expires.value="";
    if(password) password.value="";
    if(mask) mask.checked=true;
    if(shareAll) shareAll.checked=false;
    if(audience) audience.value=shareAudienceDefault;
    if(preset) preset.value=shareExpiryPresetDefault;
    if(rangeSelect) rangeSelect.value=shareRangeDefault;
    applyShareAllState();
    applyShareExpiryPreset();
  }
}

function closeShareForm(){ toggleShareForm(false); }

function resetShareListPlaceholder(){
  const list=document.getElementById("shareList");
  if(!list) return;
  list.classList.add("muted");
  list.innerHTML="åˆ©ç”¨è€…ã‚’é¸æŠã™ã‚‹ã¨å…±æœ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
}

function fetchExternalShareList(){
  const list=document.getElementById("shareList");
  if(!memberId){
    externalShares=[];
    resetShareListPlaceholder();
    return;
  }
  if(list){
    list.classList.add("muted");
    list.innerHTML="å…±æœ‰ãƒªãƒ³ã‚¯ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦";
  }
  callGoogle("getExternalShares",memberId).then(res=>{
    if(!res || res.status!=="success"){
      if(list){
        const msg=res && res.message ? escapeHtml(res.message) : "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
        list.innerHTML=`ã‚¨ãƒ©ãƒ¼: ${msg}`;
      }
      return;
    }
    externalShares=Array.isArray(res.shares)?res.shares:[];
    renderShareList();
  }).catch(err=>{
    if(list){
      const msg=err && err.message ? err.message : String(err);
      list.innerHTML=`ã‚¨ãƒ©ãƒ¼: ${escapeHtml(msg)}`;
    }
  });
}

function renderShareList(){
  const list=document.getElementById("shareList");
  if(!list) return;
  if(!externalShares.length){
    list.classList.add("muted");
    list.innerHTML="å…±æœ‰ãƒªãƒ³ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“";
    return;
  }
  list.classList.remove("muted");
  list.innerHTML=externalShares.map(renderShareItem).join("\n");
}

function renderShareItem(share){
  const expired=!!share.expired;
  const itemClass=expired?"share-item expired":"share-item";
  const badgeLabel=expired?"æœŸé™åˆ‡ã‚Œ":"å…±æœ‰ä¸­";
  const info=getAudienceInfo(share.audience);
  const shareUrlRaw=share.url||"";
  const safeUrl=escapeHtml(shareUrlRaw);
  const expiresLabel=share.expiresAtText?`æœŸé™: ${escapeHtml(share.expiresAtText)}`:"æœŸé™: è¨­å®šãªã—";
  const attachmentsLabel=share.allowAllAttachments?"æ·»ä»˜: ã™ã¹ã¦å…±æœ‰":`æ·»ä»˜: ${share.allowedCount||0}ä»¶`;
  const passwordLabel=share.passwordProtected?"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚ã‚Š":"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—";
  const maskLabel=share.maskMode==='simple'?"æœ¬æ–‡ãƒã‚¹ã‚¯ã‚ã‚Š":"æœ¬æ–‡ãã®ã¾ã¾";
  const audienceLabel=`å…±æœ‰å…ˆ: ${escapeHtml(info.label)}`;
  const rangeLabel=share.rangeLabel?`å…±æœ‰ç¯„å›²: ${escapeHtml(share.rangeLabel)}`:"";
  const lastAccess=share.lastAccessText?`æœ€çµ‚é–²è¦§: ${escapeHtml(share.lastAccessText)}`:"";
  const remaining=share.remainingLabel?`æœ‰åŠ¹æœŸé–“: ${escapeHtml(share.remainingLabel)}`:"";
  const accessLabel=share.accessCount?`é–²è¦§å›æ•°: ${share.accessCount}å›`:"";
  const metaParts=[audienceLabel,expiresLabel,attachmentsLabel,passwordLabel,maskLabel,rangeLabel,remaining,lastAccess,accessLabel].filter(Boolean);
  const metaHtml=metaParts.map(p=>`<span>${p}</span>`).join("\n");
  const qrSrc=share.qrDriveUrl||share.qrDataUrl||share.qrUrl||"";
  const fallbackQr=!qrSrc && shareUrlRaw?`https://chart.googleapis.com/chart?cht=qr&chs=220x220&choe=UTF-8&chl=${encodeURIComponent(shareUrlRaw)}`:"";
  const qrUrl=qrSrc||fallbackQr;
  const qrHtml=qrUrl?`<div class="share-qr"><img src="${qrUrl}" alt="å…±æœ‰QRã‚³ãƒ¼ãƒ‰"></div>`:"";
  const descriptionHtml=info.description?`<div class="share-meta-notes">${escapeHtml(info.description)}</div>`:"";
  return `<div class="${itemClass}">`
    + `<div class="share-item-header"><span class="badge">${badgeLabel}</span>`
    + `<div class="share-url"><input type="text" readonly value="${safeUrl}" onclick="this.select();">`
    + `<button class="secondary btn-compact" data-action="copy-url" data-url="${safeUrl}">URLã‚³ãƒ”ãƒ¼</button>`
    + `</div></div>`
    + `<div class="tag-group">${metaHtml}</div>`
    + descriptionHtml
    + qrHtml
    + `<div class="share-actions">`
    + `<button class="danger btn-compact" data-action="revoke" data-token="${escapeHtml(share.token||'')}">ãƒªãƒ³ã‚¯åœæ­¢</button>`
    + `</div>`
    + `</div>`;
}

async function handleShareListClick(event){
  const btn=event.target.closest('[data-action]');
  if(!btn) return;
  const action=btn.dataset.action;
  if(action==='copy-url'){
    const url=btn.dataset.url||"";
    if(!url) return;
    const ok=await copyToClipboard(url);
    if(ok){
      const original=btn.textContent;
      btn.textContent="ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
      setTimeout(()=>{ btn.textContent=original||"URLã‚³ãƒ”ãƒ¼"; },1800);
    }else{
      alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }
    return;
  }
  if(action==='revoke'){
    const token=btn.dataset.token||"";
    if(!token) return;
    if(!confirm("ã“ã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const status=document.getElementById("shareList");
    if(status) status.classList.add("muted");
    try {
      const res=await callGoogle("revokeExternalShare", token);
      if(!res || res.status!=="success"){
        const msg=res && res.message ? res.message : "åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ";
        alert(msg);
      }
    } catch(err){
      alert(err && err.message ? err.message : "å…±æœ‰ãƒªãƒ³ã‚¯ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
    fetchExternalShareList();
  }
}

async function handleCreateShare(event){
  console.log("ğŸ” DEBUG before handleCreateShare: memberId=", memberId, "memberName=", memberName);

  console.log("ğŸ” handleCreateShare start", { memberId, config: collectShareFormConfig() });
  if(event) event.preventDefault();
  if(!memberId){ 
    alert("åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"); 
    return; 
  }

  const status = document.getElementById("shareFormStatus");
  if(status) status.textContent = "å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œã—ã¦ã„ã¾ã™â€¦";

  try {
    const config = collectShareFormConfig();
    const res = await callGoogle("createExternalShare", memberId, config);
    
    console.log("ğŸ“¥ res from createExternalShare", res);
    console.log("ğŸ” debug: qrDriveUrl =", res.qrDriveUrl);
    console.log("ğŸ” debug: qrViewUrl  =", res.qrViewUrl);
    console.log("ğŸ” debug: url/shareLink =", res.url, res.shareLink);

    if(!res || res.status !== "success"){
      const msg = res && res.message ? res.message : "å…±æœ‰ãƒªãƒ³ã‚¯ã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ";
      throw new Error(msg);
    }

  if(status){
  const qrUrl   = res.qrDriveUrl || res.qrDataUrl || res.qrUrl || "";
  const shareUrl = res.url || res.shareLink || "";
  
  // â† escapeHtmlã‚’ä½¿ã‚ãšã«ãã®ã¾ã¾URLã‚’åŸ‹ã‚è¾¼ã‚€
  const qrHtml = qrUrl
    ? `<div class="share-qr-preview">
         <img src="${qrUrl}" alt="å…±æœ‰QRã‚³ãƒ¼ãƒ‰" style="width:120px;height:120px;display:block;border:1px solid red;background:white;">
         <div class="share-qr-preview-info">
           <div>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§èª­ã¿å–ã‚‹ã¨å…±æœ‰ãƒšãƒ¼ã‚¸ã‚’é–‹ã‘ã¾ã™ã€‚</div>
           ${shareUrl ? `<div class="share-qr-preview-url">${shareUrl}</div>` : ""}
         </div>
       </div>`
    : "<div class='warn'>âš ï¸ QRã‚³ãƒ¼ãƒ‰URLãŒè¿”ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸ</div>";

  status.classList.remove("muted");
  status.innerHTML = `<div>å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œã—ã¾ã—ãŸã€‚ãƒªã‚¹ãƒˆã‹ã‚‰URLã‚³ãƒ”ãƒ¼ã‚„QRå°åˆ·ãŒã§ãã¾ã™ã€‚</div>${qrHtml}`;
  console.log("ğŸ–¼ï¸ final status.innerHTML =", status.innerHTML);
}

    fetchExternalShareList();

  } catch(err){
    console.error("âŒ handleCreateShare error", err);
    if(status) status.textContent = "å¤±æ•—: " + (err && err.message ? err.message : err);
  }
}

function collectShareFormConfig(){
  const audienceSelect=document.getElementById("shareAudience");
  const presetSelect=document.getElementById("shareExpiryPreset");
  const expires=document.getElementById("shareExpires");
  const password=document.getElementById("sharePassword");
  const mask=document.getElementById("shareMaskCheckbox");
  const shareAll=document.getElementById("shareAttachmentAll");
  const attachmentsContainer=document.getElementById("shareAttachments");
  const rangeSelect=document.getElementById("shareRange");
  const allowed=[];
  if(shareAll && shareAll.checked){
    allowed.push("__ALL__");
  }else if(attachmentsContainer){
    attachmentsContainer.querySelectorAll('input[type="checkbox"][data-file-id]').forEach(cb=>{
      if(cb.checked) allowed.push(cb.dataset.fileId);
    });
  }
  const audience=(audienceSelect && audienceSelect.value) ? audienceSelect.value : shareAudienceDefault;
  const preset=(presetSelect && presetSelect.value) ? presetSelect.value : shareExpiryPresetDefault;
  const rangeValue=(rangeSelect && rangeSelect.value) ? rangeSelect.value : shareRangeDefault;
  const config={
    audience,
    password: password ? password.value.trim() : "",
    maskMode: mask && mask.checked ? "simple" : "none",
    allowedAttachmentIds: allowed,
    rangeSpec: rangeValue
  };
  if(preset === "custom"){
    if(!expires || !expires.value){
      throw new Error("å…±æœ‰æœŸé™ã®æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    }
    const iso=convertLocalDateTimeToIso(expires.value);
    if(!iso){
      throw new Error("å…±æœ‰æœŸé™ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
    config.expiresAt=iso;
  }else if(preset === "none"){
    // ç„¡æœŸé™ã®å ´åˆã¯expiresAt/expiresInDaysã‚’è¨­å®šã—ãªã„
  }else{
    const days=Number(preset);
    if(!Number.isFinite(days) || days <= 0){
      throw new Error("å…±æœ‰æœŸé™ã®é¸æŠè‚¢ãŒä¸æ­£ã§ã™ã€‚");
    }
    config.expiresInDays=days;
  }
  return config;
}

function convertLocalDateTimeToIso(value){
  if(!value) return "";
  const m=value.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
  if(!m) return "";
  const date=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), Number(m[4]), Number(m[5]));
  if(Number.isNaN(date.getTime())) return "";
  return date.toISOString();
}

function toLocalDateTimeInputValue(date){
  if(!(date instanceof Date) || Number.isNaN(date.getTime())) return "";
  const pad=n=>String(n).padStart(2,"0");
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

function copyToClipboard(text){
  if(!text) return Promise.resolve(false);
  if(navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text).then(()=>true).catch(()=>fallbackCopy(text));
  }
  return fallbackCopy(text);
}

function fallbackCopy(text){
  try {
    const textarea=document.createElement("textarea");
    textarea.value=text;
    textarea.style.position="fixed";
    textarea.style.opacity="0";
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    const ok=document.execCommand("copy");
    document.body.removeChild(textarea);
    return Promise.resolve(ok);
  } catch(_err){
    return Promise.resolve(false);
  }
}

function initInternalApp(){
  document.body.classList.remove("external-mode");
  setupMemberUi();
  setupFilters();
  setupShareUi();
  resetShareListPlaceholder();
  loadDashboard();
}

function runAfterDomReady(fn){
  if(document.readyState === "loading"){
    window.addEventListener("DOMContentLoaded", fn);
  }else{
    fn();
  }
}

runAfterDomReady(()=>{
  refreshMemberList();
  setupSearchBox();
  initInternalApp();
});

document.addEventListener("DOMContentLoaded", () => {
    const audience = document.getElementById("shareAudience");
    const expiry   = document.getElementById("shareExpiryPreset");
    const range    = document.getElementById("shareRange");

    if (audience) audience.value = "center";
    if (expiry)   expiry.value   = "10";
    if (range)    range.value    = "90";
  });

document.getElementById("btnOpenShareForm")?.addEventListener("click", () => {
    const audience = document.getElementById("shareAudience");
    const expiry   = document.getElementById("shareExpiryPreset");
    const range    = document.getElementById("shareRange");

    if (audience) audience.value = "center";
    if (expiry)   expiry.value   = "10";
    if (range)    range.value    = "90";
  });

function loadMemberCenterInfo(targetMemberId) {
  const safeId = normalizeMemberIdForLookup(targetMemberId || getCurrentMemberIdForCenter());
  if (!safeId) {
    updateCenterFormValues("", "");
    return;
  }
  google.script.run
    .withSuccessHandler(res => {
      if (res && res.ok) {
        updateCenterFormValues(res.center || "", res.staff || "");
      } else if (res && res.ok === false) {
        updateCenterFormValues("", "");
      }
    })
    .withFailureHandler(err => {
      console.error("[member] loadMemberCenterInfo failed", err);
    })
    .getMemberCenterInfo(safeId);
}
google.script.run
  .withSuccessHandler(res => {
    console.log("Driveã«ä¿å­˜ã•ã‚ŒãŸQR:", res);
    if (res.embedUrl) {
      document.getElementById("qrPreview").innerHTML =
        `<img src="${res.embedUrl}" style="width:120px;height:120px;">`;
    }
  })
  .saveQrCodeToDrive_(memberId, shareUrl);

</script>
</body>
</html>
